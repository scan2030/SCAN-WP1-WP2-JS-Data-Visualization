<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Incidence and Incidence Rate</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/css/lightbox.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/js/lightbox-plus-jquery.min.js"></script>
<style>
        body {
            font-family: Arial, sans-serif;
        }
        .tab {
            visibility: hidden;
            height: 0;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        .tab.active {
            visibility: visible;
            height: auto;
            opacity: 1;
        }
        .tab-button {
            padding: 10px;
            cursor: pointer;
            background-color: #f1f1f1;
            border: none;
            border-bottom: 2px solid transparent;
        }
        .tab-button.active {
            border-bottom: 2px solid blue;
            background-color: #e7e7e7;
        }
        #chart-container {
            width: 80%;
            margin: auto;
        }
        .button-container {
            text-align: center;
            margin: 20px;
        }
        button {
            margin: 5px;
        }
        button.active {
            background-color: #d3d3d3;
        }
        canvas {
            max-width: 800px;
            height:  400px;
            margin: auto;
        }
        .chart-wrapper {
            max-width: 800px;
            margin: 0 auto;
        }

        #kmChart {
            width: 800px;
            height: 400px;
            margin: auto;
            display: block;
        }
        #sankeyContainer {
            text-align: center;
            margin: 20px;
        }
        iframe {
            width: 100%;
            height: 600px; /* Adjust height as needed */
            border: none; /* Remove border */
        }
        
        /* Custom legend styles */
        .custom-legend {
            display: flex;
            flex-direction: column;
            justify-content: center;
            margin: 10px auto;
            max-width: 800px;
        }

        
        .legend-text {
            font-family: Arial, sans-serif; /* Change font family */
            font-size: 12px;               /* Change font size */
            font-weight: 530;              /* Control font weight (normal=400, bold=700) */
            color: #545151;                /* Change text color */
        }

        
        .legend-row {
            display: flex;
            justify-content: center;
            margin: 5px 0;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 0 10px;
            cursor: pointer;
        }
        
        .legend-item.hidden span.legend-text {
            text-decoration: line-through;
        }
        
        .legend-item.hidden .legend-color {
            opacity: 0.5;
        }
        
        .legend-color {
            display: inline-block;
            width: 15px;
            height: 15px;
            margin-right: 5px;
            border-radius: 2px;
        }
        
        .legend-dash {
            border-top-style: dashed;
            border-top-width: 2px;
        }
    </style>
</head>
<body>
<h2>Data Visualizaition of SCAN2030 WP1</h2>
<div>
    <button class="tab-button active" onclick="openTab(event, 'incidence')">Incidence</button>
    <button class="tab-button" onclick="openTab(event, 'prevalence')">Prevalence</button>
    <button class="tab-button" onclick="openTab(event, 'chart-container')">Cost</button>
    <button class="tab-button" onclick="openTab(event, 'cohortData')">Unmet Needs</button>
    <button class="tab-button" onclick="openTab(event, 'kmChartContainer')">Survival Probability</button>
    <!--<button class="tab-button" onclick="openTab(event, 'sankeyContainer')">Treatment Pathway </button>-->

</div>

<div id="incidence" class="tab active">
    <h2>Prostate Cancer Incidence</h2>
    <div class="button-container">
        <button class="active" onclick="toggleChart('incidence', event)">Incidence Chart</button>
        <button onclick="toggleChart('rate', event)">Incidence Rate Chart</button>
    </div>
    <div id="incidenceChartContainer" class="chart-wrapper">
        <div id="incidenceLegend" class="custom-legend"></div>
        <canvas id="incidenceChart"></canvas>
    </div>
    <div id="rateChartContainer" class="chart-wrapper" >
        <div id="rateLegend" class="custom-legend"></div>
        <canvas id="rateChart"></canvas>
    </div>
</div>

<div id="prevalence" class="tab">
    <h2>Prostate Cancer Prevalence</h2>
    <div class="button-container">
        <button class="active" onclick="togglePrevalence('number', event)">Prevalent Number</button>
        <button onclick="togglePrevalence('rate', event)">Prevalence Rate</button>
    </div>
    <div id="prevalenceNumberChartContainer" class="chart-wrapper">
        <div id="prevalenceNumberLegend" class="custom-legend"></div>
        <canvas id="prevalenceNumberChart"></canvas>
    </div>
    <div id="prevalenceRateChartContainer" class="chart-wrapper" >
        <div id="prevalenceRateLegend" class="custom-legend"></div>
        <canvas id="prevalenceRateChart"></canvas>
    </div>
</div>

<div id="chart-container" class="tab">
    <h2>One-year costs of care under Hospital Authority among prevalant patients</h2>
    <canvas id="myChart"></canvas>
    <!-- <div class="button-container">
        <button onclick="toggleData('ae')">Toggle AE Cost</button>
        <button onclick="toggleData('ip')">Toggle IP Cost</button>
        <button onclick="toggleData('op')">Toggle OP Cost</button>
    </div> -->
</div>

<div id="cohortData" class="tab">
    <h2>Proportion of CRPC and Metastatic Patients Not Treated by NHA/docetaxel in 180 Days in Each Year</h2>
    <canvas id="treatedPatientsChart"></canvas>
</div>

<div id="kmChartContainer" class="tab">
    <h2>Kaplan-Meier Survival Curves for Incident Cohort (2014 - 2022)</h2>
    <div class="controls">
        <!-- <div class="checkboxes">
            <label><input type="checkbox" value="cohort_2014" checked> Cohort 2014</label>
            <label><input type="checkbox" value="cohort_2015" checked> Cohort 2015</label>
            <label><input type="checkbox" value="cohort_2016" checked> Cohort 2016</label>
            <label><input type="checkbox" value="cohort_2017" checked> Cohort 2017</label>
            <label><input type="checkbox" value="cohort_2018" checked> Cohort 2018</label>
            <label><input type="checkbox" value="cohort_2019" checked> Cohort 2019</label>
            <label><input type="checkbox" value="cohort_2020" checked> Cohort 2020</label>
            <label><input type="checkbox" value="cohort_2021" checked> Cohort 2021</label>
            <label><input type="checkbox" value="cohort_2022" checked> Cohort 2022</label>
        </div>
        <button id="zoomButton">Zoom to 100%-90% Survival</button>
        <button id="resetButton">Reset Zoom</button>-->
    </div>
    <svg id="chart" width="800" height="400"></svg>
</div>

<!--<div id="sankeyContainer" class="tab">
  <h2>Treatment Pathway of 2000 - 2022 cohort</h2>
  <iframe src="Sankey Plot.html" title="Embedded HTML"></iframe>
</div>-->

<script>
let myChart;
let incidenceChartObj;
let rateChartObj;
let AE_cost = [];
let IP_cost = [];
let OP_cost = [];
let prevalenceNumberChart;
let prevalenceRateChart;
let years = [];
let num_unique_prev = [];
let num_less75_patient_prev = [];
let num_75plus_patient_prev = [];
let Age_Standardized_Prevalence = [];
let age_standardized_prev_less75 = [];
let age_standardized_prev_75plus = [];

// Historical incidence data
let num_inci = []; 
let num_less75_inci = [];
let num_75plus_inci = [];
let incidence_rate = [];
let less75_incidence_rate = [];
let plus75_incidence_rate = [];

// Forecast data
let forecastYears = [];
let num_inci_forecast = [];
let less75_inci_forecast = [];
let plus75_inci_forecast = [];
let incidence_rate_forecast = [];
let less75_incidence_rate_forecast = [];
let plus75_incidence_rate_forecast = [];

// Prediction intervals
let num_inci_lower = [];
let num_inci_upper = [];
let less75_inci_lower = [];
let less75_inci_upper = [];
let plus75_inci_lower = [];
let plus75_inci_upper = [];
let incidence_rate_lower = [];
let incidence_rate_upper = [];
let less75_incidence_rate_lower = [];
let less75_incidence_rate_upper = [];
let plus75_incidence_rate_lower = [];
let plus75_incidence_rate_upper = [];

// Prevalence forecast data variables
let prevForecastYears = [];
let totalPrevForecast = [];
let less75PrevForecast = [];
let plus75PrevForecast = [];
let totalPrevRateForecast = [];
let less75PrevRateForecast = [];
let plus75PrevRateForecast = [];

// Prevalence prediction intervals
let totalPrevLower = [];
let totalPrevUpper = [];
let less75PrevLower = [];
let less75PrevUpper = [];
let plus75PrevLower = [];
let plus75PrevUpper = [];
let totalPrevRateLower = [];
let totalPrevRateUpper = [];
let less75PrevRateLower = [];
let less75PrevRateUpper = [];
let plus75PrevRateLower = [];
let plus75PrevRateUpper = [];

let lastHistoricalYear = 0;
let combinedYears = [];

// Variables to track visibility of forecast series - all default to false
let forecastVisible = {
    total: false,
    less75: false,
    plus75: false
};

// Similar tracker for prevalence forecast visibility
let prevForecastVisible = {
    total: false,
    less75: false,
    plus75: false
};

function openTab(evt, tabName) {
    const tabs = document.getElementsByClassName("tab");
    const buttons = document.getElementsByClassName("tab-button");

    for (let i = 0; i < tabs.length; i++) {
        tabs[i].classList.remove('active');
    }
    for (let i = 0; i < buttons.length; i++) {
        buttons[i].classList.remove("active");
    }

    document.getElementById(tabName).classList.add('active');
    evt.currentTarget.classList.add("active");
}

function toggleChart(type, evt) {
    const incidenceChartContainer = document.getElementById('incidenceChartContainer');
    const rateChartContainer = document.getElementById('rateChartContainer');

    if (type === 'incidence') {
        incidenceChartContainer.style.display = 'block';
        rateChartContainer.style.display = 'none';
    } else {
        incidenceChartContainer.style.display = 'none';
        rateChartContainer.style.display = 'block';
    }

    // Set the active button
    if (evt) {
        const buttons = document.querySelectorAll('#incidence .button-container button');
        buttons.forEach(button => {
            button.classList.remove('active');
        });
        evt.currentTarget.classList.add('active');
    } else {
        // If called programmatically, activate the first button for incidence
        const buttons = document.querySelectorAll('#incidence .button-container button');
        buttons.forEach((button, index) => {
            if ((type === 'incidence' && index === 0) || (type === 'rate' && index === 1)) {
                button.classList.add('active');
            } else {
                button.classList.remove('active');
            }
        });
    }
}

function togglePrevalence(type, evt) {
    const prevalenceNumberChartContainer = document.getElementById('prevalenceNumberChartContainer');
    const prevalenceRateChartContainer = document.getElementById('prevalenceRateChartContainer');

    if (type === 'number') {
        prevalenceNumberChartContainer.style.display = 'block';
        prevalenceRateChartContainer.style.display = 'none';
    } else {
        prevalenceNumberChartContainer.style.display = 'none';
        prevalenceRateChartContainer.style.display = 'block';
    }

    // Set the active button
    if (evt) {
        const buttons = document.querySelectorAll('#prevalence .button-container button');
        buttons.forEach(button => {
            button.classList.remove('active');
        });
        evt.currentTarget.classList.add('active');
    } else {
        // If called programmatically, activate the first button for number
        const buttons = document.querySelectorAll('#prevalence .button-container button');
        buttons.forEach((button, index) => {
            if ((type === 'number' && index === 0) || (type === 'rate' && index === 1)) {
                button.classList.add('active');
            } else {
                button.classList.remove('active');
            }
        });
    }
}

function adjustChartAxis(chart) {
    // Check if all forecast series are hidden
    const allForecastHidden = !forecastVisible.total && !forecastVisible.less75 && !forecastVisible.plus75;

    if (allForecastHidden) {
        // Set x-axis max to only show historical years (up to 2022)
        chart.options.scales.x.max = years.length - 1;
    } else {
        // Show full range including forecast years
        chart.options.scales.x.max = undefined;
    }
    
    chart.update();
}

function adjustPrevalenceChartAxis(chart) {
    // Check if all forecast series are hidden
    const allForecastHidden = !prevForecastVisible.total && !prevForecastVisible.less75 && !prevForecastVisible.plus75;

    if (allForecastHidden) {
        // Set x-axis max to only show historical years (up to 2022)
        chart.options.scales.x.max = years.length - 1;
    } else {
        // Show full range including forecast years
        chart.options.scales.x.max = undefined;
    }
    
    chart.update();
}

// Function to create a custom HTML legend
function createCustomLegend(chart, legendElementId, isRate = false) {
    const legendElement = document.getElementById(legendElementId);
    legendElement.innerHTML = '';
    
    // Create first row for historical data
    const historicalRow = document.createElement('div');
    historicalRow.className = 'legend-row';
    
    // Create second row for forecast data
    const forecastRow = document.createElement('div');
    forecastRow.className = 'legend-row';
    
    // Historical data items
    const historicalItems = [
        {
            label: 'Total',
            color: '#fb8500',
            datasetIndex: 0,
            dash: false
        },
        {
            label: 'Less than 75',
            color: '#023047',
            datasetIndex: 1,
            dash: false
        },
        {
            label: '75+',
            color: '#8ecae6',
            datasetIndex: 2,
            dash: false
        }
    ];
    
    // Forecast data items
    const forecastItems = [
        {
            label: 'Total (Forecast)',
            color: '#ff0000',
            datasetIndex: isRate ? 4 : 4,
            dash: true
        },
        {
            label: 'Less than 75 (Forecast)',
            color: '#0000ff',
            datasetIndex: isRate ? 7 : 7,
            dash: true
        },
        {
            label: '75+ (Forecast)',
            color: '#ff69b4',
            datasetIndex: isRate ? 10 : 10, 
            dash: true
        }
    ];
    
    // Add historical items to the first row
    historicalItems.forEach(item => {
        const legendItem = document.createElement('div');
        legendItem.className = 'legend-item';
        legendItem.dataset.index = item.datasetIndex;
        
        const meta = chart.getDatasetMeta(item.datasetIndex);
        if (meta.hidden) {
            legendItem.classList.add('hidden');
        }
        
        const colorSpan = document.createElement('span');
        colorSpan.className = 'legend-color';
        colorSpan.style.backgroundColor = item.color;
        if (item.dash) {
            colorSpan.classList.add('legend-dash');
            colorSpan.style.borderTopColor = item.color;
        }
        
        const textSpan = document.createElement('span');
        textSpan.className = 'legend-text';
        textSpan.textContent = item.label;
        
        legendItem.appendChild(colorSpan);
        legendItem.appendChild(textSpan);
        
        // Add click event handler
        legendItem.addEventListener('click', () => {
            const index = parseInt(legendItem.dataset.index);
            const meta = chart.getDatasetMeta(index);
            
            // Toggle visibility
            meta.hidden = !meta.hidden;
            
            // Update class to reflect hidden state
            if (meta.hidden) {
                legendItem.classList.add('hidden');
            } else {
                legendItem.classList.remove('hidden');
            }
            
            // Update chart
            chart.update();
        });
        
        historicalRow.appendChild(legendItem);
    });
    
    // Add forecast items to the second row
    forecastItems.forEach(item => {
        const legendItem = document.createElement('div');
        legendItem.className = 'legend-item';
        // Always add the 'hidden' class initially for forecast items
        legendItem.classList.add('hidden');
        legendItem.dataset.index = item.datasetIndex;
        
        const colorSpan = document.createElement('span');
        colorSpan.className = 'legend-color';
        colorSpan.style.backgroundColor = item.color;
        if (item.dash) {
            colorSpan.classList.add('legend-dash');
            colorSpan.style.borderTopColor = item.color;
        }
        
        const textSpan = document.createElement('span');
        textSpan.className = 'legend-text';
        textSpan.textContent = item.label;
        
        legendItem.appendChild(colorSpan);
        legendItem.appendChild(textSpan);
        
        // Add click event handler for forecast items
        legendItem.addEventListener('click', () => {
            const index = parseInt(legendItem.dataset.index);
            const meta = chart.getDatasetMeta(index);
            
            // Check if the legend item has the 'hidden' class (i.e., it's currently showing as strikethrough)
            const isCurrentlyHidden = legendItem.classList.contains('hidden');
            
            // Update the dataset visibility based on the current visual state
            meta.hidden = !isCurrentlyHidden;
            
            // Update class to reflect the new state
            if (isCurrentlyHidden) {
                // If it was hidden (strikethrough), remove that class to show it
                legendItem.classList.remove('hidden');
            } else {
                // If it was showing, add the hidden class to hide it
                legendItem.classList.add('hidden');
            }
            
            // Track forecast visibility directly based on the new visual state
            const label = chart.data.datasets[index].label;
            
            if (label === 'Total (Forecast)') {
                if (legendElementId.includes('prevalence')) {
                    prevForecastVisible.total = isCurrentlyHidden; // True if we're making it visible
                    
                    // Also toggle prediction intervals to match
                    const lowerIndex = isRate ? 3 : 3;
                    const upperIndex = isRate ? 5 : 5;
                    
                    chart.getDatasetMeta(lowerIndex).hidden = !isCurrentlyHidden;
                    chart.getDatasetMeta(upperIndex).hidden = !isCurrentlyHidden;
                } else {
                    forecastVisible.total = isCurrentlyHidden; // True if we're making it visible
                    
                    // Also toggle prediction intervals to match
                    const lowerIndex = isRate ? 3 : 3;
                    const upperIndex = isRate ? 5 : 5;
                    
                    chart.getDatasetMeta(lowerIndex).hidden = !isCurrentlyHidden;
                    chart.getDatasetMeta(upperIndex).hidden = !isCurrentlyHidden;
                }
            } else if (label === 'Less than 75 (Forecast)') {
                if (legendElementId.includes('prevalence')) {
                    prevForecastVisible.less75 = isCurrentlyHidden;
                    
                    // Also toggle prediction intervals
                    const lowerIndex = isRate ? 6 : 6;
                    const upperIndex = isRate ? 8 : 8;
                    
                    chart.getDatasetMeta(lowerIndex).hidden = !isCurrentlyHidden;
                    chart.getDatasetMeta(upperIndex).hidden = !isCurrentlyHidden;
                } else {
                    forecastVisible.less75 = isCurrentlyHidden;
                    
                    // Also toggle prediction intervals
                    const lowerIndex = isRate ? 6 : 6;
                    const upperIndex = isRate ? 8 : 8;
                    
                    chart.getDatasetMeta(lowerIndex).hidden = !isCurrentlyHidden;
                    chart.getDatasetMeta(upperIndex).hidden = !isCurrentlyHidden;
                }
            } else if (label === '75+ (Forecast)') {
                if (legendElementId.includes('prevalence')) {
                    prevForecastVisible.plus75 = isCurrentlyHidden;
                    
                    // Also toggle prediction intervals
                    const lowerIndex = isRate ? 9 : 9;
                    const upperIndex = isRate ? 11 : 11;
                    
                    chart.getDatasetMeta(lowerIndex).hidden = !isCurrentlyHidden;
                    chart.getDatasetMeta(upperIndex).hidden = !isCurrentlyHidden;
                } else {
                    forecastVisible.plus75 = isCurrentlyHidden;
                    
                    // Also toggle prediction intervals
                    const lowerIndex = isRate ? 9 : 9;
                    const upperIndex = isRate ? 11 : 11;
                    
                    chart.getDatasetMeta(lowerIndex).hidden = !isCurrentlyHidden;
                    chart.getDatasetMeta(upperIndex).hidden = !isCurrentlyHidden;
                }
            }
            
            // Update chart
            chart.update();
            
            // Adjust x-axis if needed
            if (legendElementId.includes('prevalence')) {
                adjustPrevalenceChartAxis(chart);
            } else {
                adjustChartAxis(chart);
            }
        });
        
        forecastRow.appendChild(legendItem);
    });
    
    // Add rows to legend element
    legendElement.appendChild(historicalRow);
    legendElement.appendChild(forecastRow);
}

function updateIncidenceCharts() {
    // Get chart contexts
    const ctx1 = document.getElementById('incidenceChart').getContext('2d');
    const ctx2 = document.getElementById('rateChart').getContext('2d');
    
    // Create combined data arrays
    const totalCasesData = [];
    const less75CasesData = [];
    const plus75CasesData = [];
    
    const totalCasesForecastData = [];
    const less75CasesForecastData = []; 
    const plus75CasesForecastData = [];
    
    // Prepare data for prediction intervals
    const totalCasesLowerData = [];
    const totalCasesUpperData = [];
    const less75CasesLowerData = [];
    const less75CasesUpperData = [];
    const plus75CasesLowerData = [];
    const plus75CasesUpperData = [];
    
    // Fill historical data arrays
    for (let i = 0; i < years.length; i++) {
        totalCasesData.push(num_inci[i]);
        less75CasesData.push(num_less75_inci[i]);
        plus75CasesData.push(num_75plus_inci[i]);
        
        // Add null placeholders for forecast in historical period
        if (i < years.length - 1) { // All except last point (2022)
            totalCasesForecastData.push(null);
            less75CasesForecastData.push(null);
            plus75CasesForecastData.push(null);
            
            totalCasesLowerData.push(null);
            totalCasesUpperData.push(null);
            less75CasesLowerData.push(null);
            less75CasesUpperData.push(null);
            plus75CasesLowerData.push(null);
            plus75CasesUpperData.push(null);
        } else { // 2022 point (shared between historical and forecast)
            totalCasesForecastData.push(num_inci_forecast[0]);
            less75CasesForecastData.push(less75_inci_forecast[0]);
            plus75CasesForecastData.push(plus75_inci_forecast[0]);
            
            totalCasesLowerData.push(num_inci_lower[0]);
            totalCasesUpperData.push(num_inci_upper[0]);
            less75CasesLowerData.push(less75_inci_lower[0]);
            less75CasesUpperData.push(less75_inci_upper[0]);
            plus75CasesLowerData.push(plus75_inci_lower[0]);
            plus75CasesUpperData.push(plus75_inci_upper[0]);
        }
    }
    
    // Add forecast data for 2023-2032
    for (let i = 1; i < forecastYears.length; i++) { // Skip first (2022)
        // Add null placeholders for historical in forecast period
        totalCasesData.push(null);
        less75CasesData.push(null);
        plus75CasesData.push(null);
        
        // Add forecast data points
        totalCasesForecastData.push(num_inci_forecast[i]);
        less75CasesForecastData.push(less75_inci_forecast[i]);
        plus75CasesForecastData.push(plus75_inci_forecast[i]);
        
        // Add prediction intervals
        totalCasesLowerData.push(num_inci_lower[i]);
        totalCasesUpperData.push(num_inci_upper[i]);
        less75CasesLowerData.push(less75_inci_lower[i]);
        less75CasesUpperData.push(less75_inci_upper[i]);
        plus75CasesLowerData.push(plus75_inci_lower[i]);
        plus75CasesUpperData.push(plus75_inci_upper[i]);
    }
    
    // Create combined years array
    const allYears = [...years]; // Start with historical years
    
    // Add forecast years (excluding the first which is already included)
    for (let i = 1; i < forecastYears.length; i++) {
        allYears.push(forecastYears[i]);
    }
    
    // Clean up any existing charts
    if (incidenceChartObj) {
        incidenceChartObj.destroy();
    }
    
    // Create new incidence chart
    incidenceChartObj = new Chart(ctx1, {
        type: 'line',
        data: {
            labels: allYears,
            datasets: [
                // Total Cases - Historical
                {
                    label: 'Total',
                    data: totalCasesData,
                    borderColor: '#fb8500',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 3,
                    pointBackgroundColor: '#fb8500'
                },
                // Less than 75 Cases - Historical
                {
                    label: 'Less than 75)',
                    data: less75CasesData,
                    borderColor: '#023047',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 3,
                    pointBackgroundColor: '#023047'
                },
                // 75+ Cases - Historical
                {
                    label: '75+',
                    data: plus75CasesData,
                    borderColor: '#8ecae6',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 3,
                    pointBackgroundColor: '#8ecae6'
                },
                // Total Cases - Lower Confidence Interval
                {
                    label: 'Total Lower PI',
                    data: totalCasesLowerData,
                    borderColor: 'rgba(255, 0, 0, 0.2)',
                    backgroundColor: 'rgba(255, 0, 0, 0.2)',
                    fill: '+2', // Fill to dataset with index +2 (the upper interval)
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 0,
                    hidden: true // Start hidden
                },
                // Total Cases - Forecast
                {
                    label: 'Total (Forecast)',
                    data: totalCasesForecastData,
                    borderColor: '#ff0000', 
                    fill: false,
                    tension: 0.1,
                    borderDash: [5, 5],
                    pointRadius: 3,
                    pointBackgroundColor: '#ff0000',
                    hidden: true // Start hidden
                },
                // Total Cases - Upper Confidence Interval
                {
                    label: 'Total Upper PI',
                    data: totalCasesUpperData,
                    borderColor: 'rgba(255, 0, 0, 0)',
                    backgroundColor: 'rgba(255, 0, 0, 0)',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 0,
                    hidden: true // Start hidden
                },
                // Less than 75 Cases - Lower Confidence Interval
                {
                    label: 'Less than 75 Lower PI',
                    data: less75CasesLowerData,
                    borderColor: 'rgba(0, 0, 255, 0.2)',
                    backgroundColor: 'rgba(0, 0, 255, 0.2)',
                    fill: '+2', // Fill to dataset with index +2 (the upper interval)
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 0,
                    hidden: true // Start hidden
                },
                // Less than 75 Cases - Forecast
                {
                    label: 'Less than 75 (Forecast)',
                    data: less75CasesForecastData,
                    borderColor: '#0000ff',
                    fill: false,
                    tension: 0.1,
                    borderDash: [5, 5],
                    pointRadius: 3,
                    pointBackgroundColor: '#0000ff',
                    hidden: true // Start hidden
                },
                // Less than 75 Cases - Upper Confidence Interval
                {
                    label: 'Less than 75 Upper PI',
                    data: less75CasesUpperData,
                    borderColor: 'rgba(0, 0, 255, 0)',
                    backgroundColor: 'rgba(0, 0, 255, 0)',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 0,
                    hidden: true // Start hidden
                },
                // 75+ Cases - Lower Confidence Interval
                {
                    label: '75+ Lower PI',
                    data: plus75CasesLowerData,
                    borderColor: 'rgba(255, 105, 180, 0.2)',
                    backgroundColor: 'rgba(255, 105, 180, 0.2)',
                    fill: '+2', // Fill to dataset with index +2 (the upper interval)
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 0,
                    hidden: true // Start hidden
                },
                // 75+ Cases - Forecast
                {
                    label: '75+ (Forecast)',
                    data: plus75CasesForecastData,
                    borderColor: '#ff69b4',
                    fill: false,
                    tension: 0.1,
                    borderDash: [5, 5],
                    pointRadius: 3,
                    pointBackgroundColor: '#ff69b4',
                    hidden: true // Start hidden
                },
                // 75+ Cases - Upper Confidence Interval
                {
                    label: '75+ Upper PI',
                    data: plus75CasesUpperData,
                    borderColor: 'rgba(255, 105, 180, 0)',
                    backgroundColor: 'rgba(255, 105, 180, 0)',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 0,
                    hidden: true // Start hidden
                }
            ]
        },
        options: {
            plugins: {
                legend: {
                    display: false // Disable built-in legend
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.dataset.label || '';
                            if (label.includes('PI')) return null;
                            
                            const value = context.parsed.y || 0;
                            
                            // For forecast points, add prediction interval to tooltip
                            if (label.includes('Forecast') && value) {
                                let lowerValue, upperValue;
                                
                                if (label.includes('Total')) {
                                    // Find the indices for the prediction intervals
                                    const lowerPIIndex = context.chart.data.datasets.findIndex(ds => ds.label === 'Total Lower PI');
                                    const upperPIIndex = context.chart.data.datasets.findIndex(ds => ds.label === 'Total Upper PI');
                                    
                                    if (lowerPIIndex !== -1 && upperPIIndex !== -1) {
                                        lowerValue = context.chart.data.datasets[lowerPIIndex].data[context.dataIndex];
                                        upperValue = context.chart.data.datasets[upperPIIndex].data[context.dataIndex];
                                    }
                                } else if (label.includes('Less than 75')) {
                                    const lowerPIIndex = context.chart.data.datasets.findIndex(ds => ds.label === 'Less than 75 Lower PI');
                                    const upperPIIndex = context.chart.data.datasets.findIndex(ds => ds.label === 'Less than 75 Upper PI');
                                    
                                    if (lowerPIIndex !== -1 && upperPIIndex !== -1) {
                                        lowerValue = context.chart.data.datasets[lowerPIIndex].data[context.dataIndex];
                                        upperValue = context.chart.data.datasets[upperPIIndex].data[context.dataIndex];
                                    }
                                } else if (label.includes('75+')) {
                                    const lowerPIIndex = context.chart.data.datasets.findIndex(ds => ds.label === '75+ Lower PI');
                                    const upperPIIndex = context.chart.data.datasets.findIndex(ds => ds.label === '75+ Upper PI');
                                    
                                    if (lowerPIIndex !== -1 && upperPIIndex !== -1) {
                                        lowerValue = context.chart.data.datasets[lowerPIIndex].data[context.dataIndex];
                                        upperValue = context.chart.data.datasets[upperPIIndex].data[context.dataIndex];
                                    }
                                }
                                
                                if (lowerValue && upperValue) {
                                    return [
                                        `${label}: ${Math.round(value)}`,
                                        `95% PI: [${Math.round(lowerValue)}, ${Math.round(upperValue)}]`
                                    ];
                                }
                            }
                            
                            return `${label}: ${Math.round(value)}`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Number of cases'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Year'
                    },
                    max: years.length - 1 // Initially show only historical years
                }
            }
        }
    });
    
    // Create custom legend for incidence chart
    createCustomLegend(incidenceChartObj, 'incidenceLegend', false);
    
    // Prepare data for rate chart
    const totalRateData = [];
    const less75RateData = [];
    const plus75RateData = [];
    
    const totalRateForecastData = [];
    const less75RateForecastData = [];
    const plus75RateForecastData = [];
    
    // Prepare prediction intervals for rate chart
    const totalRateLowerData = [];
    const totalRateUpperData = [];
    const less75RateLowerData = [];
    const less75RateUpperData = [];
    const plus75RateLowerData = [];
    const plus75RateUpperData = [];
    
    // Fill historical data arrays
    for (let i = 0; i < years.length; i++) {
        totalRateData.push(incidence_rate[i]);
        less75RateData.push(less75_incidence_rate[i]);
        plus75RateData.push(plus75_incidence_rate[i]);
        
        // Add null placeholders for forecast in historical period
        if (i < years.length - 1) { // All except last point (2022)
            totalRateForecastData.push(null);
            less75RateForecastData.push(null);
            plus75RateForecastData.push(null);
            
            totalRateLowerData.push(null);
            totalRateUpperData.push(null);
            less75RateLowerData.push(null);
            less75RateUpperData.push(null);
            plus75RateLowerData.push(null);
            plus75RateUpperData.push(null);
        } else { // 2022 point (shared between historical and forecast)
            totalRateForecastData.push(incidence_rate_forecast[0]);
            less75RateForecastData.push(less75_incidence_rate_forecast[0]);
            plus75RateForecastData.push(plus75_incidence_rate_forecast[0]);
            
            totalRateLowerData.push(incidence_rate_lower[0]);
            totalRateUpperData.push(incidence_rate_upper[0]);
            less75RateLowerData.push(less75_incidence_rate_lower[0]);
            less75RateUpperData.push(less75_incidence_rate_upper[0]);
            plus75RateLowerData.push(plus75_incidence_rate_lower[0]);
            plus75RateUpperData.push(plus75_incidence_rate_upper[0]);
        }
    }
    
    // Add forecast data for 2023-2032
    for (let i = 1; i < forecastYears.length; i++) { // Skip first (2022)
        // Add null placeholders for historical in forecast period
        totalRateData.push(null);
        less75RateData.push(null);
        plus75RateData.push(null);
        
        // Add forecast data points
        totalRateForecastData.push(incidence_rate_forecast[i]);
        less75RateForecastData.push(less75_incidence_rate_forecast[i]);
        plus75RateForecastData.push(plus75_incidence_rate_forecast[i]);
        
        // Add prediction intervals
        totalRateLowerData.push(incidence_rate_lower[i]);
        totalRateUpperData.push(incidence_rate_upper[i]);
        less75RateLowerData.push(less75_incidence_rate_lower[i]);
        less75RateUpperData.push(less75_incidence_rate_upper[i]);
        plus75RateLowerData.push(plus75_incidence_rate_lower[i]);
        plus75RateUpperData.push(plus75_incidence_rate_upper[i]);
    }
    
    // Clean up any existing rate chart
    if (rateChartObj) {
        rateChartObj.destroy();
    }
    
    // Create new rate chart
    rateChartObj = new Chart(ctx2, {
        type: 'line',
        data: {
            labels: allYears,
            datasets: [
                // Total Rate - Historical
                {
                    label: 'Total',
                    data: totalRateData,
                    borderColor: '#fb8500',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 3,
                    pointBackgroundColor: '#fb8500'
                },
                // Less than 75 Rate - Historical
                {
                    label: 'Less than 75',
                    data: less75RateData,
                    borderColor: '#023047',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 3,
                    pointBackgroundColor: '#023047'
                },
                // 75+ Rate - Historical
                {
                    label: '75+',
                    data: plus75RateData,
                    borderColor: '#8ecae6',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 3,
                    pointBackgroundColor: '#8ecae6'
                },
                // Total Rate - Lower Confidence Interval
                {
                    label: 'Total Lower PI',
                    data: totalRateLowerData,
                    borderColor: 'rgba(255, 0, 0, 0.2)',
                    backgroundColor: 'rgba(255, 0, 0, 0.2)',
                    fill: '+2', // Fill to dataset with index +2 (the upper interval)
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 0,
                    hidden: true // Start hidden
                },
                // Total Rate - Forecast
                {
                    label: 'Total (Forecast)',
                    data: totalRateForecastData,
                    borderColor: '#ff0000',
                    fill: false,
                    tension: 0.1,
                    borderDash: [5, 5],
                    pointRadius: 3,
                    pointBackgroundColor: '#ff0000',
                    hidden: true // Start hidden
                },
                // Total Rate - Upper Confidence Interval
                {
                    label: 'Total Upper PI',
                    data: totalRateUpperData,
                    borderColor: 'rgba(255, 0, 0, 0)',
                    backgroundColor: 'rgba(255, 0, 0, 0)',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 0,
                    hidden: true // Start hidden
                },
                // Less than 75 Rate - Lower Confidence Interval
                {
                    label: 'Less than 75 Lower PI',
                    data: less75RateLowerData,
                    borderColor: 'rgba(0, 0, 255, 0.2)',
                    backgroundColor: 'rgba(0, 0, 255, 0.2)',
                    fill: '+2', // Fill to dataset with index +2 (the upper interval)
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 0,
                    hidden: true // Start hidden
                },
                // Less than 75 Rate - Forecast
                {
                    label: 'Less than 75 (Forecast)',
                    data: less75RateForecastData,
                    borderColor: '#0000ff',
                    fill: false,
                    tension: 0.1,
                    borderDash: [5, 5],
                    pointRadius: 3,
                    pointBackgroundColor: '#0000ff',
                    hidden: true // Start hidden
                },
                // Less than 75 Rate - Upper Confidence Interval
                {
                    label: 'Less than 75 Upper PI',
                    data: less75RateUpperData,
                    borderColor: 'rgba(0, 0, 255, 0)',
                    backgroundColor: 'rgba(0, 0, 255, 0)',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 0,
                    hidden: true // Start hidden
                },
                // 75+ Rate - Lower Confidence Interval
                {
                    label: '75+ Lower PI',
                    data: plus75RateLowerData,
                    borderColor: 'rgba(255, 105, 180, 0.2)',
                    backgroundColor: 'rgba(255, 105, 180, 0.2)',
                    fill: '+2', // Fill to dataset with index +2 (the upper interval)
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 0,
                    hidden: true // Start hidden
                },
                // 75+ Rate - Forecast
                {
                    label: '75+ (Forecast)',
                    data: plus75RateForecastData,
                    borderColor: '#ff69b4',
                    fill: false,
                    tension: 0.1,
                    borderDash: [5, 5],
                    pointRadius: 3,
                    pointBackgroundColor: '#ff69b4',
                    hidden: true // Start hidden
                },
                // 75+ Rate - Upper Confidence Interval
                {
                    label: '75+ Upper PI',
                    data: plus75RateUpperData,
                    borderColor: 'rgba(255, 105, 180, 0)',
                    backgroundColor: 'rgba(255, 105, 180, 0)',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 0,
                    hidden: true // Start hidden
                }
            ]
        },
        options: {
            plugins: {
                legend: {
                    display: false // Disable built-in legend
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.dataset.label || '';
                            if (label.includes('PI')) return null;
                            
                            const value = context.parsed.y || 0;
                            
                            // For forecast points, add prediction interval to tooltip
                            if (label.includes('Forecast') && value) {
                                let lowerValue, upperValue;
                                
                                if (label.includes('Total')) {
                                    // Find the indices for the prediction intervals
                                    const lowerPIIndex = context.chart.data.datasets.findIndex(ds => ds.label === 'Total Lower PI');
                                    const upperPIIndex = context.chart.data.datasets.findIndex(ds => ds.label === 'Total Upper PI');
                                    
                                    if (lowerPIIndex !== -1 && upperPIIndex !== -1) {
                                        lowerValue = context.chart.data.datasets[lowerPIIndex].data[context.dataIndex];
                                        upperValue = context.chart.data.datasets[upperPIIndex].data[context.dataIndex];
                                    }
                                } else if (label.includes('Less than 75')) {
                                    const lowerPIIndex = context.chart.data.datasets.findIndex(ds => ds.label === 'Less than 75 Lower PI');
                                    const upperPIIndex = context.chart.data.datasets.findIndex(ds => ds.label === 'Less than 75 Upper PI');
                                    
                                    if (lowerPIIndex !== -1 && upperPIIndex !== -1) {
                                        lowerValue = context.chart.data.datasets[lowerPIIndex].data[context.dataIndex];
                                        upperValue = context.chart.data.datasets[upperPIIndex].data[context.dataIndex];
                                    }
                                } else if (label.includes('75+')) {
                                    const lowerPIIndex = context.chart.data.datasets.findIndex(ds => ds.label === '75+ Lower PI');
                                    const upperPIIndex = context.chart.data.datasets.findIndex(ds => ds.label === '75+ Upper PI');
                                    
                                    if (lowerPIIndex !== -1 && upperPIIndex !== -1) {
                                        lowerValue = context.chart.data.datasets[lowerPIIndex].data[context.dataIndex];
                                        upperValue = context.chart.data.datasets[upperPIIndex].data[context.dataIndex];
                                    }
                                }
                                
                                if (lowerValue && upperValue) {
                                    return [
                                        `${label}: ${value.toFixed(2)}`,
                                        `95% PI: [${lowerValue.toFixed(2)}, ${upperValue.toFixed(2)}]`
                                    ];
                                }
                            }
                            
                            return `${label}: ${value.toFixed(2)}`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Age-standardized prevalence rate (per 10,000 persons)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Year'
                    },
                    max: years.length - 1 // Initially show only historical years
                }
            }
        }
    });
    
    // Create custom legend for rate chart
    createCustomLegend(rateChartObj, 'rateLegend', true);
    
    // Show initial chart
    toggleChart('incidence', null);
}

// Function to update prevalence charts with forecast data
function updatePrevalenceCharts() {
    // Get chart contexts
    const ctxNumber = document.getElementById('prevalenceNumberChart').getContext('2d');
    const ctxRate = document.getElementById('prevalenceRateChart').getContext('2d');
    
    // Create combined data arrays for prevalence number chart
    const totalPrevData = [];
    const less75PrevData = [];
    const plus75PrevData = [];
    
    const totalPrevForecastData = [];
    const less75PrevForecastData = []; 
    const plus75PrevForecastData = [];
    
    // Prepare data for prediction intervals
    const totalPrevLowerData = [];
    const totalPrevUpperData = [];
    const less75PrevLowerData = [];
    const less75PrevUpperData = [];
    const plus75PrevLowerData = [];
    const plus75PrevUpperData = [];
    
    // Fill historical data arrays
    for (let i = 0; i < years.length; i++) {
        totalPrevData.push(num_unique_prev[i]);
        less75PrevData.push(num_less75_patient_prev[i]);
        plus75PrevData.push(num_75plus_patient_prev[i]);
        
        // Add null placeholders for forecast in historical period
        if (i < years.length - 1) { // All except last point (2022)
            totalPrevForecastData.push(null);
            less75PrevForecastData.push(null);
            plus75PrevForecastData.push(null);
            
            totalPrevLowerData.push(null);
            totalPrevUpperData.push(null);
            less75PrevLowerData.push(null);
            less75PrevUpperData.push(null);
            plus75PrevLowerData.push(null);
            plus75PrevUpperData.push(null);
        } else { // 2022 point (shared between historical and forecast)
            totalPrevForecastData.push(totalPrevForecast[0]);
            less75PrevForecastData.push(less75PrevForecast[0]);
            plus75PrevForecastData.push(plus75PrevForecast[0]);
            
            totalPrevLowerData.push(totalPrevLower[0]);
            totalPrevUpperData.push(totalPrevUpper[0]);
            less75PrevLowerData.push(less75PrevLower[0]);
            less75PrevUpperData.push(less75PrevUpper[0]);
            plus75PrevLowerData.push(plus75PrevLower[0]);
            plus75PrevUpperData.push(plus75PrevUpper[0]);
        }
    }
    
    // Add forecast data for 2023-2032
    for (let i = 1; i < prevForecastYears.length; i++) { // Skip first (2022)
        // Add null placeholders for historical in forecast period
        totalPrevData.push(null);
        less75PrevData.push(null);
        plus75PrevData.push(null);
        
        // Add forecast data points
        totalPrevForecastData.push(totalPrevForecast[i]);
        less75PrevForecastData.push(less75PrevForecast[i]);
        plus75PrevForecastData.push(plus75PrevForecast[i]);
        
        // Add prediction intervals
        totalPrevLowerData.push(totalPrevLower[i]);
        totalPrevUpperData.push(totalPrevUpper[i]);
        less75PrevLowerData.push(less75PrevLower[i]);
        less75PrevUpperData.push(less75PrevUpper[i]);
        plus75PrevLowerData.push(plus75PrevLower[i]);
        plus75PrevUpperData.push(plus75PrevUpper[i]);
    }
    
    // Create combined years array
    const allYears = [...years]; // Start with historical years
    
    // Add 2023-2032 (excluding 2022 which is already included)
    for (let i = 1; i < prevForecastYears.length; i++) {
        allYears.push(prevForecastYears[i]);
    }
    
    // Clean up any existing charts
    if (prevalenceNumberChart) {
        prevalenceNumberChart.destroy();
    }
    
    // Create new prevalence number chart
    prevalenceNumberChart = new Chart(ctxNumber, {
        type: 'line',
        data: {
            labels: allYears,
            datasets: [
                // Total Cases - Historical
                {
                    label: 'Total',
                    data: totalPrevData,
                    borderColor: '#fb8500',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 3,
                    pointBackgroundColor: '#fb8500'
                },
                // Less than 75 Cases - Historical
                {
                    label: 'Less than 75',
                    data: less75PrevData,
                    borderColor: '#023047',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 3,
                    pointBackgroundColor: '#023047'
                },
                // 75+ Cases - Historical
                {
                    label: '75+',
                    data: plus75PrevData,
                    borderColor: '#8ecae6',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 3,
                    pointBackgroundColor: '#8ecae6'
                },
                // Total Cases - Lower Confidence Interval
                {
                    label: 'Total Lower PI',
                    data: totalPrevLowerData,
                    borderColor: 'rgba(255, 0, 0, 0.2)',
                    backgroundColor: 'rgba(255, 0, 0, 0.2)',
                    fill: '+2', // Fill to dataset with index +2 (the upper interval)
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 0,
                    hidden: true // Start hidden
                },
                // Total Cases - Forecast
                {
                    label: 'Total (Forecast)',
                    data: totalPrevForecastData,
                    borderColor: '#ff0000', 
                    fill: false,
                    tension: 0.1,
                    borderDash: [5, 5],
                    pointRadius: 3,
                    pointBackgroundColor: '#ff0000',
                    hidden: true // Start hidden
                },
                // Total Cases - Upper Confidence Interval
                {
                    label: 'Total Upper PI',
                    data: totalPrevUpperData,
                    borderColor: 'rgba(255, 0, 0, 0)',
                    backgroundColor: 'rgba(255, 0, 0, 0)',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 0,
                    hidden: true // Start hidden
                },
                // Less than 75 Cases - Lower Confidence Interval
                {
                    label: 'Less than 75 Lower PI',
                    data: less75PrevLowerData,
                    borderColor: 'rgba(0, 0, 255, 0.2)',
                    backgroundColor: 'rgba(0, 0, 255, 0.2)',
                    fill: '+2', // Fill to dataset with index +2 (the upper interval)
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 0,
                    hidden: true // Start hidden
                },
                // Less than 75 Cases - Forecast
                {
                    label: 'Less than 75 (Forecast)',
                    data: less75PrevForecastData,
                    borderColor: '#0000ff',
                    fill: false,
                    tension: 0.1,
                    borderDash: [5, 5],
                    pointRadius: 3,
                    pointBackgroundColor: '#0000ff',
                    hidden: true // Start hidden
                },
                // Less than 75 Cases - Upper Confidence Interval
                {
                    label: 'Less than 75 Upper PI',
                    data: less75PrevUpperData,
                    borderColor: 'rgba(0, 0, 255, 0)',
                    backgroundColor: 'rgba(0, 0, 255, 0)',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 0,
                    hidden: true // Start hidden
                },
                // 75+ Cases - Lower Confidence Interval
                {
                    label: '75+ Lower PI',
                    data: plus75PrevLowerData,
                    borderColor: 'rgba(255, 105, 180, 0.2)',
                    backgroundColor: 'rgba(255, 105, 180, 0.2)',
                    fill: '+2', // Fill to dataset with index +2 (the upper interval)
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 0,
                    hidden: true // Start hidden
                },
                // 75+ Cases - Forecast
                {
                    label: '75+ (Forecast)',
                    data: plus75PrevForecastData,
                    borderColor: '#ff69b4',
                    fill: false,
                    tension: 0.1,
                    borderDash: [5, 5],
                    pointRadius: 3,
                    pointBackgroundColor: '#ff69b4',
                    hidden: true // Start hidden
                },
                // 75+ Cases - Upper Confidence Interval
                {
                    label: '75+ Upper PI',
                    data: plus75PrevUpperData,
                    borderColor: 'rgba(255, 105, 180, 0)',
                    backgroundColor: 'rgba(255, 105, 180, 0)',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 0,
                    hidden: true // Start hidden
                }
            ]
        },
        options: {
            plugins: {
                legend: {
                    display: false // Disable built-in legend
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.dataset.label || '';
                            if (label.includes('PI')) return null;
                            
                            const value = context.parsed.y || 0;
                            
                            // For forecast points, add prediction interval to tooltip
                            if (label.includes('Forecast') && value) {
                                let lowerValue, upperValue;
                                
                                if (label.includes('Total')) {
                                    // Find the indices for the prediction intervals
                                    const lowerPIIndex = context.chart.data.datasets.findIndex(ds => ds.label === 'Total Lower PI');
                                    const upperPIIndex = context.chart.data.datasets.findIndex(ds => ds.label === 'Total Upper PI');
                                    
                                    if (lowerPIIndex !== -1 && upperPIIndex !== -1) {
                                        lowerValue = context.chart.data.datasets[lowerPIIndex].data[context.dataIndex];
                                        upperValue = context.chart.data.datasets[upperPIIndex].data[context.dataIndex];
                                    }
                                } else if (label.includes('Less than 75')) {
                                    const lowerPIIndex = context.chart.data.datasets.findIndex(ds => ds.label === 'Less than 75 Lower PI');
                                    const upperPIIndex = context.chart.data.datasets.findIndex(ds => ds.label === 'Less than 75 Upper PI');
                                    
                                    if (lowerPIIndex !== -1 && upperPIIndex !== -1) {
                                        lowerValue = context.chart.data.datasets[lowerPIIndex].data[context.dataIndex];
                                        upperValue = context.chart.data.datasets[upperPIIndex].data[context.dataIndex];
                                    }
                                } else if (label.includes('75+')) {
                                    const lowerPIIndex = context.chart.data.datasets.findIndex(ds => ds.label === '75+ Lower PI');
                                    const upperPIIndex = context.chart.data.datasets.findIndex(ds => ds.label === '75+ Upper PI');
                                    
                                    if (lowerPIIndex !== -1 && upperPIIndex !== -1) {
                                        lowerValue = context.chart.data.datasets[lowerPIIndex].data[context.dataIndex];
                                        upperValue = context.chart.data.datasets[upperPIIndex].data[context.dataIndex];
                                    }
                                }
                                
                                if (lowerValue && upperValue) {
                                    return [
                                        `${label}: ${Math.round(value)}`,
                                        `95% PI: [${Math.round(lowerValue)}, ${Math.round(upperValue)}]`
                                    ];
                                }
                            }
                            
                            return `${label}: ${Math.round(value)}`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Number of prevalent cases'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Year'
                    },
                    max: years.length - 1 // Initially show only historical years
                }
            }
        }
    });
    
    // Create custom legend for prevalence number chart
    createCustomLegend(prevalenceNumberChart, 'prevalenceNumberLegend', false);
    
    // Prepare data for prevalence rate chart
    const totalRateData = [];
    const less75RateData = [];
    const plus75RateData = [];
    
    const totalRateForecastData = [];
    const less75RateForecastData = [];
    const plus75RateForecastData = [];
    
    // Prepare prediction intervals for rate chart
    const totalRateLowerData = [];
    const totalRateUpperData = [];
    const less75RateLowerData = [];
    const less75RateUpperData = [];
    const plus75RateLowerData = [];
    const plus75RateUpperData = [];
    
    // Fill historical data arrays
    for (let i = 0; i < years.length; i++) {
        totalRateData.push(Age_Standardized_Prevalence[i]);
        less75RateData.push(age_standardized_prev_less75[i]);
        plus75RateData.push(age_standardized_prev_75plus[i]);
        
        // Add null placeholders for forecast in historical period
        if (i < years.length - 1) { // All except last point (2022)
            totalRateForecastData.push(null);
            less75RateForecastData.push(null);
            plus75RateForecastData.push(null);
            
            totalRateLowerData.push(null);
            totalRateUpperData.push(null);
            less75RateLowerData.push(null);
            less75RateUpperData.push(null);
            plus75RateLowerData.push(null);
            plus75RateUpperData.push(null);
        } else { // 2022 point (shared between historical and forecast)
            totalRateForecastData.push(totalPrevRateForecast[0]);
            less75RateForecastData.push(less75PrevRateForecast[0]);
            plus75RateForecastData.push(plus75PrevRateForecast[0]);
            
            totalRateLowerData.push(totalPrevRateLower[0]);
            totalRateUpperData.push(totalPrevRateUpper[0]);
            less75RateLowerData.push(less75PrevRateLower[0]);
            less75RateUpperData.push(less75PrevRateUpper[0]);
            plus75RateLowerData.push(plus75PrevRateLower[0]);
            plus75RateUpperData.push(plus75PrevRateUpper[0]);
        }
    }
    
    // Add forecast data for 2023-2032
    for (let i = 1; i < prevForecastYears.length; i++) { // Skip first (2022)
        // Add null placeholders for historical in forecast period
        totalRateData.push(null);
        less75RateData.push(null);
        plus75RateData.push(null);
        
        // Add forecast data points
        totalRateForecastData.push(totalPrevRateForecast[i]);
        less75RateForecastData.push(less75PrevRateForecast[i]);
        plus75RateForecastData.push(plus75PrevRateForecast[i]);
        
        // Add prediction intervals
        totalRateLowerData.push(totalPrevRateLower[i]);
        totalRateUpperData.push(totalPrevRateUpper[i]);
        less75RateLowerData.push(less75PrevRateLower[i]);
        less75RateUpperData.push(less75PrevRateUpper[i]);
        plus75RateLowerData.push(plus75PrevRateLower[i]);
        plus75RateUpperData.push(plus75PrevRateUpper[i]);
    }
    
    // Clean up any existing rate chart
    if (prevalenceRateChart) {
        prevalenceRateChart.destroy();
    }
    
    // Create new prevalence rate chart
    prevalenceRateChart = new Chart(ctxRate, {
        type: 'line',
        data: {
            labels: allYears,
            datasets: [
                // Total Rate - Historical
                {
                    label: 'Total',
                    data: totalRateData,
                    borderColor: '#fb8500',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 3,
                    pointBackgroundColor: '#fb8500'
                },
                // Less than 75 Rate - Historical
                {
                    label: 'Less than 75',
                    data: less75RateData,
                    borderColor: '#023047',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 3,
                    pointBackgroundColor: '#023047'
                },
                // 75+ Rate - Historical
                {
                    label: '75+',
                    data: plus75RateData,
                    borderColor: '#8ecae6',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 3,
                    pointBackgroundColor: '#8ecae6'
                },
                // Total Rate - Lower Confidence Interval
                {
                    label: 'Total Lower PI',
                    data: totalRateLowerData,
                    borderColor: 'rgba(255, 0, 0, 0.2)',
                    backgroundColor: 'rgba(255, 0, 0, 0.2)',
                    fill: '+2', // Fill to dataset with index +2 (the upper interval)
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 0,
                    hidden: true // Start hidden
                },
                // Total Rate - Forecast
                {
                    label: 'Total (Forecast)',
                    data: totalRateForecastData,
                    borderColor: '#ff0000',
                    fill: false,
                    tension: 0.1,
                    borderDash: [5, 5],
                    pointRadius: 3,
                    pointBackgroundColor: '#ff0000',
                    hidden: true // Start hidden
                },
                // Total Rate - Upper Confidence Interval
                {
                    label: 'Total Upper PI',
                    data: totalRateUpperData,
                    borderColor: 'rgba(255, 0, 0, 0)',
                    backgroundColor: 'rgba(255, 0, 0, 0)',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 0,
                    hidden: true // Start hidden
                },
                // Less than 75 Rate - Lower Confidence Interval
                {
                    label: 'Less than 75 Lower PI',
                    data: less75RateLowerData,
                    borderColor: 'rgba(0, 0, 255, 0.2)',
                    backgroundColor: 'rgba(0, 0, 255, 0.2)',
                    fill: '+2', // Fill to dataset with index +2 (the upper interval)
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 0,
                    hidden: true // Start hidden
                },
                // Less than 75 Rate - Forecast
                {
                    label: 'Less than 75 (Forecast)',
                    data: less75RateForecastData,
                    borderColor: '#0000ff',
                    fill: false,
                    tension: 0.1,
                    borderDash: [5, 5],
                    pointRadius: 3,
                    pointBackgroundColor: '#0000ff',
                    hidden: true // Start hidden
                },
                // Less than 75 Rate - Upper Confidence Interval
                {
                    label: 'Less than 75 Upper PI',
                    data: less75RateUpperData,
                    borderColor: 'rgba(0, 0, 255, 0)',
                    backgroundColor: 'rgba(0, 0, 255, 0)',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 0,
                    hidden: true // Start hidden
                },
                // 75+ Rate - Lower Confidence Interval
                {
                    label: '75+ Lower PI',
                    data: plus75RateLowerData,
                    borderColor: 'rgba(255, 105, 180, 0.2)',
                    backgroundColor: 'rgba(255, 105, 180, 0.2)',
                    fill: '+2', // Fill to dataset with index +2 (the upper interval)
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 0,
                    hidden: true // Start hidden
                },
                // 75+ Rate - Forecast
                {
                    label: '75+ (Forecast)',
                    data: plus75RateForecastData,
                    borderColor: '#ff69b4',
                    fill: false,
                    tension: 0.1,
                    borderDash: [5, 5],
                    pointRadius: 3,
                    pointBackgroundColor: '#ff69b4',
                    hidden: true // Start hidden
                },
                // 75+ Rate - Upper Confidence Interval
                {
                    label: '75+ Upper PI',
                    data: plus75RateUpperData,
                    borderColor: 'rgba(255, 105, 180, 0)',
                    backgroundColor: 'rgba(255, 105, 180, 0)',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 0,
                    hidden: true // Start hidden
                }
            ]
        },
        options: {
            plugins: {
                legend: {
                    display: false // Disable built-in legend
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.dataset.label || '';
                            if (label.includes('PI')) return null;
                            
                            const value = context.parsed.y || 0;
                            
                            // For forecast points, add prediction interval to tooltip
                            if (label.includes('Forecast') && value) {
                                let lowerValue, upperValue;
                                
                                if (label.includes('Total')) {
                                    // Find the indices for the prediction intervals
                                    const lowerPIIndex = context.chart.data.datasets.findIndex(ds => ds.label === 'Total Lower PI');
                                    const upperPIIndex = context.chart.data.datasets.findIndex(ds => ds.label === 'Total Upper PI');
                                    
                                    if (lowerPIIndex !== -1 && upperPIIndex !== -1) {
                                        lowerValue = context.chart.data.datasets[lowerPIIndex].data[context.dataIndex];
                                        upperValue = context.chart.data.datasets[upperPIIndex].data[context.dataIndex];
                                    }
                                } else if (label.includes('Less than 75')) {
                                    const lowerPIIndex = context.chart.data.datasets.findIndex(ds => ds.label === 'Less than 75 Lower PI');
                                    const upperPIIndex = context.chart.data.datasets.findIndex(ds => ds.label === 'Less than 75 Upper PI');
                                    
                                    if (lowerPIIndex !== -1 && upperPIIndex !== -1) {
                                        lowerValue = context.chart.data.datasets[lowerPIIndex].data[context.dataIndex];
                                        upperValue = context.chart.data.datasets[upperPIIndex].data[context.dataIndex];
                                    }
                                } else if (label.includes('75+')) {
                                    const lowerPIIndex = context.chart.data.datasets.findIndex(ds => ds.label === '75+ Lower PI');
                                    const upperPIIndex = context.chart.data.datasets.findIndex(ds => ds.label === '75+ Upper PI');
                                    
                                    if (lowerPIIndex !== -1 && upperPIIndex !== -1) {
                                        lowerValue = context.chart.data.datasets[lowerPIIndex].data[context.dataIndex];
                                        upperValue = context.chart.data.datasets[upperPIIndex].data[context.dataIndex];
                                    }
                                }
                                
                                if (lowerValue && upperValue) {
                                    return [
                                        `${label}: ${value.toFixed(2)}`,
                                        `95% PI: [${lowerValue.toFixed(2)}, ${upperValue.toFixed(2)}]`
                                    ];
                                }
                            }
                            
                            return `${label}: ${value.toFixed(2)}`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Age-standardized incidence rate (per 10,000 persons)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Year'
                    },
                    max: years.length - 1 // Initially show only historical years
                }
            }
        }
    });
    
    // Create custom legend for prevalence rate chart
    createCustomLegend(prevalenceRateChart, 'prevalenceRateLegend', true);
    
    // Show default prevalence chart
    togglePrevalence('number', null);
}

// Parse historical data first
Papa.parse('incidence_data.csv', {
    download: true,
    header: true,
    complete: function(results) {
        // Extract historical data
        years = results.data.map(row => parseInt(row.Year)).filter(y => y);
        lastHistoricalYear = Math.max(...years);
        
        // Process cost data
        AE_cost = results.data.map(row => parseFloatFixed(row.AE_cost / 100000000));
        IP_cost = results.data.map(row => parseFloatFixed(row.IP_cost / 100000000));
        OP_cost = results.data.map(row => parseFloatFixed(row.OP_cost / 100000000));
        
        // Function to safely parse float and keep two decimal places
        function parseFloatFixed(value) {
            return value ? parseFloat(value).toFixed(2) : "0.00";
        }
        
        // Process historical incidence data
        num_inci = results.data.map(row => parseInt(row.num_inci) || 0);
        num_less75_inci = results.data.map(row => parseInt(row.num_less75_inci) || 0);
        num_75plus_inci = results.data.map(row => parseInt(row.num_75plus_inci) || 0);
        incidence_rate = results.data.map(row => parseFloat(row.Age_standardized_Incidence) || 0);
        less75_incidence_rate = results.data.map(row => parseFloat(row.age_standardized_inci_less75) || 0);
        plus75_incidence_rate = results.data.map(row => parseFloat(row.age_standardized_inci_75plus) || 0);
        
        // Process historical prevalence data
        num_unique_prev = results.data.map(row => parseInt(row.num_unique_prev) || 0);
        num_less75_patient_prev = results.data.map(row => parseInt(row.num_less75_patient_prev) || 0);
        num_75plus_patient_prev = results.data.map(row => parseInt(row.num_75plus_patient_prev) || 0);        
        Age_Standardized_Prevalence = results.data.map(row => parseFloat(row.Age_Standardized_Prevalence) || 0);
        age_standardized_prev_less75 = results.data.map(row => parseFloat(row.age_standardized_prev_less75) || 0);
        age_standardized_prev_75plus = results.data.map(row => parseFloat(row.age_standardized_prev_75plus) || 0);
        
        // Create cost chart
        const costdata = {
            labels: years,
            datasets: [
                {
                    label: 'Inpatient Cost',
                    data: IP_cost,
                    backgroundColor: '#0072B2'
                },
                {
                    label: 'Outpatient Cost',
                    data: OP_cost,
                    backgroundColor: '#009E73'
                },
                {
                    label: 'Accident & Emergency Cost',
                    data: AE_cost,
                    backgroundColor: '#f94144'
                }
            ]
        };

        const config = {
            type: 'bar',
            data: costdata,
            options: {
                plugins: {
                    legend: {
                        display: true,
                    }
                },
                responsive: true,
                scales: {
                    x: {
                        stacked: true,
                        title: {
                            display: true,
                            text: 'Year'
                        }
                    },
                    y: {
                        stacked: true,
                        title: {
                            display: true,
                            text: 'Cost (HKD 100,000,000)'
                        }
                    }
                }
            }
        };

        const ctx = document.getElementById('myChart').getContext('2d');
        myChart = new Chart(ctx, config);
        
        // Now load incidence forecast data
        Papa.parse('Overall_Forecasts_2023_2032.csv', {
            download: true,
            header: false,
            skipEmptyLines: true,
            complete: function(forecastResults) {
                // Skip the header row
                let data = forecastResults.data.slice(1);
                
                // Extract forecast years and data
                forecastYears = data.map(row => parseInt(row[1])).filter(y => y);
                
                // Extract forecast data and prediction intervals for incidence
                num_inci_forecast = data.map(row => parseFloat(row[2]) || 0);
                num_inci_lower = data.map(row => parseFloat(row[3]) || 0);
                num_inci_upper = data.map(row => parseFloat(row[4]) || 0);
                
                less75_inci_forecast = data.map(row => parseFloat(row[7]) || 0);
                less75_inci_lower = data.map(row => parseFloat(row[8]) || 0);
                less75_inci_upper = data.map(row => parseFloat(row[9]) || 0);
                
                plus75_inci_forecast = data.map(row => parseFloat(row[12]) || 0);
                plus75_inci_lower = data.map(row => parseFloat(row[13]) || 0);
                plus75_inci_upper = data.map(row => parseFloat(row[14]) || 0);
                
                incidence_rate_forecast = data.map(row => parseFloat(row[17]) || 0);
                incidence_rate_lower = data.map(row => parseFloat(row[18]) || 0);
                incidence_rate_upper = data.map(row => parseFloat(row[19]) || 0);
                
                less75_incidence_rate_forecast = data.map(row => parseFloat(row[22]) || 0);
                less75_incidence_rate_lower = data.map(row => parseFloat(row[23]) || 0);
                less75_incidence_rate_upper = data.map(row => parseFloat(row[24]) || 0);
                
                plus75_incidence_rate_forecast = data.map(row => parseFloat(row[27]) || 0);
                plus75_incidence_rate_lower = data.map(row => parseFloat(row[28]) || 0);
                plus75_incidence_rate_upper = data.map(row => parseFloat(row[29]) || 0);
                
                // Update incidence charts with forecast data
                updateIncidenceCharts();
                
                // Now load prevalence forecast data
                Papa.parse('Overall_Forecasts_2023_2032_prev.csv', {
                    download: true,
                    header: false,
                    skipEmptyLines: true,
                    complete: function(prevForecastResults) {
                        // Skip the header row
                        let prevData = prevForecastResults.data.slice(1);
                        
                        // Extract forecast years and data
                        prevForecastYears = prevData.map(row => parseInt(row[1])).filter(y => y);
                        
                        // Extract prevalence forecast data and prediction intervals
                        totalPrevForecast = prevData.map(row => parseFloat(row[2]) || 0);
                        totalPrevLower = prevData.map(row => parseFloat(row[3]) || 0);
                        totalPrevUpper = prevData.map(row => parseFloat(row[4]) || 0);
                        
                        less75PrevForecast = prevData.map(row => parseFloat(row[7]) || 0);
                        less75PrevLower = prevData.map(row => parseFloat(row[8]) || 0);
                        less75PrevUpper = prevData.map(row => parseFloat(row[9]) || 0);
                        
                        plus75PrevForecast = prevData.map(row => parseFloat(row[12]) || 0);
                        plus75PrevLower = prevData.map(row => parseFloat(row[13]) || 0);
                        plus75PrevUpper = prevData.map(row => parseFloat(row[14]) || 0);
                        
                        totalPrevRateForecast = prevData.map(row => parseFloat(row[17]) || 0);
                        totalPrevRateLower = prevData.map(row => parseFloat(row[18]) || 0);
                        totalPrevRateUpper = prevData.map(row => parseFloat(row[19]) || 0);
                        
                        less75PrevRateForecast = prevData.map(row => parseFloat(row[22]) || 0);
                        less75PrevRateLower = prevData.map(row => parseFloat(row[23]) || 0);
                        less75PrevRateUpper = prevData.map(row => parseFloat(row[24]) || 0);
                        
                        plus75PrevRateForecast = prevData.map(row => parseFloat(row[27]) || 0);
                        plus75PrevRateLower = prevData.map(row => parseFloat(row[28]) || 0);
                        plus75PrevRateUpper = prevData.map(row => parseFloat(row[29]) || 0);
                        
                        // Update prevalence charts with forecast data
                        updatePrevalenceCharts();
                        
                        // Load KM curve data
                        loadKMCurve();
                    },
                    error: function(error) {
                        console.error("Error loading prevalence forecast data:", error);
                    }
                });
            },
            error: function(error) {
                console.error("Error loading incidence forecast data:", error);
            }
        });
        
        // Load treated patients chart data
        loadTreatedPatientsChart();
    },
    error: function(error) {
        console.error("Error loading historical data:", error);
    }
});

function loadKMCurve() {
    Papa.parse('KM_curve_data_total.csv', {
        download: true,
        header: true,
        complete: function(totalResults) {
            Papa.parse('KM_curve_data_age.csv', {
                download: true,
                header: true,
                complete: function(ageResults) {
                    // Extract total survival data
                    const totalData = totalResults.data.map(d => ({
                        time: +d.time_combined,
                        survival: +d.survival_combined
                    }));

                    // Extract age-stratified survival data
                    const less75Data = ageResults.data.filter(d => d.AgeGroup === "AgeGroup=<75").map(d => ({
                        time: +d.time_age,
                        survival: +d.survival_age
                    }));

                    const plus75Data = ageResults.data.filter(d => d.AgeGroup === "AgeGroup=75+").map(d => ({
                        time: +d.time_age,
                        survival: +d.survival_age
                    }));

                    // Set up SVG canvas
                    const svg = d3.select("#chart");
                    const margin = { top: 20, right: 150, bottom: 50, left: 100 };
                    const width = +svg.attr("width") - margin.left - margin.right;
                    const height = +svg.attr("height") - margin.top - margin.bottom;
                    svg.selectAll("*").remove(); // Clear existing chart
                    const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

                    // Define scales
                    const x = d3.scaleLinear()
                        .domain([0, 9]) // Common time domain
                        .range([0, width]);

                    const y = d3.scaleLinear()
                        .domain([0, 1]) // Survival probabilities range from 0 to 1
                        .range([height, 0]);

                    // Add x-axis
                    const xAxis = g.append("g")
                        .attr("transform", `translate(0,${height})`)
                        .call(d3.axisBottom(x)
                            .ticks(9)
                            .tickValues([0, 1, 2, 3, 4, 5, 6, 7, 8, 9])
                        );

                    // Customize x-axis font style
                    xAxis.selectAll("text")
                        .style("font-size", "12px") // Change font size
                        .style("font-family", "Arial, sans-serif"); // Change font family
                    
                    // Add y-axis
                    const yAxis = g.append("g")
                        .call(d3.axisLeft(y)
                            .ticks(10)
                            .tickFormat(d3.format(".0%")) // Display as percentage
                        );

                    // Customize y-axis font style
                    yAxis.selectAll("text")
                        .style("font-size", "12px") // Change font size
                        .style("font-family", "Arial, sans-serif"); // Change font family
                    
                    // Add axis labels
                    g.append("text")
                        .attr("transform", `translate(${width / 2}, ${height + margin.bottom - 10})`)
                        .style("text-anchor", "middle")
                        .text("Time Since Diagnosis (Years)");

                    g.append("text")
                        .attr("transform", "rotate(-90)")
                        .attr("y", 0 - margin.left + 10)
                        .attr("x", 0 - height / 2)
                        .attr("dy", "1em")
                        .style("text-anchor", "middle")
                        .text("Survival Probability (%)");

                    // Line generator for survival curves
                    const line = d3.line()
                        .x(d => x(d.time))
                        .y(d => y(d.survival));

                    // Define colors
                    const colors = {
                        total: "#fb8500", // Total
                        less75: "#023047", // Less than 75
                        plus75: "#8ecae6"  // 75+
                    };

                    // Draw survival curves
                    g.append("path") // Total Population
                        .datum(totalData)
                        .attr("fill", "none")
                        .attr("stroke", colors.total)
                        .attr("stroke-width", 2.5)
                        .attr("d", line);

                    g.append("path") // <75 group
                        .datum(less75Data)
                        .attr("fill", "none")
                        .attr("stroke", colors.less75)
                        .attr("stroke-width", 2.5)
                        .attr("d", line);

                    g.append("path") // 75+ group
                        .datum(plus75Data)
                        .attr("fill", "none")
                        .attr("stroke", colors.plus75)
                        .attr("stroke-width", 2.5)
                        .attr("d", line);

                    // Add dots at key time points (1y, 5y, 9y)
                    const targetYears = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9];

                    function addDots(data, color, label) {
                        targetYears.forEach(targetTime => {
                            const closestPoint = data.reduce((closest, current) => {
                                return (current.time <= targetTime && (!closest || current.time > closest.time)) ? current : closest;
                            }, null);

                            if (closestPoint) {
                                g.append("circle")
                                    .attr("cx", x(closestPoint.time))
                                    .attr("cy", y(closestPoint.survival))
                                    .attr("r", 5)
                                    .attr("fill", color)
                                    .on("mouseover", function (event) {
                                        tooltip
                                            .style("opacity", 1)
                                            .html(`${label}<br>Year: ${Math.round(closestPoint.time)}<br>Survival: ${(closestPoint.survival * 100).toFixed(2)}%`)
                                            .style("left", (event.pageX + 10) + "px")
                                            .style("top", (event.pageY - 20) + "px");
                                    })
                                    .on("mouseout", function () {
                                        tooltip.style("opacity", 0);
                                    });
                            }
                        });
                    }

                    addDots(totalData, colors.total, "Total");
                    addDots(less75Data, colors.less75, "Less than 75");
                    addDots(plus75Data, colors.plus75, "75+ ");

                    // Tooltip
                    const tooltip = d3.select("body").append("div")
                        .attr("class", "tooltip")
                        .style("position", "absolute")
                        .style("background", "rgba(0, 0, 0, 0.7)")
                        .style("color", "#fff")
                        .style("padding", "5px 10px")
                        .style("border-radius", "5px")
                        .style("font-size", "12px")
                        .style("pointer-events", "none")
                        .style("opacity", 0);

                    // Add legend
                    const legend = svg.append("g")
                        .attr("transform", `translate(${width + margin.right-100}, 30)`);

                    Object.entries(colors).forEach(([key, color], index) => {
                        legend.append("circle") // Use circle instead of rectangle
                            .attr("cx", 7.5) // X position (center of the circle)
                            .attr("cy", index * 25 + 7.5) // Y position (aligning with text)
                            .attr("r", 7.5) // Radius (same size as 15x15 rect)
                            .attr("fill", color); // Set the fill color

                        legend.append("text")
                            .attr("x", 20)
                            .attr("y", index * 25 + 12)
                            .text(key === "total" ? "Total" : key === "less75" ? "Less than 75" : "75+ ")
                            .style("font-size", "12px")
                            .attr("alignment-baseline", "middle");
                    });
                }
            });
        }
    });
}

function loadTreatedPatientsChart() {
    Papa.parse('PC Unmet Need Plot Data.csv', {
        download: true,
        header: true,
        complete: function(results) {
            // Filter data to years >=2013 to match R code
            const filteredData = results.data.filter(row => parseInt(row.year) >= 2013);
            
            // Get unique years and patient groups - sort years numerically
            const years = [...new Set(filteredData.map(row => row.year))].sort((a, b) => parseInt(a) - parseInt(b));
            const groups = [...new Set(filteredData.map(row => row.grp))];
            
            // Clear existing chart div content but keep the title
            const chartDiv = document.getElementById('cohortData');
            const title = chartDiv.querySelector('h2');
            
            // First check for existing charts and destroy them
            const existingCanvas = document.getElementById('treatedPatientsChart');
            if (existingCanvas) {
                const chartInstance = Chart.getChart(existingCanvas);
                if (chartInstance) {
                    chartInstance.destroy();
                }
            }
            
            // Clear everything
            chartDiv.innerHTML = '';
            chartDiv.appendChild(title);
            
            // Create a container that will hold both charts
            const chartsOuterContainer = document.createElement('div');
            chartsOuterContainer.style.width = '95%';
            chartsOuterContainer.style.maxWidth = '1200px';
            chartsOuterContainer.style.margin = '0 auto';
            chartsOuterContainer.style.position = 'relative';
            chartsOuterContainer.style.height = '450px';
            chartDiv.appendChild(chartsOuterContainer);
            
            // Create a container for the facet titles
            const facetTitles = document.createElement('div');
            facetTitles.style.display = 'flex';
            facetTitles.style.width = '100%';
            
            // Add the group titles (CR and M) with proper positioning
            groups.forEach((group, index) => {
                const title = document.createElement('div');
                title.textContent = group === 'CR' ? 'CRPC Patients' : 'Metastatic Patients';
                title.style.width = '50%';
                title.style.textAlign = 'center';
                title.style.fontWeight = 'bold';
                title.style.fontSize = '16px';
                facetTitles.appendChild(title);
            });
            chartsOuterContainer.appendChild(facetTitles);
            
            // Create a single canvas that will span across both charts
            const canvas = document.createElement('canvas');
            canvas.id = 'treatedPatientsChart';
            canvas.style.width = '100%';
            canvas.style.height = 'calc(100% - 30px)';
            chartsOuterContainer.appendChild(canvas);
            
            // Create labels - first all CR years, then all M years
            const labels = [];
            groups.forEach(group => {
                years.forEach(year => {
                    labels.push(`${year} (${group})`);
                });
            });
            
            // Extract data by patient type and group
            const datasets = [];
            const patientTypes = [
                { id: 'treat_90', label: 'Treated within 30 days', color: 'steelblue' },
                { id: 'treat_180', label: 'Treated within 30-180 days', color: 'forestgreen' },
                { id: 'diagnosis', label: 'Not treated in 180 days', color: 'red' }
            ];
            
            // Store prop_180 values for data labels
            const proportions = {};
            groups.forEach(group => {
                proportions[group] = {};
                years.forEach(year => {
                    const entry = filteredData.find(row => 
                        row.grp === group && 
                        row.year === year && 
                        row.patient === 'prop_180'
                    );
                    if (entry) {
                        proportions[group][year] = parseFloat(entry.number);
                    }
                });
            });
            
            // Prepare data for each patient type
            patientTypes.forEach(type => {
                groups.forEach(group => {
                    // Create data array for this group
                    const data = new Array(labels.length).fill(0);
                    
                    // Fill in data for this group
                    years.forEach((year, yearIndex) => {
                        const groupIndex = groups.indexOf(group);
                        const position = (groupIndex * years.length) + yearIndex;
                        
                        const entry = filteredData.find(row => 
                            row.grp === group && 
                            row.year === year && 
                            row.patient === type.id
                        );
                        
                        if (entry) {
                            data[position] = parseFloat(entry.number);
                        }
                    });
                    
                    datasets.push({
                        label: type.label,
                        data: data,
                        backgroundColor: type.color,
                        stack: group,
                        patientTypeId: type.id
                    });
                });
            });
            
            // Add note about proportion
            const note = document.createElement('p');
            note.textContent = 'Proportion of unmet needs patient';
            note.style.textAlign = 'center';
            note.style.fontWeight = 'bold';
            chartDiv.appendChild(note);
            
            // Create the chart
            const ctx = document.getElementById('treatedPatientsChart').getContext('2d');
            window.patientChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    
                    // Make bars thicker
                    barPercentage: 1.0,
                    categoryPercentage: 1.0,
                    
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 20,
                                padding: 10
                            }
                        },
                        
                        // Configure tooltips to only show data for the specific segment
                        tooltip: {
                            mode: 'point', // Only show data for the specific point being hovered
                            callbacks: {
                                title: function(tooltipItems) {
                                    const item = tooltipItems[0];
                                    const label = item.chart.data.labels[item.dataIndex];
                                    const yearMatch = label.match(/(\d{4})/);
                                    const groupMatch = label.match(/\((CR|M)\)/);
                                    
                                    if (yearMatch && groupMatch) {
                                        return `${yearMatch[1]} - ${groupMatch[1] === 'CR' ? 'CRPC Patients' : 'Metastatic Patients'}`;
                                    }
                                    return label;
                                },
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += `: ${context.raw}`;
                                    }
                                    return label;
                                }
                            }
                        },
                        
                        // Display prop_180 values on the "Not treated in 180 days" bars
                        datalabels: {
                            anchor: 'center',
                            align: 'center',
                            formatter: function(value, context) {
                                if (context.dataset.patientTypeId === 'diagnosis' && value > 0) {
                                    // Extract group and year from label
                                    const labelText = context.chart.data.labels[context.dataIndex];
                                    const groupMatch = labelText.match(/\((CR|M)\)/);
                                    const yearMatch = labelText.match(/(\d{4})/);
                                    
                                    if (groupMatch && yearMatch) {
                                        const group = groupMatch[1];
                                        const year = yearMatch[1];
                                        
                                        if (proportions[group] && proportions[group][year] !== undefined) {
                                            return `${(proportions[group][year] * 100).toFixed(1)}%`;
                                        }
                                    }
                                }
                                return ''; // Don't show labels for other segments
                            },
                            color: 'white',
                            font: {
                                weight: 'bold',
                                size: 12
                            },
                            display: function(context) {
                                return context.dataset.patientTypeId === 'diagnosis' && context.raw > 0;
                            }
                        }
                    },
                    
                    scales: {
                        x: {
                            stacked: true,
                            grid: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: 'Year',
                                font: {
                                    size: 14
                                }
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                callback: function(value, index) {
                                    // Only show the year part
                                    const label = this.getLabelForValue(index);
                                    if (label) {
                                        const yearMatch = label.match(/(\d{4})/);
                                        if (yearMatch) return yearMatch[1];
                                    }
                                    return '';
                                },
                                font: {
                                    size: 12
                                }
                            }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Patients',
                                font: {
                                    size: 14
                                }
                            },
                            ticks: {
                                font: {
                                    size: 12
                                }
                            }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
            
            // Draw dividing line between CR and M groups
            setTimeout(function() {
                try {
                    if (window.patientChart) {
                        const chart = window.patientChart;
                        const ctx = chart.ctx;
                        const xAxis = chart.scales.x;
                        const yAxis = chart.scales.y;
                        
                        if (ctx && xAxis && yAxis) {
                            ctx.save();
                            ctx.strokeStyle = '#ddd';
                            ctx.lineWidth = 1;
                            
                            const dividerIndex = years.length - 0.5;
                            const x = xAxis.getPixelForValue(dividerIndex);
                            ctx.beginPath();
                            ctx.moveTo(x, yAxis.top);
                            ctx.lineTo(x, yAxis.bottom);
                            ctx.stroke();
                            
                            ctx.restore();
                        }
                    }
                } catch (e) {
                    console.error("Error drawing divider line:", e);
                }
            }, 200);
        },
        error: function(error) {
            console.error("Error loading CSV:", error);
        }
    });
}

function zoomSankey() {
    const sankeyDiagram = document.getElementById('sankeyDiagram');
    if (sankeyDiagram) {
        sankeyDiagram.style.transform = 'scale(1.5)';
        sankeyDiagram.style.transformOrigin = 'center';
    }
}

function resetSankey() {
    const sankeyDiagram = document.getElementById('sankeyDiagram');
    if (sankeyDiagram) {
        sankeyDiagram.style.transform = 'scale(1)';
    }
}
</script>
</body>
</html>