<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Incidence and Incidence Rate</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/css/lightbox.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/js/lightbox-plus-jquery.min.js"></script>
    <script src="https://unpkg.com/patternomaly@1.3.2/dist/patternomaly.min.js"></script>
<style>
        body {
            font-family: Arial, sans-serif;
        }
        .tab {
            visibility: hidden;
            height: 0;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        .tab.active {
            visibility: visible;
            height: auto;
            opacity: 1;
        }
        .tab-button {
            padding: 10px;
            cursor: pointer;
            background-color: #f1f1f1;
            border: none;
            border-bottom: 2px solid transparent;
        }
        .tab-button.active {
            border-bottom: 2px solid blue;
            background-color: #e7e7e7;
        }
        #chart-container {
            width: 80%;
            margin: auto;
        }
        .button-container {
            text-align: center;
            margin: 20px;
        }
        button {
            margin: 5px;
        }
        button.active {
            background-color: #d3d3d3;
        }
        canvas {
            max-width: 800px;
            height:  400px;
            margin: auto;
        }
        .chart-wrapper {
            max-width: 800px;
            margin: 0 auto;
        }

        #kmChart {
            width: 800px;
            height: 400px;
            margin: auto;
            display: block;
        }
        #sankeyContainer {
            text-align: center;
            margin: 20px;
        }
        iframe {
            width: 100%;
            height: 600px; /* Adjust height as needed */
            border: none; /* Remove border */
        }
        
        /* Custom legend styles */
        .custom-legend {
            display: flex;
            flex-direction: column;
            justify-content: center;
            margin: 10px auto;
            max-width: 800px;
        }

        
        .legend-text {
            font-family: Arial, sans-serif; /* Change font family */
            font-size: 16px;               /* Change font size */
            font-weight: 530;              /* Control font weight (normal=400, bold=700) */
            color: #545151;                /* Change text color */
        }

        
        .legend-row {
            display: flex;
            justify-content: center;
            margin: 5px 0;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 0 10px;
            cursor: pointer;
        }
        
        .legend-item.hidden span.legend-text {
            text-decoration: line-through;
        }
        
        .legend-item.hidden .legend-color {
            opacity: 0.5;
        }
        
        .legend-color {
            display: inline-block;
            width: 15px;
            height: 15px;
            margin-right: 5px;
            border-radius: 2px;
        }
        
        .legend-dash {
            border-top-style: dashed;
            border-top-width: 2px;
        }
    </style>
</head>
<body>
<h2>Current and Forecasted Prostate Cancer Burden in Hong Kong</h2>
<div>
    <button class="tab-button active" onclick="openTab(event, 'incidence')">Incidence</button>
    <button class="tab-button" onclick="openTab(event, 'prevalence')">Prevalence</button>
    <button class="tab-button" onclick="openTab(event, 'chart-container')">Cost</button>
    <button class="tab-button" onclick="openTab(event, 'cohortData')">Unmet Needs</button>
    <button class="tab-button" onclick="openTab(event, 'kmChartContainer')">Survival Probability</button>
    <!--<button class="tab-button" onclick="openTab(event, 'sankeyContainer')">Treatment Pathway </button>-->

</div>

<div id="incidence" class="tab active">
    <h2>Prostate Cancer Incidence</h2>
    <div class="button-container">
        <button class="active" onclick="toggleChart('incidence', event)">Incident Cases</button>
        <button onclick="toggleChart('rate', event)">Incidence Rate</button>
    </div>
    <div id="incidenceChartContainer" class="chart-wrapper">
        <div id="incidenceLegend" class="custom-legend"></div>
        <canvas id="incidenceChart"></canvas>
    </div>
    <div id="rateChartContainer" class="chart-wrapper" >
        <div id="rateLegend" class="custom-legend"></div>
        <canvas id="rateChart"></canvas>
    </div>
</div>

<div id="prevalence" class="tab">
    <h2>Prostate Cancer Prevalence</h2>
    <div class="button-container">
        <button class="active" onclick="togglePrevalence('number', event)">Prevalent Cases</button>
        <button onclick="togglePrevalence('rate', event)">Prevalence Rate</button>
    </div>
    <div id="prevalenceNumberChartContainer" class="chart-wrapper">
        <div id="prevalenceNumberLegend" class="custom-legend"></div>
        <canvas id="prevalenceNumberChart"></canvas>
    </div>
    <div id="prevalenceRateChartContainer" class="chart-wrapper" >
        <div id="prevalenceRateLegend" class="custom-legend"></div>
        <canvas id="prevalenceRateChart"></canvas>
    </div>
</div>

<div id="chart-container" class="tab">
    <h2>One-year costs of care under Hospital Authority among prevalant patients</h2>
    <canvas id="myChart"></canvas>
    <!-- <div class="button-container">
        <button onclick="toggleData('ae')">Toggle AE Cost</button>
        <button onclick="toggleData('ip')">Toggle IP Cost</button>
        <button onclick="toggleData('op')">Toggle OP Cost</button>
    </div> -->
</div>

<div id="cohortData" class="tab">
    <h2>Proportion of Patients Not Treated by NHA/docetaxel in 180 Days in Each Year</h2>
    <div class="button-container">
        <button class="active" onclick="toggleUnmetNeeds('crpc', event)">CRPC Patients</button>
        <button onclick="toggleUnmetNeeds('metastatic', event)">Metastatic Patients</button>
    </div>
    <div id="crpcChartContainer" class="chart-wrapper">
        <canvas id="crpcChart"></canvas>
    </div>
    <div id="metastaticChartContainer" class="chart-wrapper">
        <canvas id="metastaticChart"></canvas>
    </div>
</div>

<div id="kmChartContainer" class="tab">
    <h2>Kaplan-Meier Survival Curves for Incident Cohort (2014 - 2022)</h2>
    <div class="controls">
        <!-- <div class="checkboxes">
            <label><input type="checkbox" value="cohort_2014" checked> Cohort 2014</label>
            <label><input type="checkbox" value="cohort_2015" checked> Cohort 2015</label>
            <label><input type="checkbox" value="cohort_2016" checked> Cohort 2016</label>
            <label><input type="checkbox" value="cohort_2017" checked> Cohort 2017</label>
            <label><input type="checkbox" value="cohort_2018" checked> Cohort 2018</label>
            <label><input type="checkbox" value="cohort_2019" checked> Cohort 2019</label>
            <label><input type="checkbox" value="cohort_2020" checked> Cohort 2020</label>
            <label><input type="checkbox" value="cohort_2021" checked> Cohort 2021</label>
            <label><input type="checkbox" value="cohort_2022" checked> Cohort 2022</label>
        </div>
        <button id="zoomButton">Zoom to 100%-90% Survival</button>
        <button id="resetButton">Reset Zoom</button>-->
    </div>
    <svg id="chart" width="800" height="400"></svg>
</div>

<!--<div id="sankeyContainer" class="tab">
  <h2>Treatment Pathway of 2000 - 2022 cohort</h2>
  <iframe src="Sankey Plot.html" title="Embedded HTML"></iframe>
</div>-->

<script>
let myChart;
let incidenceChartObj;
let rateChartObj;
let prevalenceNumberChart;
let prevalenceRateChart;
let crpcChart;
let metastaticChart;
let years = [];
let filteredYears = []; // Years from 2014 onwards
let yearStartIndex = 0; // Index where 2014 starts

// Cost data variables
let costYears = [];
let historicalYears = [];
let forecastYears = [];
let historicalAE = [];
let historicalIP = [];
let historicalOP = [];
let forecastAE = [];
let forecastIP = [];
let forecastOP = [];

// Historical prevalence data
let num_unique_prev = [];
let num_less65_prev = [];  // Changed from less60 to less65
let num_65to79_prev = [];  // Changed from 60to74 to 65to79
let num_80plus_prev = []; // Changed from 75plus to 80plus
let Age_Standardized_Prevalence = [];
let age_standardized_prev_less65 = []; // Changed from less60 to less65
let age_standardized_prev_65to79 = []; // Changed from 60to74 to 65to79
let age_standardized_prev_80plus = []; // Changed from 75plus to 80plus

// Filtered prevalence data (2014 onwards)
let filtered_num_unique_prev = [];
let filtered_num_less65_prev = [];  // Changed from less60 to less65
let filtered_num_65to79_prev = [];  // Changed from 60to74 to 65to79
let filtered_num_80plus_prev = []; // Changed from 75plus to 80plus
let filtered_Age_Standardized_Prevalence = [];
let filtered_age_standardized_prev_less65 = []; // Changed from less60 to less65
let filtered_age_standardized_prev_65to79 = []; // Changed from 60to74 to 65to79
let filtered_age_standardized_prev_80plus = []; // Changed from 75plus to 80plus

// Historical incidence data
let num_inci = []; 
let num_less65_inci = []; // Changed from less60 to less65
let num_65to79_inci = []; // Changed from 60to74 to 65to79
let num_80plus_inci = []; // Changed from 75plus to 80plus
let incidence_rate = [];
let less65_incidence_rate = []; // Changed from less60 to less65
let age65to79_incidence_rate = []; // Changed from 60to74 to 65to79
let plus80_incidence_rate = []; // Changed from plus75 to plus80

// Filtered incidence data (2014 onwards)
let filtered_num_inci = [];
let filtered_num_less65_inci = []; // Changed from less60 to less65
let filtered_num_65to79_inci = []; // Changed from 60to74 to 65to79
let filtered_num_80plus_inci = []; // Changed from 75plus to 80plus
let filtered_incidence_rate = [];
let filtered_less65_incidence_rate = []; // Changed from less60 to less65
let filtered_age65to79_incidence_rate = []; // Changed from 60to74 to 65to79
let filtered_plus80_incidence_rate = []; // Changed from plus75 to plus80

// Incidence forecast data
let inciForecastYears = [];
let num_inci_forecast = [];
let less65_inci_forecast = []; // Changed from less60 to less65
let age65to79_inci_forecast = []; // Changed from 60to74 to 65to79
let plus80_inci_forecast = []; // Changed from plus75 to plus80
let incidence_rate_forecast = [];
let less65_incidence_rate_forecast = []; // Changed from less60 to less65
let age65to79_incidence_rate_forecast = []; // Changed from 60to74 to 65to79
let plus80_incidence_rate_forecast = []; // Changed from plus75 to plus80

// Incidence prediction intervals
let num_inci_lower = [];
let num_inci_upper = [];
let less65_inci_lower = []; // Changed from less60 to less65
let less65_inci_upper = []; // Changed from less60 to less65
let age65to79_inci_lower = []; // Changed from 60to74 to 65to79
let age65to79_inci_upper = []; // Changed from 60to74 to 65to79
let plus80_inci_lower = []; // Changed from plus75 to plus80
let plus80_inci_upper = []; // Changed from plus75 to plus80
let incidence_rate_lower = [];
let incidence_rate_upper = [];
let less65_incidence_rate_lower = []; // Changed from less60 to less65
let less65_incidence_rate_upper = []; // Changed from less60 to less65
let age65to79_incidence_rate_lower = []; // Changed from 60to74 to 65to79
let age65to79_incidence_rate_upper = []; // Changed from 60to74 to 65to79
let plus80_incidence_rate_lower = []; // Changed from plus75 to plus80
let plus80_incidence_rate_upper = []; // Changed from plus75 to plus80

// Prevalence forecast data variables
let prevForecastYears = [];
let totalPrevForecast = [];
let less65PrevForecast = []; // Changed from less60 to less65
let age65to79PrevForecast = []; // Changed from 60to74 to 65to79
let plus80PrevForecast = []; // Changed from plus75 to plus80
let totalPrevRateForecast = [];
let less65PrevRateForecast = []; // Changed from less60 to less65
let age65to79PrevRateForecast = []; // Changed from 60to74 to 65to79
let plus80PrevRateForecast = []; // Changed from plus75 to plus80

// Prevalence prediction intervals
let totalPrevLower = [];
let totalPrevUpper = [];
let less65PrevLower = []; // Changed from less60 to less65
let less65PrevUpper = []; // Changed from less60 to less65
let age65to79PrevLower = []; // Changed from 60to74 to 65to79
let age65to79PrevUpper = []; // Changed from 60to74 to 65to79
let plus80PrevLower = []; // Changed from plus75 to plus80
let plus80PrevUpper = []; // Changed from plus75 to plus80
let totalPrevRateLower = [];
let totalPrevRateUpper = [];
let less65PrevRateLower = []; // Changed from less60 to less65
let less65PrevRateUpper = []; // Changed from less60 to less65
let age65to79PrevRateLower = []; // Changed from 60to74 to 65to79
let age65to79PrevRateUpper = []; // Changed from 60to74 to 65to79
let plus80PrevRateLower = []; // Changed from plus75 to plus80
let plus80PrevRateUpper = []; // Changed from plus75 to plus80

let lastHistoricalYear = 0;
let combinedYears = [];

// Variables to track visibility of forecast series - all default to false

let forecastVisible = {
    total: true,
    less65: true, // Changed from less60 to less65
    age65to79: true, // Changed from age60to74 to age65to79
    plus80: true // Changed from plus75 to plus80
};

// Similar tracker for prevalence forecast visibility
let prevForecastVisible = {
    total: true,
    less65: true, // Changed from less60 to less65
    age65to79: true, // Changed from age60to74 to age65to79
    plus80: true // Changed from plus75 to plus80
};

function openTab(evt, tabName) {
    const tabs = document.getElementsByClassName("tab");
    const buttons = document.getElementsByClassName("tab-button");

    for (let i = 0; i < tabs.length; i++) {
        tabs[i].classList.remove('active');
    }
    for (let i = 0; i < buttons.length; i++) {
        buttons[i].classList.remove("active");
    }

    document.getElementById(tabName).classList.add('active');
    evt.currentTarget.classList.add("active");
}

function toggleChart(type, evt) {
    const incidenceChartContainer = document.getElementById('incidenceChartContainer');
    const rateChartContainer = document.getElementById('rateChartContainer');

    if (type === 'incidence') {
        incidenceChartContainer.style.display = 'block';
        rateChartContainer.style.display = 'none';
    } else {
        incidenceChartContainer.style.display = 'none';
        rateChartContainer.style.display = 'block';
    }

    // Set the active button
    if (evt) {
        const buttons = document.querySelectorAll('#incidence .button-container button');
        buttons.forEach(button => {
            button.classList.remove('active');
        });
        evt.currentTarget.classList.add('active');
    } else {
        // If called programmatically, activate the first button for incidence
        const buttons = document.querySelectorAll('#incidence .button-container button');
        buttons.forEach((button, index) => {
            if ((type === 'incidence' && index === 0) || (type === 'rate' && index === 1)) {
                button.classList.add('active');
            } else {
                button.classList.remove('active');
            }
        });
    }
}

function togglePrevalence(type, evt) {
    const prevalenceNumberChartContainer = document.getElementById('prevalenceNumberChartContainer');
    const prevalenceRateChartContainer = document.getElementById('prevalenceRateChartContainer');

    if (type === 'number') {
        prevalenceNumberChartContainer.style.display = 'block';
        prevalenceRateChartContainer.style.display = 'none';
    } else {
        prevalenceNumberChartContainer.style.display = 'none';
        prevalenceRateChartContainer.style.display = 'block';
    }

    // Set the active button
    if (evt) {
        const buttons = document.querySelectorAll('#prevalence .button-container button');
        buttons.forEach(button => {
            button.classList.remove('active');
        });
        evt.currentTarget.classList.add('active');
    } else {
        // If called programmatically, activate the first button for number
        const buttons = document.querySelectorAll('#prevalence .button-container button');
        buttons.forEach((button, index) => {
            if ((type === 'number' && index === 0) || (type === 'rate' && index === 1)) {
                button.classList.add('active');
            } else {
                button.classList.remove('active');
            }
        });
    }
}

function toggleUnmetNeeds(type, evt) {
    const crpcChartContainer = document.getElementById('crpcChartContainer');
    const metastaticChartContainer = document.getElementById('metastaticChartContainer');
    const proportionNote = document.getElementById('proportion-note');

    if (type === 'crpc') {
        crpcChartContainer.style.display = 'block';
        metastaticChartContainer.style.display = 'none';
        
        // Update note text for CRPC
        if (proportionNote) {
            proportionNote.textContent = '% Proportion of CRPC patients not treated by NHA/docetaxel in 180 Days in the yearly prostate cancer cohort';
        }
    } else {
        crpcChartContainer.style.display = 'none';
        metastaticChartContainer.style.display = 'block';
        
        // Update note text for Metastatic
        if (proportionNote) {
            proportionNote.textContent = '% Proportion of metastatic patients not treated by NHA/docetaxel in 180 Days in the yearly prostate cancer cohort';
        }
    }

    // Set the active button
    if (evt) {
        const buttons = document.querySelectorAll('#cohortData .button-container button');
        buttons.forEach(button => {
            button.classList.remove('active');
        });
        evt.currentTarget.classList.add('active');
    } else {
        // If called programmatically, activate the first button for CRPC
        const buttons = document.querySelectorAll('#cohortData .button-container button');
        buttons.forEach((button, index) => {
            if ((type === 'crpc' && index === 0) || (type === 'metastatic' && index === 1)) {
                button.classList.add('active');
            } else {
                button.classList.remove('active');
            }
        });
    }
}

function adjustChartAxis(chart) {
    // Check if all forecast series are hidden
    const allForecastHidden = !forecastVisible.total && !forecastVisible.less65 && 
                             !forecastVisible.age65to79 && !forecastVisible.plus80;

    if (allForecastHidden) {
        // Set x-axis max to only show historical years (up to 2022)
        chart.options.scales.x.max = filteredYears.length - 1;
    } else {
        // Show full range including forecast years
        chart.options.scales.x.max = undefined;
    }
    
    chart.update();
}

function adjustPrevalenceChartAxis(chart) {
    // Check if all forecast series are hidden
    const allForecastHidden = !prevForecastVisible.total && !prevForecastVisible.less65 && 
                             !prevForecastVisible.age65to79 && !prevForecastVisible.plus80;

    if (allForecastHidden) {
        // Set x-axis max to only show historical years (up to 2022)
        chart.options.scales.x.max = filteredYears.length - 1;
    } else {
        // Show full range including forecast years
        chart.options.scales.x.max = undefined;
    }
    
    chart.update();
}

// Function to create a custom HTML legend
function createCustomLegend(chart, legendElementId, isRate = false) {
    const legendElement = document.getElementById(legendElementId);
    legendElement.innerHTML = '';
    
    // Create first row for historical data
    const historicalRow = document.createElement('div');
    historicalRow.className = 'legend-row';
    
    // Create second row for forecast data
    const forecastRow = document.createElement('div');
    forecastRow.className = 'legend-row';
    
    // Historical data items
    const historicalItems = [
        {
            label: 'Total',
            color: '#fb8500',
            datasetIndex: 0,
            dash: false
        },
        {
            label: 'Less than 65', // Changed from 'Less than 60'
            color: '#023047',
            datasetIndex: 1,
            dash: false
        },
        {
            label: '65-79', // Changed from '60-74'
            color: '#219ebc',
            datasetIndex: 2,
            dash: false
        },
        {
            label: '80+', // Changed from '75+'
            color: '#8ecae6',
            datasetIndex: 3,
            dash: false
        }
    ];
    
    // Forecast data items
    const forecastItems = [
        {
            label: 'Total (Forecast)',
            color: '#ff0000',
            datasetIndex: isRate ? 5 : 5,
            dash: true
        },
        {
            label: 'Less than 65 (Forecast)', // Changed from 'Less than 60 (Forecast)'
            color: '#023047',
            datasetIndex: isRate ? 8 : 8,
            dash: true
        },
        {
            label: '65-79 (Forecast)', // Changed from '60-74 (Forecast)'
            color: '#219ebc',
            datasetIndex: isRate ? 11 : 11,
            dash: true
        },
        {
            label: '80+ (Forecast)', // Changed from '75+ (Forecast)'
            color: '#8ecae6',
            datasetIndex: isRate ? 14 : 14, 
            dash: true
        }
    ];
    
    // Add historical items to the first row
    historicalItems.forEach(item => {
        const legendItem = document.createElement('div');
        legendItem.className = 'legend-item';
        legendItem.dataset.index = item.datasetIndex;
        
        const meta = chart.getDatasetMeta(item.datasetIndex);
        if (meta.hidden) {
            legendItem.classList.add('hidden');
        }
        
        const colorSpan = document.createElement('span');
        colorSpan.className = 'legend-color';
        colorSpan.style.backgroundColor = item.color;
        if (item.dash) {
            colorSpan.classList.add('legend-dash');
            colorSpan.style.borderTopColor = item.color;
        }
        
        const textSpan = document.createElement('span');
        textSpan.className = 'legend-text';
        textSpan.textContent = item.label;
        
        legendItem.appendChild(colorSpan);
        legendItem.appendChild(textSpan);
        
        // Add click event handler
        legendItem.addEventListener('click', () => {
            const index = parseInt(legendItem.dataset.index);
            const meta = chart.getDatasetMeta(index);
            
            // Toggle visibility
            meta.hidden = !meta.hidden;
            
            // Update class to reflect hidden state
            if (meta.hidden) {
                legendItem.classList.add('hidden');
            } else {
                legendItem.classList.remove('hidden');
            }
            
            // Update chart
            chart.update();
        });
        
        historicalRow.appendChild(legendItem);
    });
    
    // Add forecast items to the second row
    forecastItems.forEach(item => {
        const legendItem = document.createElement('div');
        legendItem.className = 'legend-item';
        // Always add the 'hidden' class initially for forecast items
        const meta = chart.getDatasetMeta(item.datasetIndex);
        if (meta.hidden) {
            legendItem.classList.add('hidden');
        }
        legendItem.dataset.index = item.datasetIndex;
        
        const colorSpan = document.createElement('span');
        colorSpan.className = 'legend-color';
        colorSpan.style.backgroundColor = item.color;
        if (item.dash) {
            colorSpan.classList.add('legend-dash');
            colorSpan.style.borderTopColor = item.color;
        }
        
        const textSpan = document.createElement('span');
        textSpan.className = 'legend-text';
        textSpan.textContent = item.label;
        
        legendItem.appendChild(colorSpan);
        legendItem.appendChild(textSpan);
        
        // Add click event handler for forecast items
        legendItem.addEventListener('click', () => {
            const index = parseInt(legendItem.dataset.index);
            const meta = chart.getDatasetMeta(index);
            
            // Check if the legend item has the 'hidden' class (i.e., it's currently showing as strikethrough)
            const isCurrentlyHidden = legendItem.classList.contains('hidden');
            
            // Update the dataset visibility based on the current visual state
            meta.hidden = !isCurrentlyHidden;
            
            // Update class to reflect the new state
            if (isCurrentlyHidden) {
                // If it was hidden (strikethrough), remove that class to show it
                legendItem.classList.remove('hidden');
            } else {
                // If it was showing, add the hidden class to hide it
                legendItem.classList.add('hidden');
            }
            
            // Track forecast visibility directly based on the new visual state
            const label = chart.data.datasets[index].label;
            
            if (label === 'Total (Forecast)') {
                if (legendElementId.includes('prevalence')) {
                    prevForecastVisible.total = isCurrentlyHidden; // True if we're making it visible
                    
                    // Also toggle prediction intervals to match
                    const lowerIndex = isRate ? 4 : 4;
                    const upperIndex = isRate ? 6 : 6;
                    
                    chart.getDatasetMeta(lowerIndex).hidden = !isCurrentlyHidden;
                    chart.getDatasetMeta(upperIndex).hidden = !isCurrentlyHidden;
                } else {
                    forecastVisible.total = isCurrentlyHidden; // True if we're making it visible
                    
                    // Also toggle prediction intervals to match
                    const lowerIndex = isRate ? 4 : 4;
                    const upperIndex = isRate ? 6 : 6;
                    
                    chart.getDatasetMeta(lowerIndex).hidden = !isCurrentlyHidden;
                    chart.getDatasetMeta(upperIndex).hidden = !isCurrentlyHidden;
                }
            } else if (label === 'Less than 65 (Forecast)') { // Changed from 'Less than 60 (Forecast)'
                if (legendElementId.includes('prevalence')) {
                    prevForecastVisible.less65 = isCurrentlyHidden; // Changed from less60
                    
                    // Also toggle prediction intervals
                    const lowerIndex = isRate ? 7 : 7;
                    const upperIndex = isRate ? 9 : 9;
                    
                    chart.getDatasetMeta(lowerIndex).hidden = !isCurrentlyHidden;
                    chart.getDatasetMeta(upperIndex).hidden = !isCurrentlyHidden;
                } else {
                    forecastVisible.less65 = isCurrentlyHidden; // Changed from less60
                    
                    // Also toggle prediction intervals
                    const lowerIndex = isRate ? 7 : 7;
                    const upperIndex = isRate ? 9 : 9;
                    
                    chart.getDatasetMeta(lowerIndex).hidden = !isCurrentlyHidden;
                    chart.getDatasetMeta(upperIndex).hidden = !isCurrentlyHidden;
                }
            } else if (label === '65-79 (Forecast)') { // Changed from '60-74 (Forecast)'
                if (legendElementId.includes('prevalence')) {
                    prevForecastVisible.age65to79 = isCurrentlyHidden; // Changed from age60to74
                    
                    // Toggle prediction intervals for 65-79
                    const lowerIndex = isRate ? 10 : 10;
                    const upperIndex = isRate ? 12 : 12;
                    
                    chart.getDatasetMeta(lowerIndex).hidden = !isCurrentlyHidden;
                    chart.getDatasetMeta(upperIndex).hidden = !isCurrentlyHidden;
                } else {
                    forecastVisible.age65to79 = isCurrentlyHidden; // Changed from age60to74
                    
                    // Also toggle prediction intervals
                    const lowerIndex = isRate ? 10 : 10;
                    const upperIndex = isRate ? 12 : 12;
                    
                    chart.getDatasetMeta(lowerIndex).hidden = !isCurrentlyHidden;
                    chart.getDatasetMeta(upperIndex).hidden = !isCurrentlyHidden;
                }
            } else if (label === '80+ (Forecast)') { // Changed from '75+ (Forecast)'
                if (legendElementId.includes('prevalence')) {
                    prevForecastVisible.plus80 = isCurrentlyHidden; // Changed from plus75
                    
                    // Also toggle prediction intervals
                    const lowerIndex = isRate ? 13 : 13;
                    const upperIndex = isRate ? 15 : 15;
                    
                    chart.getDatasetMeta(lowerIndex).hidden = !isCurrentlyHidden;
                    chart.getDatasetMeta(upperIndex).hidden = !isCurrentlyHidden;
                } else {
                    forecastVisible.plus80 = isCurrentlyHidden; // Changed from plus75
                    
                    // Also toggle prediction intervals
                    const lowerIndex = isRate ? 13 : 13;
                    const upperIndex = isRate ? 15 : 15;
                    
                    chart.getDatasetMeta(lowerIndex).hidden = !isCurrentlyHidden;
                    chart.getDatasetMeta(upperIndex).hidden = !isCurrentlyHidden;
                }
            }
            
            // Update chart
            chart.update();
            
            // Adjust x-axis if needed
            if (legendElementId.includes('prevalence')) {
                adjustPrevalenceChartAxis(chart);
            } else {
                adjustChartAxis(chart);
            }
        });
        
        forecastRow.appendChild(legendItem);
    });
    
    // Add rows to legend element
    legendElement.appendChild(historicalRow);
    legendElement.appendChild(forecastRow);
}

function updateIncidenceCharts() {
    // Get chart contexts
    const ctx1 = document.getElementById('incidenceChart').getContext('2d');
    const ctx2 = document.getElementById('rateChart').getContext('2d');
    
    // Create combined data arrays
    const totalCasesData = [];
    const less65CasesData = []; // Changed from less60 to less65
    const age65to79CasesData = []; // Changed from age60to74 to age65to79
    const plus80CasesData = []; // Changed from plus75 to plus80
    
    const totalCasesForecastData = [];
    const less65CasesForecastData = []; // Changed from less60 to less65
    const age65to79CasesForecastData = []; // Changed from age60to74 to age65to79
    const plus80CasesForecastData = []; // Changed from plus75 to plus80
    
    // Prepare data for prediction intervals
    const totalCasesLowerData = [];
    const totalCasesUpperData = [];
    const less65CasesLowerData = []; // Changed from less60 to less65
    const less65CasesUpperData = []; // Changed from less60 to less65
    const age65to79CasesLowerData = []; // Changed from age60to74 to age65to79
    const age65to79CasesUpperData = []; // Changed from age60to74 to age65to79
    const plus80CasesLowerData = []; // Changed from plus75 to plus80
    const plus80CasesUpperData = []; // Changed from plus75 to plus80
    
    // Fill historical data arrays (use filtered data from 2014 onwards)
    for (let i = 0; i < filteredYears.length; i++) {
        totalCasesData.push(filtered_num_inci[i]);
        less65CasesData.push(filtered_num_less65_inci[i]); // Changed from less60 to less65
        age65to79CasesData.push(filtered_num_65to79_inci[i]); // Changed from 60to74 to 65to79
        plus80CasesData.push(filtered_num_80plus_inci[i]); // Changed from 75plus to 80plus
        
        // Add null placeholders for forecast in historical period
        if (i < filteredYears.length - 1) { // All except last point (2022)
            totalCasesForecastData.push(null);
            less65CasesForecastData.push(null); // Changed from less60 to less65
            age65to79CasesForecastData.push(null); // Changed from age60to74 to age65to79
            plus80CasesForecastData.push(null); // Changed from plus75 to plus80
            
            totalCasesLowerData.push(null);
            totalCasesUpperData.push(null);
            less65CasesLowerData.push(null); // Changed from less60 to less65
            less65CasesUpperData.push(null); // Changed from less60 to less65
            age65to79CasesLowerData.push(null); // Changed from age60to74 to age65to79
            age65to79CasesUpperData.push(null); // Changed from age60to74 to age65to79
            plus80CasesLowerData.push(null); // Changed from plus75 to plus80
            plus80CasesUpperData.push(null); // Changed from plus75 to plus80
        } else { // 2022 point (shared between historical and forecast)
            totalCasesForecastData.push(num_inci_forecast[0]);
            less65CasesForecastData.push(less65_inci_forecast[0]); // Changed from less60 to less65
            age65to79CasesForecastData.push(age65to79_inci_forecast[0]); // Changed from 60to74 to 65to79
            plus80CasesForecastData.push(plus80_inci_forecast[0]); // Changed from plus75 to plus80
            
            totalCasesLowerData.push(num_inci_lower[0]);
            totalCasesUpperData.push(num_inci_upper[0]);
            less65CasesLowerData.push(less65_inci_lower[0]); // Changed from less60 to less65
            less65CasesUpperData.push(less65_inci_upper[0]); // Changed from less60 to less65
            age65to79CasesLowerData.push(age65to79_inci_lower[0]); // Changed from age60to74 to age65to79
            age65to79CasesUpperData.push(age65to79_inci_upper[0]); // Changed from age60to74 to age65to79
            plus80CasesLowerData.push(plus80_inci_lower[0]); // Changed from plus75 to plus80
            plus80CasesUpperData.push(plus80_inci_upper[0]); // Changed from plus75 to plus80
        }
    }
    
    // Add forecast data for 2023-2032
    for (let i = 1; i < inciForecastYears.length; i++) { // Skip first (2022)
        // Add null placeholders for historical in forecast period
        totalCasesData.push(null);
        less65CasesData.push(null); // Changed from less60 to less65
        age65to79CasesData.push(null); // Changed from age60to74 to age65to79
        plus80CasesData.push(null); // Changed from plus75 to plus80
        
        // Add forecast data points
        totalCasesForecastData.push(num_inci_forecast[i]);
        less65CasesForecastData.push(less65_inci_forecast[i]); // Changed from less60 to less65
        age65to79CasesForecastData.push(age65to79_inci_forecast[i]); // Changed from age60to74 to age65to79
        plus80CasesForecastData.push(plus80_inci_forecast[i]); // Changed from plus75 to plus80
        
        // Add prediction intervals
        totalCasesLowerData.push(num_inci_lower[i]);
        totalCasesUpperData.push(num_inci_upper[i]);
        less65CasesLowerData.push(less65_inci_lower[i]); // Changed from less60 to less65
        less65CasesUpperData.push(less65_inci_upper[i]); // Changed from less60 to less65
        age65to79CasesLowerData.push(age65to79_inci_lower[i]); // Changed from age60to74 to age65to79
        age65to79CasesUpperData.push(age65to79_inci_upper[i]); // Changed from age60to74 to age65to79
        plus80CasesLowerData.push(plus80_inci_lower[i]); // Changed from plus75 to plus80
        plus80CasesUpperData.push(plus80_inci_upper[i]); // Changed from plus75 to plus80
    }
    
    // Create combined years array - start with filtered years (2014 onwards)
    const allYears = [...filteredYears]; 
    
    // Add forecast years (excluding the first which is already included)
    for (let i = 1; i < inciForecastYears.length; i++) {
        allYears.push(inciForecastYears[i]);
    }
    
    // Clean up any existing charts
    if (incidenceChartObj) {
        incidenceChartObj.destroy();
    }
    
    // Create new incidence chart
    incidenceChartObj = new Chart(ctx1, {
        type: 'line',
        data: {
            labels: allYears,
            datasets: [
                // Total Cases - Historical
                {
                    label: 'Total',
                    data: totalCasesData,
                    borderColor: '#fb8500',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 3,
                    pointBackgroundColor: '#fb8500'
                },
                // Less than 65 Cases - Historical - Changed from 'Less than 60'
                {
                    label: 'Less than 65',
                    data: less65CasesData,
                    borderColor: '#023047',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 3,
                    pointBackgroundColor: '#023047'
                },
                // 65-79 Cases - Historical - Changed from '60-74'
                {
                    label: '65-79',
                    data: age65to79CasesData,
                    borderColor: '#219ebc',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 3,
                    pointBackgroundColor: '#219ebc'
                },
                // 80+ Cases - Historical - Changed from '75+'
                {
                    label: '80+',
                    data: plus80CasesData,
                    borderColor: '#8ecae6',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 3,
                    pointBackgroundColor: '#8ecae6'
                },
                // Total Cases - Lower Confidence Interval
                {
                    label: 'Total Lower PI',
                    data: totalCasesLowerData,
                    borderColor: 'rgba(255, 0, 0, 0.2)',
                    backgroundColor: 'rgba(255, 0, 0, 0.2)',
                    fill: '+2', // Fill to dataset with index +2 (the upper interval)
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 0,
                    //hidden: true // Start hidden
                },
                // Total Cases - Forecast
                {
                    label: 'Total (Forecast)',
                    data: totalCasesForecastData,
                    borderColor: '#fb8500', 
                    fill: false,
                    tension: 0.1,
                    borderDash: [5, 5],
                    pointRadius: 3,
                    pointBackgroundColor: '#fb8500',
                    //hidden: true // Start hidden
                },
                // Total Cases - Upper Confidence Interval
                {
                    label: 'Total Upper PI',
                    data: totalCasesUpperData,
                    borderColor: 'rgba(255, 0, 0, 0)',
                    backgroundColor: 'rgba(255, 0, 0, 0)',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 0,
                    //hidden: true // Start hidden
                },
                // Less than 65 Cases - Lower Confidence Interval - Changed from 'Less than 60'
                {
                    label: 'Less than 65 Lower PI',
                    data: less65CasesLowerData,
                    borderColor: 'rgba(0, 0, 255, 0.2)',
                    backgroundColor: 'rgba(0, 0, 255, 0.2)',
                    fill: '+2', // Fill to dataset with index +2 (the upper interval)
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 0,
                    //hidden: true // Start hidden
                },
                // Less than 65 Cases - Forecast - Changed from 'Less than 60'
                {
                    label: 'Less than 65 (Forecast)',
                    data: less65CasesForecastData,
                    borderColor: '#023047',
                    fill: false,
                    tension: 0.1,
                    borderDash: [5, 5],
                    pointRadius: 3,
                    pointBackgroundColor: '#023047',
                    //hidden: true // Start hidden
                },
                // Less than 65 Cases - Upper Confidence Interval - Changed from 'Less than 60'
                {
                    label: 'Less than 65 Upper PI',
                    data: less65CasesUpperData,
                    borderColor: 'rgba(0, 0, 255, 0)',
                    backgroundColor: 'rgba(0, 0, 255, 0)',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 0,
                    //hidden: true // Start hidden
                },
                // 65-79 Cases - Lower Confidence Interval - Changed from '60-74'
                {
                    label: '65-79 Lower PI',
                    data: age65to79CasesLowerData,
                    borderColor: 'rgba(33, 158, 188, 0.2)',
                    backgroundColor: 'rgba(33, 158, 188, 0.2)',
                    fill: '+2', // Fill to dataset with index +2 (the upper interval)
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 0,
                    //hidden: true // Start hidden
                },
                // 65-79 Cases - Forecast - Changed from '60-74'
                {
                    label: '65-79 (Forecast)',
                    data: age65to79CasesForecastData,
                    borderColor: '#219ebc',
                    fill: false,
                    tension: 0.1,
                    borderDash: [5, 5],
                    pointRadius: 3,
                    pointBackgroundColor: '#219ebc',
                    //hidden: true // Start hidden
                },
                // 65-79 Cases - Upper Confidence Interval - Changed from '60-74'
                {
                    label: '65-79 Upper PI',
                    data: age65to79CasesUpperData,
                    borderColor: 'rgba(33, 158, 188, 0)',
                    backgroundColor: 'rgba(33, 158, 188, 0)',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 0,
                    //hidden: true // Start hidden
                },
                // 80+ Cases - Lower Confidence Interval - Changed from '75+'
                {
                    label: '80+ Lower PI',
                    data: plus80CasesLowerData,
                    borderColor: 'rgba(255, 105, 180, 0.2)',
                    backgroundColor: 'rgba(255, 105, 180, 0.2)',
                    fill: '+2', // Fill to dataset with index +2 (the upper interval)
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 0,
                    //hidden: true // Start hidden
                },
                // 80+ Cases - Forecast - Changed from '75+'
                {
                    label: '80+ (Forecast)',
                    data: plus80CasesForecastData,
                    borderColor: '#8ecae6',
                    fill: false,
                    tension: 0.1,
                    borderDash: [5, 5],
                    pointRadius: 3,
                    pointBackgroundColor: '#8ecae6',
                    //hidden: true // Start hidden
                },
                // 80+ Cases - Upper Confidence Interval - Changed from '75+'
                {
                    label: '80+ Upper PI',
                    data: plus80CasesUpperData,
                    borderColor: 'rgba(255, 105, 180, 0)',
                    backgroundColor: 'rgba(255, 105, 180, 0)',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 0,
                    //hidden: true // Start hidden
                }
            ]
        },
        options: {
            plugins: {
                legend: {
                    display: false // Disable built-in legend
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.dataset.label || '';
                            if (label.includes('PI')) return null;
                            
                            const value = context.parsed.y || 0;
                            
                            // For forecast points, add prediction interval to tooltip
                            if (label.includes('Forecast') && value) {
                                let lowerValue, upperValue;
                                
                                if (label.includes('Total')) {
                                    // Find the indices for the prediction intervals
                                    const lowerPIIndex = context.chart.data.datasets.findIndex(ds => ds.label === 'Total Lower PI');
                                    const upperPIIndex = context.chart.data.datasets.findIndex(ds => ds.label === 'Total Upper PI');
                                    
                                    if (lowerPIIndex !== -1 && upperPIIndex !== -1) {
                                        lowerValue = context.chart.data.datasets[lowerPIIndex].data[context.dataIndex];
                                        upperValue = context.chart.data.datasets[upperPIIndex].data[context.dataIndex];
                                    }
                                } else if (label.includes('Less than 65')) { // Changed from 'Less than 60'
                                    const lowerPIIndex = context.chart.data.datasets.findIndex(ds => ds.label === 'Less than 65 Lower PI');
                                    const upperPIIndex = context.chart.data.datasets.findIndex(ds => ds.label === 'Less than 65 Upper PI');
                                    
                                    if (lowerPIIndex !== -1 && upperPIIndex !== -1) {
                                        lowerValue = context.chart.data.datasets[lowerPIIndex].data[context.dataIndex];
                                        upperValue = context.chart.data.datasets[upperPIIndex].data[context.dataIndex];
                                    }
                                } else if (label.includes('65-79')) { // Changed from '60-74'
                                    const lowerPIIndex = context.chart.data.datasets.findIndex(ds => ds.label === '65-79 Lower PI');
                                    const upperPIIndex = context.chart.data.datasets.findIndex(ds => ds.label === '65-79 Upper PI');
                                    
                                    if (lowerPIIndex !== -1 && upperPIIndex !== -1) {
                                        lowerValue = context.chart.data.datasets[lowerPIIndex].data[context.dataIndex];
                                        upperValue = context.chart.data.datasets[upperPIIndex].data[context.dataIndex];
                                    }
                                } else if (label.includes('80+')) { // Changed from '75+'
                                    const lowerPIIndex = context.chart.data.datasets.findIndex(ds => ds.label === '80+ Lower PI');
                                    const upperPIIndex = context.chart.data.datasets.findIndex(ds => ds.label === '80+ Upper PI');
                                    
                                    if (lowerPIIndex !== -1 && upperPIIndex !== -1) {
                                        lowerValue = context.chart.data.datasets[lowerPIIndex].data[context.dataIndex];
                                        upperValue = context.chart.data.datasets[upperPIIndex].data[context.dataIndex];
                                    }
                                }
                                
                                if (lowerValue && upperValue) {
                                    return [
                                        `${label}: ${Math.round(value)}`,
                                        `95% PI: [${Math.round(lowerValue)}, ${Math.round(upperValue)}]`
                                    ];
                                }
                            }
                            
                            return `${label}: ${Math.round(value)}`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Number of Incident Cases',
                        font: {
                            size: 16,           // Change font size here
                            family: 'Arial'     // Change font family here
                        },
                        color: '#333333'        // Change color here
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Year',
                        font: {
                            size: 16,           // Change font size here
                            family: 'Arial'     // Change font family here
                        },
                        color: '#333333'        // Change color here
                    },
                    //max: filteredYears.length - 1 // Initially show only historical years
                }
            }
        }
    });
    
    // Create custom legend for incidence chart
    createCustomLegend(incidenceChartObj, 'incidenceLegend', false);
    
    // Prepare data for rate chart
    const totalRateData = [];
    const less65RateData = []; // Changed from less60 to less65
    const age65to79RateData = []; // Changed from age60to74 to age65to79
    const plus80RateData = []; // Changed from plus75 to plus80
    
    const totalRateForecastData = [];
    const less65RateForecastData = []; // Changed from less60 to less65
    const age65to79RateForecastData = []; // Changed from age60to74 to age65to79
    const plus80RateForecastData = []; // Changed from plus75 to plus80
    
    // Prepare prediction intervals for rate chart
    const totalRateLowerData = [];
    const totalRateUpperData = [];
    const less65RateLowerData = []; // Changed from less60 to less65
    const less65RateUpperData = []; // Changed from less60 to less65
    const age65to79RateLowerData = []; // Changed from age60to74 to age65to79
    const age65to79RateUpperData = []; // Changed from age60to74 to age65to79
    const plus80RateLowerData = []; // Changed from plus75 to plus80
    const plus80RateUpperData = []; // Changed from plus75 to plus80
    
    // Fill historical data arrays - use filtered data from 2014 onwards
    for (let i = 0; i < filteredYears.length; i++) {
        totalRateData.push(filtered_incidence_rate[i]);
        less65RateData.push(filtered_less65_incidence_rate[i]); // Changed from less60 to less65
        age65to79RateData.push(filtered_age65to79_incidence_rate[i]); // Changed from age60to74 to age65to79
        plus80RateData.push(filtered_plus80_incidence_rate[i]); // Changed from plus75 to plus80
        
        // Add null placeholders for forecast in historical period
        if (i < filteredYears.length - 1) { // All except last point (2022)
            totalRateForecastData.push(null);
            less65RateForecastData.push(null); // Changed from less60 to less65
            age65to79RateForecastData.push(null); // Changed from age60to74 to age65to79
            plus80RateForecastData.push(null); // Changed from plus75 to plus80
            
            totalRateLowerData.push(null);
            totalRateUpperData.push(null);
            less65RateLowerData.push(null); // Changed from less60 to less65
            less65RateUpperData.push(null); // Changed from less60 to less65
            age65to79RateLowerData.push(null); // Changed from age60to74 to age65to79
            age65to79RateUpperData.push(null); // Changed from age60to74 to age65to79
            plus80RateLowerData.push(null); // Changed from plus75 to plus80
            plus80RateUpperData.push(null); // Changed from plus75 to plus80
        } else { // 2022 point (shared between historical and forecast)
            totalRateForecastData.push(incidence_rate_forecast[0]);
            less65RateForecastData.push(less65_incidence_rate_forecast[0]); // Changed from less60 to less65
            age65to79RateForecastData.push(age65to79_incidence_rate_forecast[0]); // Changed from age60to74 to age65to79
            plus80RateForecastData.push(plus80_incidence_rate_forecast[0]); // Changed from plus75 to plus80
            
            totalRateLowerData.push(incidence_rate_lower[0]);
            totalRateUpperData.push(incidence_rate_upper[0]);
            less65RateLowerData.push(less65_incidence_rate_lower[0]); // Changed from less60 to less65
            less65RateUpperData.push(less65_incidence_rate_upper[0]); // Changed from less60 to less65
            age65to79RateLowerData.push(age65to79_incidence_rate_lower[0]); // Changed from age60to74 to age65to79
            age65to79RateUpperData.push(age65to79_incidence_rate_upper[0]); // Changed from age60to74 to age65to79
            plus80RateLowerData.push(plus80_incidence_rate_lower[0]); // Changed from plus75 to plus80
            plus80RateUpperData.push(plus80_incidence_rate_upper[0]); // Changed from plus75 to plus80
        }
    }
    
    // Add forecast data for 2023-2032
    for (let i = 1; i < inciForecastYears.length; i++) { // Skip first (2022)
        // Add null placeholders for historical in forecast period
        totalRateData.push(null);
        less65RateData.push(null); // Changed from less60 to less65
        age65to79RateData.push(null); // Changed from age60to74 to age65to79
        plus80RateData.push(null); // Changed from plus75 to plus80
        
        // Add forecast data points
        totalRateForecastData.push(incidence_rate_forecast[i]);
        less65RateForecastData.push(less65_incidence_rate_forecast[i]); // Changed from less60 to less65
        age65to79RateForecastData.push(age65to79_incidence_rate_forecast[i]); // Changed from age60to74 to age65to79
        plus80RateForecastData.push(plus80_incidence_rate_forecast[i]); // Changed from plus75 to plus80
        
        // Add prediction intervals
        totalRateLowerData.push(incidence_rate_lower[i]);
        totalRateUpperData.push(incidence_rate_upper[i]);
        less65RateLowerData.push(less65_incidence_rate_lower[i]); // Changed from less60 to less65
        less65RateUpperData.push(less65_incidence_rate_upper[i]); // Changed from less60 to less65
        age65to79RateLowerData.push(age65to79_incidence_rate_lower[i]); // Changed from age60to74 to age65to79
        age65to79RateUpperData.push(age65to79_incidence_rate_upper[i]); // Changed from age60to74 to age65to79
        plus80RateLowerData.push(plus80_incidence_rate_lower[i]); // Changed from plus75 to plus80
        plus80RateUpperData.push(plus80_incidence_rate_upper[i]); // Changed from plus75 to plus80
    }
    
    // Clean up any existing rate chart
    if (rateChartObj) {
        rateChartObj.destroy();
    }
    
    // Create new rate chart
    rateChartObj = new Chart(ctx2, {
        type: 'line',
        data: {
            labels: allYears,
            datasets: [
                // Total Rate - Historical
                {
                    label: 'Total',
                    data: totalRateData,
                    borderColor: '#fb8500',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 3,
                    pointBackgroundColor: '#fb8500'
                },
                // Less than 65 Rate - Historical - Changed from 'Less than 60'
                {
                    label: 'Less than 65',
                    data: less65RateData,
                    borderColor: '#023047',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 3,
                    pointBackgroundColor: '#023047'
                },
                // 65-79 Rate - Historical - Changed from '60-74'
                {
                    label: '65-79',
                    data: age65to79RateData,
                    borderColor: '#219ebc',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 3,
                    pointBackgroundColor: '#219ebc'
                },
                // 80+ Rate - Historical - Changed from '75+'
                {
                    label: '80+',
                    data: plus80RateData,
                    borderColor: '#8ecae6',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 3,
                    pointBackgroundColor: '#8ecae6'
                },
                // Total Rate - Lower Confidence Interval
                {
                    label: 'Total Lower PI',
                    data: totalRateLowerData,
                    borderColor: 'rgba(255, 0, 0, 0.2)',
                    backgroundColor: 'rgba(255, 0, 0, 0.2)',
                    fill: '+2', // Fill to dataset with index +2 (the upper interval)
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 0,
                    //hidden: true // Start hidden
                },
                // Total Rate - Forecast
                {
                    label: 'Total (Forecast)',
                    data: totalRateForecastData,
                    borderColor: '#fb8500',
                    fill: false,
                    tension: 0.1,
                    borderDash: [5, 5],
                    pointRadius: 3,
                    pointBackgroundColor: '#fb8500',
                    //hidden: true // Start hidden
                },
                // Total Rate - Upper Confidence Interval
                {
                    label: 'Total Upper PI',
                    data: totalRateUpperData,
                    borderColor: 'rgba(255, 0, 0, 0)',
                    backgroundColor: 'rgba(255, 0, 0, 0)',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 0,
                    //hidden: true // Start hidden
                },
                // Less than 65 Rate - Lower Confidence Interval - Changed from 'Less than 60'
                {
                    label: 'Less than 65 Lower PI',
                    data: less65RateLowerData,
                    borderColor: 'rgba(0, 0, 255, 0.2)',
                    backgroundColor: 'rgba(0, 0, 255, 0.2)',
                    fill: '+2', // Fill to dataset with index +2 (the upper interval)
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 0,
                    //hidden: true // Start hidden
                },
                // Less than 65 Rate - Forecast - Changed from 'Less than 60'
                {
                    label: 'Less than 65 (Forecast)',
                    data: less65RateForecastData,
                    borderColor: '#023047',
                    fill: false,
                    tension: 0.1,
                    borderDash: [5, 5],
                    pointRadius: 3,
                    pointBackgroundColor: '#023047',
                    //hidden: true // Start hidden
                },
                // Less than 65 Rate - Upper Confidence Interval - Changed from 'Less than 60'
                {
                    label: 'Less than 65 Upper PI',
                    data: less65RateUpperData,
                    borderColor: 'rgba(0, 0, 255, 0)',
                    backgroundColor: 'rgba(0, 0, 255, 0)',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 0,
                    //hidden: true // Start hidden
                },
                // 65-79 Rate - Lower Confidence Interval - Changed from '60-74'
                {
                    label: '65-79 Lower PI',
                    data: age65to79RateLowerData,
                    borderColor: 'rgba(33, 158, 188, 0.2)',
                    backgroundColor: 'rgba(33, 158, 188, 0.2)',
                    fill: '+2', // Fill to dataset with index +2 (the upper interval)
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 0,
                    //hidden: true // Start hidden
                },
                // 65-79 Rate - Forecast - Changed from '60-74'
                {
                    label: '65-79 (Forecast)',
                    data: age65to79RateForecastData,
                    borderColor: '#219ebc',
                    fill: false,
                    tension: 0.1,
                    borderDash: [5, 5],
                    pointRadius: 3,
                    pointBackgroundColor: '#219ebc',
                    //hidden: true // Start hidden
                },
                // 65-79 Rate - Upper Confidence Interval - Changed from '60-74'
                {
                    label: '65-79 Upper PI',
                    data: age65to79RateUpperData,
                    borderColor: 'rgba(33, 158, 188, 0)',
                    backgroundColor: 'rgba(33, 158, 188, 0)',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 0,
                    //hidden: true // Start hidden
                },
                // 80+ Rate - Lower Confidence Interval - Changed from '75+'
                {
                    label: '80+ Lower PI',
                    data: plus80RateLowerData,
                    borderColor: 'rgba(255, 105, 180, 0.2)',
                    backgroundColor: 'rgba(255, 105, 180, 0.2)',
                    fill: '+2', // Fill to dataset with index +2 (the upper interval)
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 0,
                    //hidden: true // Start hidden
                },
                // 80+ Rate - Forecast - Changed from '75+'
                {
                    label: '80+ (Forecast)',
                    data: plus80RateForecastData,
                    borderColor: '#8ecae6',
                    fill: false,
                    tension: 0.1,
                    borderDash: [5, 5],
                    pointRadius: 3,
                    pointBackgroundColor: '#8ecae6',
                    //hidden: true // Start hidden
                },
                // 80+ Rate - Upper Confidence Interval - Changed from '75+'
                {
                    label: '80+ Upper PI',
                    data: plus80RateUpperData,
                    borderColor: 'rgba(255, 105, 180, 0)',
                    backgroundColor: 'rgba(255, 105, 180, 0)',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 0,
                    //hidden: true // Start hidden
                }
            ]
        },
        options: {
            plugins: {
                legend: {
                    display: false // Disable built-in legend
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.dataset.label || '';
                            if (label.includes('PI')) return null;
                            
                            const value = context.parsed.y || 0;
                            
                            // For forecast points, add prediction interval to tooltip
                            if (label.includes('Forecast') && value) {
                                let lowerValue, upperValue;
                                
                                if (label.includes('Total')) {
                                    // Find the indices for the prediction intervals
                                    const lowerPIIndex = context.chart.data.datasets.findIndex(ds => ds.label === 'Total Lower PI');
                                    const upperPIIndex = context.chart.data.datasets.findIndex(ds => ds.label === 'Total Upper PI');
                                    
                                    if (lowerPIIndex !== -1 && upperPIIndex !== -1) {
                                        lowerValue = context.chart.data.datasets[lowerPIIndex].data[context.dataIndex];
                                        upperValue = context.chart.data.datasets[upperPIIndex].data[context.dataIndex];
                                    }
                                } else if (label.includes('Less than 65')) { // Changed from 'Less than 60'
                                    const lowerPIIndex = context.chart.data.datasets.findIndex(ds => ds.label === 'Less than 65 Lower PI');
                                    const upperPIIndex = context.chart.data.datasets.findIndex(ds => ds.label === 'Less than 65 Upper PI');
                                    
                                    if (lowerPIIndex !== -1 && upperPIIndex !== -1) {
                                        lowerValue = context.chart.data.datasets[lowerPIIndex].data[context.dataIndex];
                                        upperValue = context.chart.data.datasets[upperPIIndex].data[context.dataIndex];
                                    }
                                } else if (label.includes('65-79')) { // Changed from '60-74'
                                    const lowerPIIndex = context.chart.data.datasets.findIndex(ds => ds.label === '65-79 Lower PI');
                                    const upperPIIndex = context.chart.data.datasets.findIndex(ds => ds.label === '65-79 Upper PI');
                                    
                                    if (lowerPIIndex !== -1 && upperPIIndex !== -1) {
                                        lowerValue = context.chart.data.datasets[lowerPIIndex].data[context.dataIndex];
                                        upperValue = context.chart.data.datasets[upperPIIndex].data[context.dataIndex];
                                    }
                                } else if (label.includes('80+')) { // Changed from '75+'
                                    const lowerPIIndex = context.chart.data.datasets.findIndex(ds => ds.label === '80+ Lower PI');
                                    const upperPIIndex = context.chart.data.datasets.findIndex(ds => ds.label === '80+ Upper PI');
                                    
                                    if (lowerPIIndex !== -1 && upperPIIndex !== -1) {
                                        lowerValue = context.chart.data.datasets[lowerPIIndex].data[context.dataIndex];
                                        upperValue = context.chart.data.datasets[upperPIIndex].data[context.dataIndex];
                                    }
                                }
                                
                                if (lowerValue && upperValue) {
                                    return [
                                        `${label}: ${value.toFixed(2)}`,
                                        `95% PI: [${lowerValue.toFixed(2)}, ${upperValue.toFixed(2)}]`
                                    ];
                                }
                            }
                            
                            return `${label}: ${value.toFixed(2)}`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: ['Age-standardized incidence rate','(per 10,000 persons)'],
                        font: {
                            size: 16,           // Change font size here
                            family: 'Arial'     // Change font family here
                        },
                        color: '#333333'        // Change color here
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Year',
                        font: {
                            size: 16,           // Change font size here
                            family: 'Arial'     // Change font family here
                        },
                        color: '#333333'        // Change color here
                    },
                    //max: filteredYears.length - 1 // Initially show only historical years
                }
            }
        }
    });
    
    // Create custom legend for rate chart
    createCustomLegend(rateChartObj, 'rateLegend', true);
    
    // Show initial chart
    toggleChart('incidence', null);
}

function updatePrevalenceCharts() {
    // Get chart contexts
    const ctxNumber = document.getElementById('prevalenceNumberChart').getContext('2d');
    const ctxRate = document.getElementById('prevalenceRateChart').getContext('2d');
    
    // Create combined data arrays for prevalence number chart
    const totalPrevData = [];
    const less65PrevData = []; // Changed from less60 to less65
    const age65to79PrevData = []; // Changed from age60to74 to age65to79
    const plus80PrevData = []; // Changed from plus75 to plus80
    
    const totalPrevForecastData = [];
    const less65PrevForecastData = []; // Changed from less60 to less65
    const age65to79PrevForecastData = []; // Changed from age60to74 to age65to79
    const plus80PrevForecastData = []; // Changed from plus75 to plus80
    
    // Prepare data for prediction intervals
    const totalPrevLowerData = [];
    const totalPrevUpperData = [];
    const less65PrevLowerData = []; // Changed from less60 to less65
    const less65PrevUpperData = []; // Changed from less60 to less65
    const age65to79PrevLowerData = []; // Changed from age60to74 to age65to79
    const age65to79PrevUpperData = []; // Changed from age60to74 to age65to79
    const plus80PrevLowerData = []; // Changed from plus75 to plus80
    const plus80PrevUpperData = []; // Changed from plus75 to plus80
    
    // Fill historical data arrays (use filtered data from 2014 onwards)
    for (let i = 0; i < filteredYears.length; i++) {
        totalPrevData.push(filtered_num_unique_prev[i]);
        less65PrevData.push(filtered_num_less65_prev[i]); // Changed from less60 to less65
        age65to79PrevData.push(filtered_num_65to79_prev[i]); // Changed from age60to74 to age65to79
        plus80PrevData.push(filtered_num_80plus_prev[i]); // Changed from plus75 to plus80
        
        // Add null placeholders for forecast in historical period
        if (i < filteredYears.length - 1) { // All except last point (2022)
            totalPrevForecastData.push(null);
            less65PrevForecastData.push(null); // Changed from less60 to less65
            age65to79PrevForecastData.push(null); // Changed from age60to74 to age65to79
            plus80PrevForecastData.push(null); // Changed from plus75 to plus80
            
            totalPrevLowerData.push(null);
            totalPrevUpperData.push(null);
            less65PrevLowerData.push(null); // Changed from less60 to less65
            less65PrevUpperData.push(null); // Changed from less60 to less65
            age65to79PrevLowerData.push(null); // Changed from age60to74 to age65to79
            age65to79PrevUpperData.push(null); // Changed from age60to74 to age65to79
            plus80PrevLowerData.push(null); // Changed from plus75 to plus80
            plus80PrevUpperData.push(null); // Changed from plus75 to plus80
        } else { // 2022 point (shared between historical and forecast)
            totalPrevForecastData.push(totalPrevForecast[0]);
            less65PrevForecastData.push(less65PrevForecast[0]); // Changed from less60 to less65
            age65to79PrevForecastData.push(age65to79PrevForecast[0]); // Changed from age60to74 to age65to79
            plus80PrevForecastData.push(plus80PrevForecast[0]); // Changed from plus75 to plus80
            
            totalPrevLowerData.push(totalPrevLower[0]);
            totalPrevUpperData.push(totalPrevUpper[0]);
            less65PrevLowerData.push(less65PrevLower[0]); // Changed from less60 to less65
            less65PrevUpperData.push(less65PrevUpper[0]); // Changed from less60 to less65
            age65to79PrevLowerData.push(age65to79PrevLower[0]); // Changed from age60to74 to age65to79
            age65to79PrevUpperData.push(age65to79PrevUpper[0]); // Changed from age60to74 to age65to79
            plus80PrevLowerData.push(plus80PrevLower[0]); // Changed from plus75 to plus80
            plus80PrevUpperData.push(plus80PrevUpper[0]); // Changed from plus75 to plus80
        }
    }
    
    // Add forecast data for 2023-2032
    for (let i = 1; i < prevForecastYears.length; i++) { // Skip first (2022)
        // Add null placeholders for historical in forecast period
        totalPrevData.push(null);
        less65PrevData.push(null); // Changed from less60 to less65
        age65to79PrevData.push(null); // Changed from age60to74 to age65to79
        plus80PrevData.push(null); // Changed from plus75 to plus80
        
        // Add forecast data points
        totalPrevForecastData.push(totalPrevForecast[i]);
        less65PrevForecastData.push(less65PrevForecast[i]); // Changed from less60 to less65
        age65to79PrevForecastData.push(age65to79PrevForecast[i]); // Changed from age60to74 to age65to79
        plus80PrevForecastData.push(plus80PrevForecast[i]); // Changed from plus75 to plus80
        
        // Add prediction intervals
        totalPrevLowerData.push(totalPrevLower[i]);
        totalPrevUpperData.push(totalPrevUpper[i]);
        less65PrevLowerData.push(less65PrevLower[i]); // Changed from less60 to less65
        less65PrevUpperData.push(less65PrevUpper[i]); // Changed from less60 to less65
        age65to79PrevLowerData.push(age65to79PrevLower[i]); // Changed from age60to74 to age65to79
        age65to79PrevUpperData.push(age65to79PrevUpper[i]); // Changed from age60to74 to age65to79
        plus80PrevLowerData.push(plus80PrevLower[i]); // Changed from plus75 to plus80
        plus80PrevUpperData.push(plus80PrevUpper[i]); // Changed from plus75 to plus80
    }
    
    // Create combined years array - start with filtered years (2014 onwards)
    const allYears = [...filteredYears];
    
    // Add 2023-2032 (excluding 2022 which is already included)
    for (let i = 1; i < prevForecastYears.length; i++) {
        allYears.push(prevForecastYears[i]);
    }
    
    // Clean up any existing charts
    if (prevalenceNumberChart) {
        prevalenceNumberChart.destroy();
    }
    
    // Create new prevalence number chart
    prevalenceNumberChart = new Chart(ctxNumber, {
        type: 'line',
        data: {
            labels: allYears,
            datasets: [
                // Total Cases - Historical
                {
                    label: 'Total',
                    data: totalPrevData,
                    borderColor: '#fb8500',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 3,
                    pointBackgroundColor: '#fb8500'
                },
                // Less than 65 Cases - Historical - Changed from 'Less than 60'
                {
                    label: 'Less than 65',
                    data: less65PrevData,
                    borderColor: '#023047',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 3,
                    pointBackgroundColor: '#023047'
                },
                // 65-79 Cases - Historical - Changed from '60-74'
                {
                    label: '65-79',
                    data: age65to79PrevData,
                    borderColor: '#219ebc',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 3,
                    pointBackgroundColor: '#219ebc'
                },
                // 80+ Cases - Historical - Changed from '75+'
                {
                    label: '80+',
                    data: plus80PrevData,
                    borderColor: '#8ecae6',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 3,
                    pointBackgroundColor: '#8ecae6'
                },
                // Total Cases - Lower Confidence Interval
                {
                    label: 'Total Lower PI',
                    data: totalPrevLowerData,
                    borderColor: 'rgba(255, 0, 0, 0.2)',
                    backgroundColor: 'rgba(255, 0, 0, 0.2)',
                    fill: '+2', // Fill to dataset with index +2 (the upper interval)
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 0,
                    //hidden: true // Start hidden
                },
                // Total Cases - Forecast
                {
                    label: 'Total (Forecast)',
                    data: totalPrevForecastData,
                    borderColor: '#fb8500', 
                    fill: false,
                    tension: 0.1,
                    borderDash: [5, 5],
                    pointRadius: 3,
                    pointBackgroundColor: '#fb8500',
                    //hidden: true // Start hidden
                },
                // Total Cases - Upper Confidence Interval
                {
                    label: 'Total Upper PI',
                    data: totalPrevUpperData,
                    borderColor: 'rgba(255, 0, 0, 0)',
                    backgroundColor: 'rgba(255, 0, 0, 0)',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 0,
                    ////hidden: true // Start hidden
                },
                // Less than 65 Cases - Lower Confidence Interval - Changed from 'Less than 60'
                {
                    label: 'Less than 65 Lower PI',
                    data: less65PrevLowerData,
                    borderColor: 'rgba(0, 0, 255, 0.2)',
                    backgroundColor: 'rgba(0, 0, 255, 0.2)',
                    fill: '+2', // Fill to dataset with index +2 (the upper interval)
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 0,
                    //hidden: true // Start hidden
                },
                // Less than 65 Cases - Forecast - Changed from 'Less than 60'
                {
                    label: 'Less than 65 (Forecast)',
                    data: less65PrevForecastData,
                    borderColor: '#023047',
                    fill: false,
                    tension: 0.1,
                    borderDash: [5, 5],
                    pointRadius: 3,
                    pointBackgroundColor: '#023047',
                    //hidden: true // Start hidden
                },
                // Less than 65 Cases - Upper Confidence Interval - Changed from 'Less than 60'
                {
                    label: 'Less than 65 Upper PI',
                    data: less65PrevUpperData,
                    borderColor: 'rgba(0, 0, 255, 0)',
                    backgroundColor: 'rgba(0, 0, 255, 0)',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 0,
                    //hidden: true // Start hidden
                },
                // 65-79 Cases - Lower Confidence Interval - Changed from '60-74'
                {
                    label: '65-79 Lower PI',
                    data: age65to79PrevLowerData,
                    borderColor: 'rgba(33, 158, 188, 0.2)',
                    backgroundColor: 'rgba(33, 158, 188, 0.2)',
                    fill: '+2', // Fill to dataset with index +2 (the upper interval)
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 0,
                    //hidden: true // Start hidden
                },
                // 65-79 Cases - Forecast - Changed from '60-74'
                {
                    label: '65-79 (Forecast)',
                    data: age65to79PrevForecastData,
                    borderColor: '#219ebc',
                    fill: false,
                    tension: 0.1,
                    borderDash: [5, 5],
                    pointRadius: 3,
                    pointBackgroundColor: '#219ebc',
                    //hidden: true // Start hidden
                },
                // 65-79 Cases - Upper Confidence Interval - Changed from '60-74'
                {
                    label: '65-79 Upper PI',
                    data: age65to79PrevUpperData,
                    borderColor: 'rgba(33, 158, 188, 0)',
                    backgroundColor: 'rgba(33, 158, 188, 0)',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 0,
                    //hidden: true // Start hidden
                },
                // 80+ Cases - Lower Confidence Interval - Changed from '75+'
                {
                    label: '80+ Lower PI',
                    data: plus80PrevLowerData,
                    borderColor: 'rgba(255, 105, 180, 0.2)',
                    backgroundColor: 'rgba(255, 105, 180, 0.2)',
                    fill: '+2', // Fill to dataset with index +2 (the upper interval)
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 0,
                    //hidden: true // Start hidden
                },
                // 80+ Cases - Forecast - Changed from '75+'
                {
                    label: '80+ (Forecast)',
                    data: plus80PrevForecastData,
                    borderColor: '#8ecae6',
                    fill: false,
                    tension: 0.1,
                    borderDash: [5, 5],
                    pointRadius: 3,
                    pointBackgroundColor: '#8ecae6',
                    //hidden: true // Start hidden
                },
                // 80+ Cases - Upper Confidence Interval - Changed from '75+'
                {
                    label: '80+ Upper PI',
                    data: plus80PrevUpperData,
                    borderColor: 'rgba(255, 105, 180, 0)',
                    backgroundColor: 'rgba(255, 105, 180, 0)',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 0,
                    //hidden: true // Start hidden
                }
            ]
        },
        options: {
            plugins: {
                legend: {
                    display: false // Disable built-in legend
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.dataset.label || '';
                            if (label.includes('PI')) return null;
                            
                            const value = context.parsed.y || 0;
                            
                            // For forecast points, add prediction interval to tooltip
                            if (label.includes('Forecast') && value) {
                                let lowerValue, upperValue;
                                
                                if (label.includes('Total')) {
                                    // Find the indices for the prediction intervals
                                    const lowerPIIndex = context.chart.data.datasets.findIndex(ds => ds.label === 'Total Lower PI');
                                    const upperPIIndex = context.chart.data.datasets.findIndex(ds => ds.label === 'Total Upper PI');
                                    
                                    if (lowerPIIndex !== -1 && upperPIIndex !== -1) {
                                        lowerValue = context.chart.data.datasets[lowerPIIndex].data[context.dataIndex];
                                        upperValue = context.chart.data.datasets[upperPIIndex].data[context.dataIndex];
                                    }
                                } else if (label.includes('Less than 65')) { // Changed from 'Less than 60'
                                    const lowerPIIndex = context.chart.data.datasets.findIndex(ds => ds.label === 'Less than 65 Lower PI');
                                    const upperPIIndex = context.chart.data.datasets.findIndex(ds => ds.label === 'Less than 65 Upper PI');
                                    
                                    if (lowerPIIndex !== -1 && upperPIIndex !== -1) {
                                        lowerValue = context.chart.data.datasets[lowerPIIndex].data[context.dataIndex];
                                        upperValue = context.chart.data.datasets[upperPIIndex].data[context.dataIndex];
                                    }
                                } else if (label.includes('65-79')) { // Changed from '60-74'
                                    const lowerPIIndex = context.chart.data.datasets.findIndex(ds => ds.label === '65-79 Lower PI');
                                    const upperPIIndex = context.chart.data.datasets.findIndex(ds => ds.label === '65-79 Upper PI');
                                    
                                    if (lowerPIIndex !== -1 && upperPIIndex !== -1) {
                                        lowerValue = context.chart.data.datasets[lowerPIIndex].data[context.dataIndex];
                                        upperValue = context.chart.data.datasets[upperPIIndex].data[context.dataIndex];
                                    }
                                } else if (label.includes('80+')) { // Changed from '75+'
                                    const lowerPIIndex = context.chart.data.datasets.findIndex(ds => ds.label === '80+ Lower PI');
                                    const upperPIIndex = context.chart.data.datasets.findIndex(ds => ds.label === '80+ Upper PI');
                                    
                                    if (lowerPIIndex !== -1 && upperPIIndex !== -1) {
                                        lowerValue = context.chart.data.datasets[lowerPIIndex].data[context.dataIndex];
                                        upperValue = context.chart.data.datasets[upperPIIndex].data[context.dataIndex];
                                    }
                                }
                                
                                if (lowerValue && upperValue) {
                                    return [
                                        `${label}: ${Math.round(value)}`,
                                        `95% PI: [${Math.round(lowerValue)}, ${Math.round(upperValue)}]`
                                    ];
                                }
                            }
                            
                            return `${label}: ${Math.round(value)}`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Number of prevalent cases',
                        font: {
                            size: 16,           // Change font size here
                            family: 'Arial'     // Change font family here
                        },
                        color: '#333333'        // Change color here
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Year',
                        font: {
                            size: 16,           // Change font size here
                            family: 'Arial'     // Change font family here
                        },
                        color: '#333333'        // Change color here
                    },
                    //max: filteredYears.length - 1 // Initially show only historical years
                }
            }
        }
    });
    
    // Create custom legend for prevalence number chart
    createCustomLegend(prevalenceNumberChart, 'prevalenceNumberLegend', false);
    
    // Prepare data for prevalence rate chart
    const totalRateData = [];
    const less65RateData = []; // Changed from less60 to less65
    const age65to79RateData = []; // Changed from age60to74 to age65to79
    const plus80RateData = []; // Changed from plus75 to plus80
    
    const totalRateForecastData = [];
    const less65RateForecastData = []; // Changed from less60 to less65
    const age65to79RateForecastData = []; // Changed from age60to74 to age65to79
    const plus80RateForecastData = []; // Changed from plus75 to plus80
    
    // Prepare prediction intervals for rate chart
    const totalRateLowerData = [];
    const totalRateUpperData = [];
    const less65RateLowerData = []; // Changed from less60 to less65
    const less65RateUpperData = []; // Changed from less60 to less65
    const age65to79RateLowerData = []; // Changed from age60to74 to age65to79
    const age65to79RateUpperData = []; // Changed from age60to74 to age65to79
    const plus80RateLowerData = []; // Changed from plus75 to plus80
    const plus80RateUpperData = []; // Changed from plus75 to plus80
    
    // Fill historical data arrays (use filtered data from 2014 onwards)
    for (let i = 0; i < filteredYears.length; i++) {
        totalRateData.push(filtered_Age_Standardized_Prevalence[i]);
        less65RateData.push(filtered_age_standardized_prev_less65[i]); // Changed from less60 to less65
        age65to79RateData.push(filtered_age_standardized_prev_65to79[i]); // Changed from age60to74 to age65to79
        plus80RateData.push(filtered_age_standardized_prev_80plus[i]); // Changed from plus75 to plus80
        
        // Add null placeholders for forecast in historical period
        if (i < filteredYears.length - 1) { // All except last point (2022)
            totalRateForecastData.push(null);
            less65RateForecastData.push(null); // Changed from less60 to less65
            age65to79RateForecastData.push(null); // Changed from age60to74 to age65to79
            plus80RateForecastData.push(null); // Changed from plus75 to plus80
            
            totalRateLowerData.push(null);
            totalRateUpperData.push(null);
            less65RateLowerData.push(null); // Changed from less60 to less65
            less65RateUpperData.push(null); // Changed from less60 to less65
            age65to79RateLowerData.push(null); // Changed from age60to74 to age65to79
            age65to79RateUpperData.push(null); // Changed from age60to74 to age65to79
            plus80RateLowerData.push(null); // Changed from plus75 to plus80
            plus80RateUpperData.push(null); // Changed from plus75 to plus80
        } else { // 2022 point (shared between historical and forecast)
            totalRateForecastData.push(totalPrevRateForecast[0]);
            less65RateForecastData.push(less65PrevRateForecast[0]); // Changed from less60 to less65
            age65to79RateForecastData.push(age65to79PrevRateForecast[0]); // Changed from age60to74 to age65to79
            plus80RateForecastData.push(plus80PrevRateForecast[0]); // Changed from plus75 to plus80
            
            totalRateLowerData.push(totalPrevRateLower[0]);
            totalRateUpperData.push(totalPrevRateUpper[0]);
            less65RateLowerData.push(less65PrevRateLower[0]); // Changed from less60 to less65
            less65RateUpperData.push(less65PrevRateUpper[0]); // Changed from less60 to less65
            age65to79RateLowerData.push(age65to79PrevRateLower[0]); // Changed from age60to74 to age65to79
            age65to79RateUpperData.push(age65to79PrevRateUpper[0]); // Changed from age60to74 to age65to79
            plus80RateLowerData.push(plus80PrevRateLower[0]); // Changed from plus75 to plus80
            plus80RateUpperData.push(plus80PrevRateUpper[0]); // Changed from plus75 to plus80
        }
    }
    
    // Add forecast data for 2023-2032
    for (let i = 1; i < prevForecastYears.length; i++) { // Skip first (2022)
        // Add null placeholders for historical in forecast period
        totalRateData.push(null);
        less65RateData.push(null); // Changed from less60 to less65
        age65to79RateData.push(null); // Changed from age60to74 to age65to79
        plus80RateData.push(null); // Changed from plus75 to plus80
        
        // Add forecast data points
        totalRateForecastData.push(totalPrevRateForecast[i]);
        less65RateForecastData.push(less65PrevRateForecast[i]); // Changed from less60 to less65
        age65to79RateForecastData.push(age65to79PrevRateForecast[i]); // Changed from age60to74 to age65to79
        plus80RateForecastData.push(plus80PrevRateForecast[i]); // Changed from plus75 to plus80
        
        // Add prediction intervals
        totalRateLowerData.push(totalPrevRateLower[i]);
        totalRateUpperData.push(totalPrevRateUpper[i]);
        less65RateLowerData.push(less65PrevRateLower[i]); // Changed from less60 to less65
        less65RateUpperData.push(less65PrevRateUpper[i]); // Changed from less60 to less65
        age65to79RateLowerData.push(age65to79PrevRateLower[i]); // Changed from age60to74 to age65to79
        age65to79RateUpperData.push(age65to79PrevRateUpper[i]); // Changed from age60to74 to age65to79
        plus80RateLowerData.push(plus80PrevRateLower[i]); // Changed from plus75 to plus80
        plus80RateUpperData.push(plus80PrevRateUpper[i]); // Changed from plus75 to plus80
    }
    
    // Clean up any existing rate chart
    if (prevalenceRateChart) {
        prevalenceRateChart.destroy();
    }
    
    // Create new prevalence rate chart
    prevalenceRateChart = new Chart(ctxRate, {
        type: 'line',
        data: {
            labels: allYears,
            datasets: [
                // Total Rate - Historical
                {
                    label: 'Total',
                    data: totalRateData,
                    borderColor: '#fb8500',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 3,
                    pointBackgroundColor: '#fb8500'
                },
                // Less than 65 Rate - Historical - Changed from 'Less than 60'
                {
                    label: 'Less than 65',
                    data: less65RateData,
                    borderColor: '#023047',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 3,
                    pointBackgroundColor: '#023047'
                },
                // 65-79 Rate - Historical - Changed from '60-74'
                {
                    label: '65-79',
                    data: age65to79RateData,
                    borderColor: '#219ebc',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 3,
                    pointBackgroundColor: '#219ebc'
                },
                // 80+ Rate - Historical - Changed from '75+'
                {
                    label: '80+',
                    data: plus80RateData,
                    borderColor: '#8ecae6',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 3,
                    pointBackgroundColor: '#8ecae6'
                },
                // Total Rate - Lower Confidence Interval
                {
                    label: 'Total Lower PI',
                    data: totalRateLowerData,
                    borderColor: 'rgba(255, 0, 0, 0.2)',
                    backgroundColor: 'rgba(255, 0, 0, 0.2)',
                    fill: '+2', // Fill to dataset with index +2 (the upper interval)
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 0,
                    //hidden: true // Start hidden
                },
                // Total Rate - Forecast
                {
                    label: 'Total (Forecast)',
                    data: totalRateForecastData,
                    borderColor: '#fb8500',
                    fill: false,
                    tension: 0.1,
                    borderDash: [5, 5],
                    pointRadius: 3,
                    pointBackgroundColor: '#fb8500',
                    //hidden: true // Start hidden
                },
                // Total Rate - Upper Confidence Interval
                {
                    label: 'Total Upper PI',
                    data: totalRateUpperData,
                    borderColor: 'rgba(255, 0, 0, 0)',
                    backgroundColor: 'rgba(255, 0, 0, 0)',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 0,
                    //hidden: true // Start hidden
                },
                // Less than 65 Rate - Lower Confidence Interval - Changed from 'Less than 60'
                {
                    label: 'Less than 65 Lower PI',
                    data: less65RateLowerData,
                    borderColor: 'rgba(0, 0, 255, 0.2)',
                    backgroundColor: 'rgba(0, 0, 255, 0.2)',
                    fill: '+2', // Fill to dataset with index +2 (the upper interval)
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 0,
                    //hidden: true // Start hidden
                },
                // Less than 65 Rate - Forecast - Changed from 'Less than 60'
                {
                    label: 'Less than 65 (Forecast)',
                    data: less65RateForecastData,
                    borderColor: '#023047',
                    fill: false,
                    tension: 0.1,
                    borderDash: [5, 5],
                    pointRadius: 3,
                    pointBackgroundColor: '#023047',
                    //hidden: true // Start hidden
                },
                // Less than 65 Rate - Upper Confidence Interval - Changed from 'Less than 60'
                {
                    label: 'Less than 65 Upper PI',
                    data: less65RateUpperData,
                    borderColor: 'rgba(0, 0, 255, 0)',
                    backgroundColor: 'rgba(0, 0, 255, 0)',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 0,
                    //hidden: true // Start hidden
                },
                // 65-79 Rate - Lower Confidence Interval - Changed from '60-74'
                {
                    label: '65-79 Lower PI',
                    data: age65to79RateLowerData,
                    borderColor: 'rgba(33, 158, 188, 0.2)',
                    backgroundColor: 'rgba(33, 158, 188, 0.2)',
                    fill: '+2', // Fill to dataset with index +2 (the upper interval)
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 0,
                    //hidden: true // Start hidden
                },
                // 65-79 Rate - Forecast - Changed from '60-74'
                {
                    label: '65-79 (Forecast)',
                    data: age65to79RateForecastData,
                    borderColor: '#219ebc',
                    fill: false,
                    tension: 0.1,
                    borderDash: [5, 5],
                    pointRadius: 3,
                    pointBackgroundColor: '#219ebc',
                    //hidden: true // Start hidden
                },
                // 65-79 Rate - Upper Confidence Interval - Changed from '60-74'
                {
                    label: '65-79 Upper PI',
                    data: age65to79RateUpperData,
                    borderColor: 'rgba(33, 158, 188, 0)',
                    backgroundColor: 'rgba(33, 158, 188, 0)',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 0,
                    //hidden: true // Start hidden
                },
                // 80+ Rate - Lower Confidence Interval - Changed from '75+'
                {
                    label: '80+ Lower PI',
                    data: plus80RateLowerData,
                    borderColor: 'rgba(255, 105, 180, 0.2)',
                    backgroundColor: 'rgba(255, 105, 180, 0.2)',
                    fill: '+2', // Fill to dataset with index +2 (the upper interval)
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 0,
                    //hidden: true // Start hidden
                },
                // 80+ Rate - Forecast - Changed from '75+'
                {
                    label: '80+ (Forecast)',
                    data: plus80RateForecastData,
                    borderColor: '#8ecae6',
                    fill: false,
                    tension: 0.1,
                    borderDash: [5, 5],
                    pointRadius: 3,
                    pointBackgroundColor: '#8ecae6',
                    //hidden: true // Start hidden
                },
                // 80+ Rate - Upper Confidence Interval - Changed from '75+'
                {
                    label: '80+ Upper PI',
                    data: plus80RateUpperData,
                    borderColor: 'rgba(255, 105, 180, 0)',
                    backgroundColor: 'rgba(255, 105, 180, 0)',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 0,
                    //hidden: true // Start hidden
                }
            ]
        },
        options: {
            plugins: {
                legend: {
                    display: false // Disable built-in legend
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.dataset.label || '';
                            if (label.includes('PI')) return null;
                            
                            const value = context.parsed.y || 0;
                            
                            // For forecast points, add prediction interval to tooltip
                            if (label.includes('Forecast') && value) {
                                let lowerValue, upperValue;
                                
                                if (label.includes('Total')) {
                                    // Find the indices for the prediction intervals
                                    const lowerPIIndex = context.chart.data.datasets.findIndex(ds => ds.label === 'Total Lower PI');
                                    const upperPIIndex = context.chart.data.datasets.findIndex(ds => ds.label === 'Total Upper PI');
                                    
                                    if (lowerPIIndex !== -1 && upperPIIndex !== -1) {
                                        lowerValue = context.chart.data.datasets[lowerPIIndex].data[context.dataIndex];
                                        upperValue = context.chart.data.datasets[upperPIIndex].data[context.dataIndex];
                                    }
                                } else if (label.includes('Less than 65')) { // Changed from 'Less than 60'
                                    const lowerPIIndex = context.chart.data.datasets.findIndex(ds => ds.label === 'Less than 65 Lower PI');
                                    const upperPIIndex = context.chart.data.datasets.findIndex(ds => ds.label === 'Less than 65 Upper PI');
                                    
                                    if (lowerPIIndex !== -1 && upperPIIndex !== -1) {
                                        lowerValue = context.chart.data.datasets[lowerPIIndex].data[context.dataIndex];
                                        upperValue = context.chart.data.datasets[upperPIIndex].data[context.dataIndex];
                                    }
                                } else if (label.includes('65-79')) { // Changed from '60-74'
                                    const lowerPIIndex = context.chart.data.datasets.findIndex(ds => ds.label === '65-79 Lower PI');
                                    const upperPIIndex = context.chart.data.datasets.findIndex(ds => ds.label === '65-79 Upper PI');
                                    
                                    if (lowerPIIndex !== -1 && upperPIIndex !== -1) {
                                        lowerValue = context.chart.data.datasets[lowerPIIndex].data[context.dataIndex];
                                        upperValue = context.chart.data.datasets[upperPIIndex].data[context.dataIndex];
                                    }
                                } else if (label.includes('80+')) { // Changed from '75+'
                                    const lowerPIIndex = context.chart.data.datasets.findIndex(ds => ds.label === '80+ Lower PI');
                                    const upperPIIndex = context.chart.data.datasets.findIndex(ds => ds.label === '80+ Upper PI');
                                    
                                    if (lowerPIIndex !== -1 && upperPIIndex !== -1) {
                                        lowerValue = context.chart.data.datasets[lowerPIIndex].data[context.dataIndex];
                                        upperValue = context.chart.data.datasets[upperPIIndex].data[context.dataIndex];
                                    }
                                }
                                
                                if (lowerValue && upperValue) {
                                    return [
                                        `${label}: ${value.toFixed(2)}`,
                                        `95% PI: [${lowerValue.toFixed(2)}, ${upperValue.toFixed(2)}]`
                                    ];
                                }
                            }
                            
                            return `${label}: ${value.toFixed(2)}`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: ['Age-standardized prevalence rate', '(per 10,000 persons)'],
                        font: {
                            size: 16,           // Change font size here
                            family: 'Arial'     // Change font family here
                        },
                        color: '#333333'        // Change color here
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Year',
                        font: {
                            size: 16,           // Change font size here
                            family: 'Arial'     // Change font family here
                        },
                        color: '#333333'        // Change color here
                    },
                    //max: filteredYears.length - 1 // Initially show only historical years
                }
            }
        }
    });
    
    // Create custom legend for prevalence rate chart
    createCustomLegend(prevalenceRateChart, 'prevalenceRateLegend', true);
    
    // Show default prevalence chart
    togglePrevalence('number', null);
}

function updateCostChart() {
    // Get the context for the cost chart
    const ctx = document.getElementById('myChart').getContext('2d');
    
    // If a chart already exists, destroy it
    if (myChart) {
        myChart.destroy();
    }
    
    // Remove any existing legend first
    const existingLegend = document.getElementById('cost-legend');
    if (existingLegend) {
        existingLegend.remove();
    }
    
    // Create arrays to hold data for both historical and forecast costs
    const allYears = [...historicalYears, ...forecastYears];
    
    // Create combined data arrays for each cost type
    const combinedIP = [];
    const combinedOP = [];
    const combinedAE = [];
    
    // Fill in the historical years
    for (let i = 0; i < historicalYears.length; i++) {
        combinedIP.push(historicalIP[i]);
        combinedOP.push(historicalOP[i]);
        combinedAE.push(historicalAE[i]);
    }
    
    // Fill in the forecast years
    for (let i = 0; i < forecastYears.length; i++) {
        combinedIP.push(forecastIP[i]);
        combinedOP.push(forecastOP[i]);
        combinedAE.push(forecastAE[i]);
    }
    
    // Create patterns for forecast data
    const ipPattern = createDiagonalPattern('#00b4d8');
    const opPattern = createDiagonalPattern('#38b000');
    const aePattern = createDiagonalPattern('#FA7476');
    
    // Create the cost data structure
    const costData = {
        labels: allYears,
        datasets: [
            // Inpatient Cost (both historical and forecast)
            {
                label: 'Inpatient Cost',
                data: combinedIP,
                backgroundColor: function(context) {
                    // Use different colors for historical vs forecast
                    const index = context.dataIndex;
                    return index < historicalYears.length ? '#0072B2' : ipPattern;
                },
                stack: 'Stack 0'
            },
            // Outpatient Cost (both historical and forecast)
            {
                label: 'Outpatient Cost',
                data: combinedOP,
                backgroundColor: function(context) {
                    // Use different colors for historical vs forecast
                    const index = context.dataIndex;
                    return index < historicalYears.length ? '#009E73' : opPattern;
                },
                stack: 'Stack 0'
            },
            // A&E Cost (both historical and forecast)
            {
                label: 'Accident & Emergency Cost',
                data: combinedAE,
                backgroundColor: function(context) {
                    // Use different colors for historical vs forecast
                    const index = context.dataIndex;
                    return index < historicalYears.length ? '#f94144' : aePattern;
                },
                stack: 'Stack 0'
            }
        ]
    };
    
    // Function to create a diagonal pattern
    function createDiagonalPattern(color) {
        const patternCanvas = document.createElement('canvas');
        const patternContext = patternCanvas.getContext('2d');
        
        // Set canvas size
        patternCanvas.width = 10;
        patternCanvas.height = 10;
        
        // Fill with base color
        patternContext.fillStyle = color;
        patternContext.fillRect(0, 0, 10, 10);
        
        // Draw diagonal lines
        patternContext.strokeStyle = 'white';
        patternContext.lineWidth = 1;
        patternContext.beginPath();
        
        // Draw diagonal lines from top-left to bottom-right
        for (let i = -10; i < 20; i += 5) {
            patternContext.moveTo(i, 0);
            patternContext.lineTo(i + 10, 10);
        }
        
        patternContext.stroke();
        
        // Return pattern
        return patternContext.createPattern(patternCanvas, 'repeat');
    }

    // Chart configuration
    const config = {
        type: 'bar',
        data: costData,
        options: {
            plugins: {
                legend: {
                    display: false // Hide the default legend, we'll create a custom one
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.raw;
                            if (value === null) return null;
                            
                            // Add (Forecast) label for forecast years
                            let label = context.dataset.label;
                            if (context.dataIndex >= historicalYears.length) {
                                label += ' (Forecast)';
                            }
                            
                            // Format to millions with 2 decimal places
                            const valueInMillions = (value / 1000000).toFixed(2);
                            return `${label}: HK$${valueInMillions} million`;
                        }
                    }
                }
            },
            responsive: true,
            scales: {
                x: {
                    stacked: true,
                    title: {
                        display: true,
                        text: 'Year',
                        font: {
                            size: 16,           // Change font size here
                            family: 'Arial'     // Change font family here
                        },
                        color: '#333333'        // Change color here
                    },
                    offset: true,
                    ticks: {
                        align: 'center'
                    }
                },
                y: {
                    stacked: true,
                    title: {
                        display: true,
                        text: 'Cost (HKD)',
                        font: {
                            size: 16,           // Change font size here
                            family: 'Arial'     // Change font family here
                        },
                        color: '#333333'        // Change color here
                    },
                    ticks: {
                        callback: function(value) {
                            // Format y-axis labels to millions
                            return `${(value / 1000000).toFixed(0)}M`;
                        }
                    }
                }
            },
            barPercentage: 0.99,
            categoryPercentage: 0.9
        }
    };
    
    // Create a custom HTML legend with two rows
    const legendContainer = document.createElement('div');
    legendContainer.id = 'cost-legend';
    legendContainer.style.textAlign = 'center';
    legendContainer.style.margin = '10px auto 20px auto'; // Add bottom margin
    legendContainer.style.maxWidth = '800px';
    
    // Create the first row (Historical)
    const historicalRow = document.createElement('div');
    historicalRow.style.display = 'flex';
    historicalRow.style.justifyContent = 'center';
    historicalRow.style.margin = '5px 0';
    
    // Create the second row (Forecast)
    const forecastRow = document.createElement('div');
    forecastRow.style.display = 'flex';
    forecastRow.style.justifyContent = 'center';
    forecastRow.style.margin = '5px 0';
    
    // Legend data
    const legendItems = [
        // Historical items
        { label: 'Inpatient Cost', color: '#0072B2', datasetIndex: 0 },
        { label: 'Outpatient Cost', color: '#009E73', datasetIndex: 1 },
        { label: 'Accident & Emergency Cost', color: '#f94144', datasetIndex: 2 },
        // Forecast items
        { label: 'Inpatient Cost (Forecast)', pattern: ipPattern, color: '#00b4d8', datasetIndex: 0 },
        { label: 'Outpatient Cost (Forecast)', pattern: opPattern, color: '#38b000', datasetIndex: 1 },
        { label: 'Accident & Emergency Cost (Forecast)', pattern: aePattern, color: '#FA7476', datasetIndex: 2 }
    ];
    
    // Add items to respective rows
    for (let i = 0; i < 3; i++) {
        const item = legendItems[i];
        const legendItem = createLegendItem(item.label, item.color, item.datasetIndex, false);
        historicalRow.appendChild(legendItem);
    }
    
    for (let i = 3; i < 6; i++) {
        const item = legendItems[i];
        const legendItem = createLegendItem(item.label, item.color, item.datasetIndex, true, item.pattern);
        forecastRow.appendChild(legendItem);
    }
    
    legendContainer.appendChild(historicalRow);
    legendContainer.appendChild(forecastRow);
    
    // Add the legend to the DOM before the canvas
    const chartContainer = document.getElementById('chart-container');
    const canvasElement = document.getElementById('myChart');
    chartContainer.insertBefore(legendContainer, canvasElement);
    
    // Create the chart
    myChart = new Chart(ctx, config);
    
    // Function to create a legend item
    function createLegendItem(label, color, datasetIndex, isForecast, pattern) {
        const item = document.createElement('div');
        item.style.display = 'flex';
        item.style.alignItems = 'center';
        item.style.margin = '0 10px';
        item.style.cursor = 'pointer';
        
        // Color box
        const colorBox = document.createElement('span');
        colorBox.style.display = 'inline-block';
        colorBox.style.width = '15px';
        colorBox.style.height = '15px';
        colorBox.style.marginRight = '5px';
        
        if (isForecast) {
            // Create a small canvas for the pattern
            const canvas = document.createElement('canvas');
            canvas.width = 15;
            canvas.height = 15;
            canvas.style.width = '15px';   // Force canvas to be 15px wide
            canvas.style.height = '15px';  // Force canvas to be 15px tall
            canvas.style.display = 'block'; // Ensure it renders as a block
            const ctx = canvas.getContext('2d');
            
            // Draw the pattern background
            ctx.fillStyle = color;
            ctx.fillRect(0, 0, 15, 15);
            
            // Add diagonal lines
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 1;
            ctx.beginPath();
            for (let i = -15; i < 30; i += 5) {
                ctx.moveTo(i, 0);
                ctx.lineTo(i + 15, 15);
            }
            ctx.stroke();
            
            colorBox.appendChild(canvas);
        } else {
            colorBox.style.backgroundColor = color;
        }
        
        // Text label
        const textSpan = document.createElement('span');
        textSpan.style.fontFamily = 'Arial, sans-serif';
        textSpan.style.fontSize = '12px';
        textSpan.style.fontWeight = '530';
        textSpan.style.color = '#545151';
        textSpan.textContent = label;
        
        item.appendChild(colorBox);
        item.appendChild(textSpan);
        
        // Add click handler for toggling visibility
        item.addEventListener('click', function() {
            const meta = myChart.getDatasetMeta(datasetIndex);
            meta.hidden = !meta.hidden;
            
            // Visual feedback for hidden state
            if (meta.hidden) {
                item.style.opacity = '0.5';
                textSpan.style.textDecoration = 'line-through';
            } else {
                item.style.opacity = '1';
                textSpan.style.textDecoration = 'none';
            }
            
            myChart.update();
        });
        
        return item;
    }
}

// Parse historical prevalence data from Male_Prevalence_v2.csv
Papa.parse('Male_Prevalence_v2.csv', {
    download: true,
    header: false,
    complete: function(results) {
        // Extract years from the first row (skip the first column which contains "Col")
        years = results.data[0].slice(1).map(year => parseInt(year)).filter(y => y);
        lastHistoricalYear = Math.max(...years);
        
        // Find the index where 2014 starts to create filtered arrays
        yearStartIndex = years.findIndex(year => year >= 2014);
        
        // Create filtered year array starting from 2014
        filteredYears = years.slice(yearStartIndex);
        
        // Function to find a row by its first cell value (metric name)
        function findRowByMetric(metricName) {
            return results.data.find(row => row[0] === metricName);
        }
        
        // Extract prevalence data
        const totalRow = findRowByMetric("num_male_patient");
        const less65Row = findRowByMetric("num_male_patient_less65"); // Changed from less60 to less65
        const age65to79Row = findRowByMetric("num_male_patient_65to79"); // Changed from 60to74 to 65to79
        const age80plusRow = findRowByMetric("num_male_patient_80plus"); // Changed from 75plus to 80plus
        
        // Extract standardized prevalence rates
        const totalRateRow = findRowByMetric("age_standardized_prev_male");
        const less65RateRow = findRowByMetric("age_standardized_prev_male_less65"); // Changed from less60 to less65
        const age65to79RateRow = findRowByMetric("age_standardized_prev_male_65to79"); // Changed from 60to74 to 65to79
        const age80plusRateRow = findRowByMetric("age_standardized_prev_male_80plus"); // Changed from 75plus to 80plus
        
        // Create arrays for prevalence numbers (skip first column which is the metric name)
        num_unique_prev = totalRow ? totalRow.slice(1).map(val => parseInt(val) || 0) : [];
        num_less65_prev = less65Row ? less65Row.slice(1).map(val => parseInt(val) || 0) : []; // Changed from less60 to less65
        num_65to79_prev = age65to79Row ? age65to79Row.slice(1).map(val => parseInt(val) || 0) : []; // Changed from 60to74 to 65to79
        num_80plus_prev = age80plusRow ? age80plusRow.slice(1).map(val => parseInt(val) || 0) : []; // Changed from 75plus to 80plus
        
        // Create arrays for prevalence rates
        Age_Standardized_Prevalence = totalRateRow ? totalRateRow.slice(1).map(val => parseFloat(val) || 0) : [];
        age_standardized_prev_less65 = less65RateRow ? less65RateRow.slice(1).map(val => parseFloat(val) || 0) : []; // Changed from less60 to less65
        age_standardized_prev_65to79 = age65to79RateRow ? age65to79RateRow.slice(1).map(val => parseFloat(val) || 0) : []; // Changed from 60to74 to 65to79
        age_standardized_prev_80plus = age80plusRateRow ? age80plusRateRow.slice(1).map(val => parseFloat(val) || 0) : []; // Changed from 75plus to 80plus
        
        // Filter prevalence data to start from 2014
        filtered_num_unique_prev = num_unique_prev.slice(yearStartIndex);
        filtered_num_less65_prev = num_less65_prev.slice(yearStartIndex); // Changed from less60 to less65
        filtered_num_65to79_prev = num_65to79_prev.slice(yearStartIndex); // Changed from 60to74 to 65to79
        filtered_num_80plus_prev = num_80plus_prev.slice(yearStartIndex); // Changed from 75plus to 80plus
        
        filtered_Age_Standardized_Prevalence = Age_Standardized_Prevalence.slice(yearStartIndex);
        filtered_age_standardized_prev_less65 = age_standardized_prev_less65.slice(yearStartIndex); // Changed from less60 to less65
        filtered_age_standardized_prev_65to79 = age_standardized_prev_65to79.slice(yearStartIndex); // Changed from 60to74 to 65to79
        filtered_age_standardized_prev_80plus = age_standardized_prev_80plus.slice(yearStartIndex); // Changed from 75plus to 80plus
        
        // Parse cost data from the new CSV file
        Papa.parse('Prostate_Cancer_Costs_Historical_and_Forecast_2003_2032_v4.csv', {
            download: true,
            header: true,
            complete: function(costResults) {
                // Process cost data
                costYears = [...new Set(costResults.data.map(row => parseInt(row.Year)).filter(y => y))];
                
                // Split data into historical and forecast
                historicalYears = costYears.filter(year => year >= 2014 && year <= 2022);
                forecastYears = costYears.filter(year => year >= 2023);
                
                // Create historical cost arrays
                const historicalData = costResults.data.filter(row => row.Type === "Historical" && parseInt(row.Year) >= 2014 && parseInt(row.Year) <= 2022);
                
                historicalAE = historicalYears.map(year => {
                    const entry = historicalData.find(row => parseInt(row.Year) === year && row.Cost_Type === "AE_Cost");
                    return entry ? parseFloat(entry.Cost) : null;
                });
                
                historicalIP = historicalYears.map(year => {
                    const entry = historicalData.find(row => parseInt(row.Year) === year && row.Cost_Type === "IP_Total");
                    return entry ? parseFloat(entry.Cost) : null;
                });
                
                historicalOP = historicalYears.map(year => {
                    const entry = historicalData.find(row => parseInt(row.Year) === year && row.Cost_Type === "OP_Total");
                    return entry ? parseFloat(entry.Cost) : null;
                });
                
                // Create forecast cost arrays
                const forecastData = costResults.data.filter(row => row.Type === "Forecast");
                
                forecastAE = forecastYears.map(year => {
                    const entry = forecastData.find(row => parseInt(row.Year) === year && row.Cost_Type === "AE_Cost");
                    return entry ? parseFloat(entry.Cost) : null;
                });
                
                forecastIP = forecastYears.map(year => {
                    const entry = forecastData.find(row => parseInt(row.Year) === year && row.Cost_Type === "IP_Total");
                    return entry ? parseFloat(entry.Cost) : null;
                });
                
                forecastOP = forecastYears.map(year => {
                    const entry = forecastData.find(row => parseInt(row.Year) === year && row.Cost_Type === "OP_Total");
                    return entry ? parseFloat(entry.Cost) : null;
                });
                
                // Create cost chart with actual data
                updateCostChart();
                
                // Now parse incidence data for the other charts
                Papa.parse('Male_Incidence_v2.csv', {
                    download: true,
                    header: false,
                    complete: function(incidenceResults) {
                        // Function to find a row by its first cell value (metric name)
                        function findIncidenceRowByMetric(metricName) {
                            return incidenceResults.data.find(row => row[0] === metricName);
                        }
                        
                        // Extract incidence case numbers
                        const inciTotalRow = findIncidenceRowByMetric("num_male_patient");
                        const inciLess65Row = findIncidenceRowByMetric("num_male_patient_less65"); // Changed from less60 to less65
                        const inciAge65to79Row = findIncidenceRowByMetric("num_male_patient_65to79"); // Changed from 60to74 to 65to79
                        const inciAge80plusRow = findIncidenceRowByMetric("num_male_patient_80plus"); // Changed from 75plus to 80plus
                        
                        // Extract incidence rates
                        const inciTotalRateRow = findIncidenceRowByMetric("age_standardized_inci_male");
                        const inciLess65RateRow = findIncidenceRowByMetric("age_standardized_inci_male_less65"); // Changed from less60 to less65
                        const inciAge65to79RateRow = findIncidenceRowByMetric("age_standardized_inci_male_65to79"); // Changed from 60to74 to 65to79
                        const inciAge80plusRateRow = findIncidenceRowByMetric("age_standardized_inci_male_80plus"); // Changed from 75plus to 80plus
                        
                        // Create arrays for incidence case numbers (skip first column which is the metric name)
                        num_inci = inciTotalRow ? inciTotalRow.slice(1).map(val => parseInt(val) || 0) : [];
                        num_less65_inci = inciLess65Row ? inciLess65Row.slice(1).map(val => parseInt(val) || 0) : []; // Changed from less60 to less65
                        num_65to79_inci = inciAge65to79Row ? inciAge65to79Row.slice(1).map(val => parseInt(val) || 0) : []; // Changed from 60to74 to 65to79
                        num_80plus_inci = inciAge80plusRow ? inciAge80plusRow.slice(1).map(val => parseInt(val) || 0) : []; // Changed from 75plus to 80plus
                        
                        // Create arrays for incidence rates
                        incidence_rate = inciTotalRateRow ? inciTotalRateRow.slice(1).map(val => parseFloat(val) || 0) : [];
                        less65_incidence_rate = inciLess65RateRow ? inciLess65RateRow.slice(1).map(val => parseFloat(val) || 0) : []; // Changed from less60 to less65
                        age65to79_incidence_rate = inciAge65to79RateRow ? inciAge65to79RateRow.slice(1).map(val => parseFloat(val) || 0) : []; // Changed from 60to74 to 65to79
                        plus80_incidence_rate = inciAge80plusRateRow ? inciAge80plusRateRow.slice(1).map(val => parseFloat(val) || 0) : []; // Changed from plus75 to plus80
                        
                        // Filter incidence data to start from 2014
                        filtered_num_inci = num_inci.slice(yearStartIndex);
                        filtered_num_less65_inci = num_less65_inci.slice(yearStartIndex); // Changed from less60 to less65
                        filtered_num_65to79_inci = num_65to79_inci.slice(yearStartIndex); // Changed from 60to74 to 65to79
                        filtered_num_80plus_inci = num_80plus_inci.slice(yearStartIndex); // Changed from 75plus to 80plus
                        
                        filtered_incidence_rate = incidence_rate.slice(yearStartIndex);
                        filtered_less65_incidence_rate = less65_incidence_rate.slice(yearStartIndex); // Changed from less60 to less65
                        filtered_age65to79_incidence_rate = age65to79_incidence_rate.slice(yearStartIndex); // Changed from 60to74 to 65to79
                        filtered_plus80_incidence_rate = plus80_incidence_rate.slice(yearStartIndex); // Changed from plus75 to plus80
                        
                        // Parse incidence forecast data
                        Papa.parse('Overall_Forecasts_2023_2032_inc_v2.csv', {
                            download: true,
                            header: true,
                            complete: function(inciForecastResults) {
                                // Group data by metric
                                const inciGroupedByMetric = {};
                                inciForecastResults.data.forEach(row => {
                                    if (row.Metric && row.year) {
                                        if (!inciGroupedByMetric[row.Metric]) {
                                            inciGroupedByMetric[row.Metric] = [];
                                        }
                                        inciGroupedByMetric[row.Metric].push(row);
                                    }
                                });
                                
                                // Sort data within each metric by year
                                Object.keys(inciGroupedByMetric).forEach(metric => {
                                    inciGroupedByMetric[metric].sort((a, b) => parseInt(a.year) - parseInt(b.year));
                                });
                                
                                // Extract forecast years (from any metric, they should all have the same years)
                                if (inciGroupedByMetric['Total_Cases'] && inciGroupedByMetric['Total_Cases'].length > 0) {
                                    inciForecastYears = inciGroupedByMetric['Total_Cases'].map(row => parseInt(row.year)).filter(y => y);
                                }
                                
                                // Extract forecast data for incidence total cases
                                if (inciGroupedByMetric['Total_Cases']) {
                                    num_inci_forecast = inciGroupedByMetric['Total_Cases'].map(row => parseFloat(row.rate_forecast) || 0);
                                    num_inci_lower = inciGroupedByMetric['Total_Cases'].map(row => parseFloat(row.lower_PI) || 0);
                                    num_inci_upper = inciGroupedByMetric['Total_Cases'].map(row => parseFloat(row.upper_PI) || 0);
                                }
                                
                                // Extract forecast data for incidence less65 cases - Changed from less60 to less65
                                if (inciGroupedByMetric['less65_Cases']) { // Changed from less60_Cases to less65_Cases
                                    less65_inci_forecast = inciGroupedByMetric['less65_Cases'].map(row => parseFloat(row.rate_forecast) || 0); // Changed from less60 to less65
                                    less65_inci_lower = inciGroupedByMetric['less65_Cases'].map(row => parseFloat(row.lower_PI) || 0); // Changed from less60 to less65
                                    less65_inci_upper = inciGroupedByMetric['less65_Cases'].map(row => parseFloat(row.upper_PI) || 0); // Changed from less60 to less65
                                }
                                
                                // Extract forecast data for incidence 65-79 cases - Changed from 60-74 to 65-79
                                if (inciGroupedByMetric['age65to79_Cases']) { // Changed from age60to74_Cases to age65to79_Cases
                                    age65to79_inci_forecast = inciGroupedByMetric['age65to79_Cases'].map(row => parseFloat(row.rate_forecast) || 0); // Changed from age60to74 to age65to79
                                    age65to79_inci_lower = inciGroupedByMetric['age65to79_Cases'].map(row => parseFloat(row.lower_PI) || 0); // Changed from age60to74 to age65to79
                                    age65to79_inci_upper = inciGroupedByMetric['age65to79_Cases'].map(row => parseFloat(row.upper_PI) || 0); // Changed from age60to74 to age65to79
                                }
                                
                                // Extract forecast data for incidence 80+ cases - Changed from 75+ to 80+
                                if (inciGroupedByMetric['plus80_Cases']) { // Changed from plus75_Cases to plus80_Cases
                                    plus80_inci_forecast = inciGroupedByMetric['plus80_Cases'].map(row => parseFloat(row.rate_forecast) || 0); // Changed from plus75 to plus80
                                    plus80_inci_lower = inciGroupedByMetric['plus80_Cases'].map(row => parseFloat(row.lower_PI) || 0); // Changed from plus75 to plus80
                                    plus80_inci_upper = inciGroupedByMetric['plus80_Cases'].map(row => parseFloat(row.upper_PI) || 0); // Changed from plus75 to plus80
                                }
                                
                                // Extract forecast data for incidence total rate
                                if (inciGroupedByMetric['Age_Standardized']) {
                                    incidence_rate_forecast = inciGroupedByMetric['Age_Standardized'].map(row => parseFloat(row.rate_forecast) || 0);
                                    incidence_rate_lower = inciGroupedByMetric['Age_Standardized'].map(row => parseFloat(row.lower_PI) || 0);
                                    incidence_rate_upper = inciGroupedByMetric['Age_Standardized'].map(row => parseFloat(row.upper_PI) || 0);
                                }
                                
                                // Extract forecast data for incidence less65 rate - Changed from less60 to less65
                                if (inciGroupedByMetric['less65_Age_Standardized']) { // Changed from less60_Age_Standardized to less65_Age_Standardized
                                    less65_incidence_rate_forecast = inciGroupedByMetric['less65_Age_Standardized'].map(row => parseFloat(row.rate_forecast) || 0); // Changed from less60 to less65
                                    less65_incidence_rate_lower = inciGroupedByMetric['less65_Age_Standardized'].map(row => parseFloat(row.lower_PI) || 0); // Changed from less60 to less65
                                    less65_incidence_rate_upper = inciGroupedByMetric['less65_Age_Standardized'].map(row => parseFloat(row.upper_PI) || 0); // Changed from less60 to less65
                                }
                                
                                // Extract forecast data for incidence 65-79 rate - Changed from 60-74 to 65-79
                                if (inciGroupedByMetric['age65to79_Age_Standardized']) { // Changed from age60to74_Age_Standardized to age65to79_Age_Standardized
                                    age65to79_incidence_rate_forecast = inciGroupedByMetric['age65to79_Age_Standardized'].map(row => parseFloat(row.rate_forecast) || 0); // Changed from age60to74 to age65to79
                                    age65to79_incidence_rate_lower = inciGroupedByMetric['age65to79_Age_Standardized'].map(row => parseFloat(row.lower_PI) || 0); // Changed from age60to74 to age65to79
                                    age65to79_incidence_rate_upper = inciGroupedByMetric['age65to79_Age_Standardized'].map(row => parseFloat(row.upper_PI) || 0); // Changed from age60to74 to age65to79
                                }
                                
                                // Extract forecast data for incidence 80+ rate - Changed from 75+ to 80+
                                if (inciGroupedByMetric['plus80_Age_Standardized']) { // Changed from plus75_Age_Standardized to plus80_Age_Standardized
                                    plus80_incidence_rate_forecast = inciGroupedByMetric['plus80_Age_Standardized'].map(row => parseFloat(row.rate_forecast) || 0); // Changed from plus75 to plus80
                                    plus80_incidence_rate_lower = inciGroupedByMetric['plus80_Age_Standardized'].map(row => parseFloat(row.lower_PI) || 0); // Changed from plus75 to plus80
                                    plus80_incidence_rate_upper = inciGroupedByMetric['plus80_Age_Standardized'].map(row => parseFloat(row.upper_PI) || 0); // Changed from plus75 to plus80
                                }
                                
                                // Now parse prevalence forecast data
                                Papa.parse('Overall_Forecasts_2023_2032_prev_v2.csv', {
                                    download: true,
                                    header: true,
                                    complete: function(prevForecastResults) {
                                        // Group data by metric
                                        const prevGroupedByMetric = {};
                                        prevForecastResults.data.forEach(row => {
                                            if (row.Metric && row.year) {
                                                if (!prevGroupedByMetric[row.Metric]) {
                                                    prevGroupedByMetric[row.Metric] = [];
                                                }
                                                prevGroupedByMetric[row.Metric].push(row);
                                            }
                                        });
                                        
                                        // Sort data within each metric by year
                                        Object.keys(prevGroupedByMetric).forEach(metric => {
                                            prevGroupedByMetric[metric].sort((a, b) => parseInt(a.year) - parseInt(b.year));
                                        });
                                        
                                        // Extract prevalence forecast years
                                        if (prevGroupedByMetric['Total_Cases'] && prevGroupedByMetric['Total_Cases'].length > 0) {
                                            prevForecastYears = prevGroupedByMetric['Total_Cases'].map(row => parseInt(row.year)).filter(y => y);
                                        }
                                        
                                        // Extract forecast data for prevalence total cases
                                        if (prevGroupedByMetric['Total_Cases']) {
                                            totalPrevForecast = prevGroupedByMetric['Total_Cases'].map(row => parseFloat(row.rate_forecast) || 0);
                                            totalPrevLower = prevGroupedByMetric['Total_Cases'].map(row => parseFloat(row.lower_PI) || 0);
                                            totalPrevUpper = prevGroupedByMetric['Total_Cases'].map(row => parseFloat(row.upper_PI) || 0);
                                        }
                                        
                                        // Extract forecast data for prevalence less65 cases - Changed from less60 to less65
                                        if (prevGroupedByMetric['less65_Cases']) { // Changed from less60_Cases to less65_Cases
                                            less65PrevForecast = prevGroupedByMetric['less65_Cases'].map(row => parseFloat(row.rate_forecast) || 0); // Changed from less60 to less65
                                            less65PrevLower = prevGroupedByMetric['less65_Cases'].map(row => parseFloat(row.lower_PI) || 0); // Changed from less60 to less65
                                            less65PrevUpper = prevGroupedByMetric['less65_Cases'].map(row => parseFloat(row.upper_PI) || 0); // Changed from less60 to less65
                                        }
                                        
                                        // Extract forecast data for prevalence 65-79 cases - Changed from 60-74 to 65-79
                                        if (prevGroupedByMetric['age65to79_Cases']) { // Changed from age60to74_Cases to age65to79_Cases
                                            age65to79PrevForecast = prevGroupedByMetric['age65to79_Cases'].map(row => parseFloat(row.rate_forecast) || 0); // Changed from age60to74 to age65to79
                                            age65to79PrevLower = prevGroupedByMetric['age65to79_Cases'].map(row => parseFloat(row.lower_PI) || 0); // Changed from age60to74 to age65to79
                                            age65to79PrevUpper = prevGroupedByMetric['age65to79_Cases'].map(row => parseFloat(row.upper_PI) || 0); // Changed from age60to74 to age65to79
                                        }
                                        
                                        // Extract forecast data for prevalence 80+ cases - Changed from 75+ to 80+
                                        if (prevGroupedByMetric['plus80_Cases']) { // Changed from plus75_Cases to plus80_Cases
                                            plus80PrevForecast = prevGroupedByMetric['plus80_Cases'].map(row => parseFloat(row.rate_forecast) || 0); // Changed from plus75 to plus80
                                            plus80PrevLower = prevGroupedByMetric['plus80_Cases'].map(row => parseFloat(row.lower_PI) || 0); // Changed from plus75 to plus80
                                            plus80PrevUpper = prevGroupedByMetric['plus80_Cases'].map(row => parseFloat(row.upper_PI) || 0); // Changed from plus75 to plus80
                                        }
                                        
                                        // Extract forecast data for prevalence total rate
                                        if (prevGroupedByMetric['Age_Standardized']) {
                                            totalPrevRateForecast = prevGroupedByMetric['Age_Standardized'].map(row => parseFloat(row.rate_forecast) || 0);
                                            totalPrevRateLower = prevGroupedByMetric['Age_Standardized'].map(row => parseFloat(row.lower_PI) || 0);
                                            totalPrevRateUpper = prevGroupedByMetric['Age_Standardized'].map(row => parseFloat(row.upper_PI) || 0);
                                        }
                                        
                                        // Extract forecast data for prevalence less65 rate - Changed from less60 to less65
                                        if (prevGroupedByMetric['less65_Age_Standardized']) { // Changed from less60_Age_Standardized to less65_Age_Standardized
                                            less65PrevRateForecast = prevGroupedByMetric['less65_Age_Standardized'].map(row => parseFloat(row.rate_forecast) || 0); // Changed from less60 to less65
                                            less65PrevRateLower = prevGroupedByMetric['less65_Age_Standardized'].map(row => parseFloat(row.lower_PI) || 0); // Changed from less60 to less65
                                            less65PrevRateUpper = prevGroupedByMetric['less65_Age_Standardized'].map(row => parseFloat(row.upper_PI) || 0); // Changed from less60 to less65
                                        }
                                        
                                        // Extract forecast data for prevalence 65-79 rate - Changed from 60-74 to 65-79
                                        if (prevGroupedByMetric['age65to79_Age_Standardized']) { // Changed from age60to74_Age_Standardized to age65to79_Age_Standardized
                                            age65to79PrevRateForecast = prevGroupedByMetric['age65to79_Age_Standardized'].map(row => parseFloat(row.rate_forecast) || 0); // Changed from age60to74 to age65to79
                                            age65to79PrevRateLower = prevGroupedByMetric['age65to79_Age_Standardized'].map(row => parseFloat(row.lower_PI) || 0); // Changed from age60to74 to age65to79
                                            age65to79PrevRateUpper = prevGroupedByMetric['age65to79_Age_Standardized'].map(row => parseFloat(row.upper_PI) || 0); // Changed from age60to74 to age65to79
                                        }
                                        
                                        // Extract forecast data for prevalence 80+ rate - Changed from 75+ to 80+
                                        if (prevGroupedByMetric['plus80_Age_Standardized']) { // Changed from plus75_Age_Standardized to plus80_Age_Standardized
                                            plus80PrevRateForecast = prevGroupedByMetric['plus80_Age_Standardized'].map(row => parseFloat(row.rate_forecast) || 0); // Changed from plus75 to plus80
                                            plus80PrevRateLower = prevGroupedByMetric['plus80_Age_Standardized'].map(row => parseFloat(row.lower_PI) || 0); // Changed from plus75 to plus80
                                            plus80PrevRateUpper = prevGroupedByMetric['plus80_Age_Standardized'].map(row => parseFloat(row.upper_PI) || 0); // Changed from plus75 to plus80
                                        }
                                        
                                        // Update incidence charts
                                        updateIncidenceCharts();
                                        
                                        // Update prevalence charts with actual data
                                        updatePrevalenceCharts();
                                        
                                        // Load KM curve data
                                        loadKMCurve();
                                        
                                        // Load treated patients chart data
                                        loadTreatedPatientsChart();
                                    },
                                    error: function(error) {
                                        console.error("Error loading prevalence forecast data:", error);
                                    }
                                });
                            },
                            error: function(error) {
                                console.error("Error loading incidence forecast data:", error);
                            }
                        });
                    },
                    error: function(error) {
                        console.error("Error loading incidence data:", error);
                    }
                });
            },
            error: function(error) {
                console.error("Error loading cost data:", error);
            }
        });
    },
    error: function(error) {
        console.error("Error loading prevalence data:", error);
    }
});

function loadKMCurve() {
    Papa.parse('KM_curve_data_all_age_groups.csv', {
        download: true,
        header: true,
        complete: function(results) {
            // Filter out any invalid rows and map to clean data format
            const cleanData = results.data
                .filter(d => d.AgeGroup && d.time !== undefined && d.survival !== undefined)
                .map(d => ({
                    time: +d.year_from_diagnosis,
                    survival: +d.survival,
                    ageGroup: d.AgeGroup
                }));
                
            // Extract unique age groups
            const ageGroups = [...new Set(cleanData.map(d => d.ageGroup))];
            console.log("Age groups found:", ageGroups);
            
            // Group data by age category
            const dataByGroup = {};
            ageGroups.forEach(group => {
                dataByGroup[group] = cleanData
                    .filter(d => d.ageGroup === group)
                    .sort((a, b) => a.time - b.time); // Sort by time
            });
            
            // Set up SVG canvas
            const svg = d3.select("#chart");
            const margin = { top: 20, right: 150, bottom: 50, left: 70 };
            const width = +svg.attr("width") - margin.left - margin.right;
            const height = +svg.attr("height") - margin.top - margin.bottom;
            svg.selectAll("*").remove(); // Clear existing chart
            const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            // Find max time across all groups
            let maxTime = 0;
            Object.values(dataByGroup).forEach(groupData => {
                if (groupData.length > 0) {
                    maxTime = Math.max(maxTime, Math.max(...groupData.map(d => d.time)));
                }
            });
            
            // Round up to nearest year for x-axis
            maxTime = Math.ceil(maxTime);
            
            // Define scales
            const x = d3.scaleLinear()
                .domain([0, maxTime])
                .range([0, width]);

            // Find min survival value across all groups
            let minSurvival = 0.6; // Default
            Object.values(dataByGroup).forEach(groupData => {
                if (groupData.length > 0) {
                    const groupMin = Math.min(...groupData.map(d => d.survival));
                    minSurvival = Math.min(minSurvival, groupMin);
                }
            });
            
            // Add some padding to y-axis
            minSurvival = Math.max(0, minSurvival * 0.95);
            
            const y = d3.scaleLinear()
                .domain([0, 1])
                .range([height, 0]);

            // Add x-axis
            const xAxis = g.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x)
                    .ticks(Math.min(10, maxTime + 1))
                    .tickFormat(d => Math.round(d)) // Round to whole years
                );

            xAxis.selectAll("text")
                .style("font-size", "12px")
                .style("font-family", "Arial, sans-serif")
                .style("fill", "#808080");

            xAxis.selectAll("path, line")
                .style("stroke", "#808080"); // Gray axis lines
            
            

            // Add y-axis
            const yAxis = g.append("g")
                .call(d3.axisLeft(y)
                    .ticks(10)
                    .tickFormat(d3.format(".0%")) // Display as percentage
                );

            yAxis.selectAll("text")
                .style("font-size", "12px")
                .style("font-family", "Arial, sans-serif")
                .style("fill", "#808080");
            
            yAxis.selectAll("path, line")
                .style("stroke", "#808080"); // Gray axis lines
            
            // Add axis labels
            g.append("text")
                .attr("transform", `translate(${width / 2}, ${height + margin.bottom - 10})`)
                .style("text-anchor", "middle")
                .text("Time Since Diagnosis (Years)");

            g.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 0 - margin.left + 10)
                .attr("x", 0 - height / 2)
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .text("Survival Probability (%)");

            // Line generator
            const line = d3.line()
                .x(d => x(d.time))
                .y(d => y(d.survival));

            // Define colors for different age groups
            const colors = {
                "Total": "#fb8500", // Overall
                "<65": "#023047",   // Changed from "<60" to "<65"
                "65-79": "#219ebc", // Changed from "60-74" to "65-79"
                "80": "#8ecae6"    // Changed from "75" to "80"
            };

            // Draw curves for each group
            Object.keys(dataByGroup).forEach(group => {
                if (dataByGroup[group].length > 0) {
                    g.append("path")
                        .datum(dataByGroup[group])
                        .attr("fill", "none")
                        .attr("stroke", colors[group] || "#999")
                        .attr("stroke-width", 2.5)
                        .attr("d", line);
                }
            });

            // Add dots at year marks
            const yearMarks = [];
            for (let i = 0; i <= maxTime; i++) {
                yearMarks.push(i);
            }

            function addDots(data, color, label) {
                yearMarks.forEach(targetYear => {
                    if (data.length === 0) return;
                    
                    // Find closest point to each year mark
                    const closest = data.reduce((prev, curr) => {
                        if (!prev) return curr;
                        return Math.abs(curr.time - targetYear) < Math.abs(prev.time - targetYear) ? curr : prev;
                    }, null);
                    
                    // Only add dots if we found a point and it's reasonably close to year mark
                    if (closest && Math.abs(closest.time - targetYear) < 0.2) {
                        g.append("circle")
                            .attr("cx", x(closest.time))
                            .attr("cy", y(closest.survival))
                            .attr("r", 5)
                            .attr("fill", color)
                            .on("mouseover", function (event) {
                                tooltip
                                    .style("opacity", 1)
                                    .html(`${label}<br>Year: ${Math.round(closest.time)}<br>Survival: ${(closest.survival * 100).toFixed(2)}%`)
                                    .style("left", (event.pageX + 10) + "px")
                                    .style("top", (event.pageY - 20) + "px");
                            })
                            .on("mouseout", function () {
                                tooltip.style("opacity", 0);
                            });
                    }
                });
            }

            // Add dots for each group
            Object.keys(dataByGroup).forEach(group => {
                if (dataByGroup[group].length > 0) {
                    addDots(dataByGroup[group], colors[group] || "#999", group);
                }
            });

            // Create tooltip
            const tooltip = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("position", "absolute")
                .style("background", "rgba(0, 0, 0, 0.7)")
                .style("color", "#fff")
                .style("padding", "5px 10px")
                .style("border-radius", "5px")
                .style("font-size", "12px")
                .style("pointer-events", "none")
                .style("opacity", 0);

            // Add legend
            const legend = svg.append("g")
                .attr("transform", `translate(${width + margin.right-630}, 230)`);

            // Add legend entries for groups that have data
            Object.keys(dataByGroup)
                .filter(group => dataByGroup[group].length > 0)
                .forEach((group, index) => {
                    legend.append("circle")
                        .attr("cx", 7.5)
                        .attr("cy", index * 25 + 7.5)
                        .attr("r", 7.5)
                        .attr("fill", colors[group] || "#999");

                    legend.append("text")
                        .attr("x", 20)
                        .attr("y", index * 25 + 12)
                        .text(group)
                        .style("font-size", "16px")
                        .attr("alignment-baseline", "middle");
                });
        },
        error: function(error) {
            console.error("Error loading KM curve data:", error);
        }
    });
}

function loadTreatedPatientsChart() {
    Papa.parse('PC Unmet Need Plot Data.csv', {
        download: true,
        header: true,
        complete: function(results) {
            // Filter data to years between 2014 and 2022
            const filteredData = results.data.filter(row => {
                const year = parseInt(row.year);
                return year >= 2014 && year <= 2022;
            });
            
            // Get unique years and patient groups - sort years numerically
            const years = [...new Set(filteredData.map(row => row.year))].sort((a, b) => parseInt(a) - parseInt(b));
            const groups = [...new Set(filteredData.map(row => row.grp))];
            
            // Collect data for all years and groups
            const data = {};
            groups.forEach(group => {
                data[group] = {};
                years.forEach(year => {
                    data[group][year] = {
                        treat_90: 0,
                        treat_180: 0,
                        diagnosis: 0,
                        prop_180: 0
                    };
                    
                    // Find and set values for each patient type
                    ['treat_90', 'treat_180', 'diagnosis', 'prop_180'].forEach(patientType => {
                        const entry = filteredData.find(row => 
                            row.grp === group && 
                            row.year === year && 
                            row.patient === patientType
                        );
                        
                        if (entry) {
                            data[group][year][patientType] = parseFloat(entry.number);
                        }
                    });
                });
            });
            
            // Create datasets for each patient type
            const patientTypes = [
                { id: 'treat_90', label: 'Treated within 30 days', color: 'steelblue' },
                { id: 'treat_180', label: 'Treated within 30-180 days', color: 'forestgreen' },
                { id: 'diagnosis', label: 'Not treated in 180 days', color: 'red' }
            ];

            // Function to create a chart for a specific group
            function createChart(group, canvasId, title) {
                // Clean up existing chart
                const existingChart = Chart.getChart(canvasId);
                if (existingChart) {
                    existingChart.destroy();
                }

                const datasets = patientTypes.map(type => ({
                    label: type.label,
                    data: years.map(year => data[group][year][type.id]),
                    backgroundColor: type.color,
                    datalabels: {
                        display: type.id === 'diagnosis', // Only show labels for 'not treated' category
                        color: 'white',
                        font: {
                            weight: 'bold',
                            size: 16
                        },
                        formatter: function(value, context) {
                            const year = years[context.dataIndex];
                            const propValue = data[group][year].prop_180;
                            return propValue ? (propValue * 100).toFixed(1) + '%' : '';
                        }
                    }
                }));

                const ctx = document.getElementById(canvasId).getContext('2d');
                return new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: years,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        barPercentage: 0.99,
                        categoryPercentage: 0.9,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    boxWidth: 20,
                                    padding: 10,
                                    font: {
                                        size: 16,              // Change this value to adjust font size
                                        family: 'Arial',       // Optional: specify font family
                                        weight: 'normal'       // Optional: specify font weight
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    title: function(tooltipItems) {
                                        const item = tooltipItems[0];
                                        return `${item.label} - ${title}`;
                                    },
                                    label: function(context) {
                                        return `${context.dataset.label}: ${context.raw}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                stacked: true,
                                title: {
                                    display: true,
                                    text: 'Year',
                                font: {
                                    size: 16,           // Change font size here
                                    family: 'Arial'     // Change font family here
                                },
                                color: '#333333'        // Change color here
                                }
                            },
                            y: {
                                stacked: true,
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Number of Patients',
                                    font: {
                                        size: 16,           // Change font size here
                                        family: 'Arial'     // Change font family here
                                    },
                                    color: '#333333'        // Change color here
                                }
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            }

            // Create separate charts for CRPC and Metastatic
            crpcChart = createChart('CR', 'crpcChart', 'CRPC Patients');
            metastaticChart = createChart('M', 'metastaticChart', 'Metastatic Patients');

            // Show initial chart (CRPC by default)
            toggleUnmetNeeds('crpc', null);

                // Add note about proportion
            const noteContainer = document.getElementById('cohortData');
            let existingNote = noteContainer.querySelector('.proportion-note');
            if (!existingNote) {
                const note = document.createElement('div');
                note.className = 'proportion-note';
                note.id = 'proportion-note'; // Add an ID for easy access
                note.textContent = '% Proportion of CRPC patients not treated by NHA/docetaxel in 180 Days in the yearly prostate cancer cohort';
                note.style.textAlign = 'center';
                note.style.color = '#777';
                note.style.fontSize = '16px';
                note.style.marginTop = '10px';
                note.style.fontWeight = 'normal';
                noteContainer.appendChild(note);
            }
        },
        error: function(error) {
            console.error("Error loading CSV:", error);
        }
    });
}

function zoomSankey() {
    const sankeyDiagram = document.getElementById('sankeyDiagram');
    if (sankeyDiagram) {
        sankeyDiagram.style.transform = 'scale(1.5)';
        sankeyDiagram.style.transformOrigin = 'center';
    }
}

function resetSankey() {
    const sankeyDiagram = document.getElementById('sankeyDiagram');
    if (sankeyDiagram) {
        sankeyDiagram.style.transform = 'scale(1)';
    }
}
</script>
</body>
</html>